<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Life Leveling - Complete Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 80px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 2px solid rgba(106, 90, 205, 0.3);
        }

        h1 {
            color: #ffd700;
            font-size: 28px;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .player-card {
            background: linear-gradient(135deg, rgba(106, 90, 205, 0.2), rgba(72, 61, 139, 0.2));
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid rgba(138, 43, 226, 0.5);
            box-shadow: 0 0 20px rgba(138, 43, 226, 0.3);
        }

        .player-name {
            font-size: 24px;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 10px;
        }

        .rank {
            display: inline-block;
            padding: 5px 15px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 15px;
            margin-right: 10px;
        }

        .rank.S { background: linear-gradient(135deg, #ffd700, #ffed4e); color: #000; }
        .rank.A { background: linear-gradient(135deg, #ff6b6b, #ee5a6f); }
        .rank.B { background: linear-gradient(135deg, #4ecdc4, #44a08d); }
        .rank.C { background: linear-gradient(135deg, #95e1d3, #76c7c0); }
        .rank.D { background: linear-gradient(135deg, #a8dadc, #457b9d); }
        .rank.E { background: linear-gradient(135deg, #6c757d, #495057); }
        .rank.NATIONAL { background: linear-gradient(135deg, #ff00ff, #8b00ff); color: #fff; animation: pulse 2s infinite; }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 5px rgba(255, 0, 255, 0.5); }
            50% { box-shadow: 0 0 20px rgba(255, 0, 255, 1); }
        }

        .job-class {
            display: inline-block;
            padding: 5px 15px;
            background: rgba(138, 43, 226, 0.3);
            border-radius: 20px;
            font-size: 12px;
            border: 1px solid rgba(138, 43, 226, 0.5);
        }

        .level {
            font-size: 20px;
            margin-bottom: 10px;
        }

        .stat-bar {
            margin: 10px 0;
        }

        .stat-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #6a5acd, #8a2be2);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .hp-bar .progress-fill { background: linear-gradient(90deg, #ff6b6b, #ee5a6f); }
        .mp-bar .progress-fill { background: linear-gradient(90deg, #4ecdc4, #44a08d); }

        .hp-warning { background: linear-gradient(90deg, #ff9500, #ff6b00) !important; animation: blink 1s infinite; }
        .hp-critical { background: linear-gradient(90deg, #ff0000, #cc0000) !important; animation: blink 0.5s infinite; }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .stat-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .stat-name {
            font-size: 12px;
            color: #bbb;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #ffd700;
        }

        .stat-exp-bar {
            width: 100%;
            height: 8px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .stat-exp-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffd700, #ffed4e);
            transition: width 0.3s ease;
        }

        .stat-exp-label {
            font-size: 10px;
            color: #999;
            margin-top: 3px;
            text-align: center;
        }

        .stat-points {
            background: rgba(255, 215, 0, 0.2);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            margin-top: 15px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .stat-exp-bar {
            width: 100%;
            height: 8px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .stat-exp-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffd700, #ffed4e);
            transition: width 0.3s ease;
        }

        .stat-exp-label {
            font-size: 10px;
            color: #999;
            margin-top: 3px;
            text-align: center;
        }

        .section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid rgba(106, 90, 205, 0.3);
        }

        .section-title {
            font-size: 20px;
            color: #ffd700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quest-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #6a5acd;
            transition: all 0.3s;
        }

        .quest-item:hover {
            background: rgba(0, 0, 0, 0.5);
            transform: translateX(5px);
        }

        .quest-item.completed {
            opacity: 0.6;
            border-left-color: #4ecdc4;
        }

        .quest-item.emergency {
            border-left: 4px solid #ff0000;
            background: linear-gradient(90deg, rgba(255, 0, 0, 0.1), rgba(0, 0, 0, 0.3));
            animation: emergencyPulse 2s infinite;
        }

        .quest-item.boss {
            border-left: 4px solid #8b00ff;
            background: linear-gradient(90deg, rgba(139, 0, 255, 0.1), rgba(0, 0, 0, 0.3));
        }

        @keyframes emergencyPulse {
            0%, 100% { box-shadow: 0 0 10px rgba(255, 0, 0, 0.3); }
            50% { box-shadow: 0 0 20px rgba(255, 0, 0, 0.8); }
        }

        .quest-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .quest-title {
            font-weight: bold;
            font-size: 16px;
        }

        .quest-reward {
            background: rgba(255, 215, 0, 0.2);
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 12px;
            color: #ffd700;
        }

        .quest-description {
            font-size: 14px;
            color: #bbb;
            margin-bottom: 10px;
        }

        .quest-timer {
            font-size: 12px;
            color: #ff6b6b;
            margin-bottom: 10px;
        }

        .complete-btn {
            background: linear-gradient(135deg, #6a5acd, #8a2be2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            transition: all 0.3s;
        }

        .complete-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(138, 43, 226, 0.4);
        }

        .complete-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #6a5acd, #8a2be2);
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
            max-width: 300px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.emergency {
            background: linear-gradient(135deg, #ff0000, #cc0000);
            animation: shake 0.5s infinite;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            25% { transform: translateX(5px) rotate(2deg); }
            75% { transform: translateX(-5px) rotate(-2deg); }
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .inventory-slot {
            aspect-ratio: 1;
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid rgba(106, 90, 205, 0.3);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .inventory-slot:hover {
            border-color: rgba(138, 43, 226, 0.8);
            background: rgba(138, 43, 226, 0.2);
        }

        .inventory-slot.has-effect {
            border-color: #ffd700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .item-icon {
            font-size: 30px;
            margin-bottom: 5px;
        }

        .item-count {
            font-size: 12px;
            color: #ffd700;
        }

        .item-effect {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 10px;
            background: rgba(255, 215, 0, 0.3);
            padding: 2px 5px;
            border-radius: 5px;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(26, 26, 46, 0.95);
            border-top: 2px solid rgba(106, 90, 205, 0.3);
            display: flex;
            justify-content: space-around;
            padding: 15px 0;
            backdrop-filter: blur(10px);
        }

        .nav-btn {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            transition: all 0.3s;
        }

        .nav-btn.active {
            color: #ffd700;
        }

        .nav-icon {
            font-size: 24px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .penalty-warning {
            background: rgba(255, 107, 107, 0.2);
            border: 2px solid #ff6b6b;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
        }

        .reset-btn {
            background: rgba(255, 107, 107, 0.3);
            border: 1px solid #ff6b6b;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 15px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            width: 100%;
            border: 2px solid rgba(106, 90, 205, 0.5);
            max-height: 80vh;
            overflow-y: auto;
        }

        .shadow-army-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .shadow-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #8a2be2;
        }

        .shadow-item .shadow-name {
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 5px;
        }

        .shadow-item .shadow-streak {
            font-size: 12px;
            color: #4ecdc4;
        }

        .shadow-item .shadow-bonus {
            font-size: 12px;
            color: #aaa;
            margin-top: 5px;
        }

        .achievement-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .achievement-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid rgba(106, 90, 205, 0.3);
        }

        .achievement-item.unlocked {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.1);
        }

        .achievement-icon {
            font-size: 30px;
            margin-bottom: 5px;
        }

        .achievement-title {
            font-size: 12px;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 5px;
        }

        .achievement-desc {
            font-size: 10px;
            color: #999;
        }

        .skill-tree {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .skill-branch {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
        }

        .skill-branch-title {
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 10px;
        }

        .skill-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .skill-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
            border-left: 3px solid #6a5acd;
            cursor: pointer;
            transition: all 0.3s;
        }

        .skill-item:hover {
            background: rgba(106, 90, 205, 0.2);
        }

        .skill-item.unlocked {
            border-left-color: #4ecdc4;
            background: rgba(76, 205, 196, 0.1);
        }

        .skill-item.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .skill-name {
            font-weight: bold;
            font-size: 14px;
        }

        .skill-desc {
            font-size: 12px;
            color: #bbb;
            margin-top: 5px;
        }

        .skill-cost {
            font-size: 11px;
            color: #ffd700;
            margin-top: 5px;
        }

        .radar-chart-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }

        .death-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            z-index: 9999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #ff0000;
        }

        .death-screen.active {
            display: flex;
        }

        .death-title {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 0 0 20px #ff0000;
            animation: deathPulse 2s infinite;
        }

        @keyframes deathPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .death-timer {
            font-size: 36px;
            margin-bottom: 20px;
        }

        .death-message {
            font-size: 18px;
            text-align: center;
            color: #999;
            max-width: 400px;
            line-height: 1.6;
        }

        .crafting-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .recipe-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid rgba(106, 90, 205, 0.3);
        }

        .recipe-item.unlocked {
            border-color: #4ecdc4;
        }

        .recipe-name {
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 5px;
        }

        .recipe-materials {
            font-size: 12px;
            color: #bbb;
            margin-bottom: 10px;
        }

        .craft-btn {
            background: linear-gradient(135deg, #6a5acd, #8a2be2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            width: 100%;
        }

        .craft-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status-effects {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        .status-effect {
            background: rgba(76, 205, 196, 0.2);
            border: 1px solid #4ecdc4;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 11px;
        }

        .status-effect.buff {
            background: rgba(76, 205, 196, 0.2);
            border-color: #4ecdc4;
        }

        .status-effect.debuff {
            background: rgba(255, 107, 107, 0.2);
            border-color: #ff6b6b;
        }

        /* Welcome Screen Styles */
        #welcomeScreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #0a0a1e 0%, #16213e 100%);
            z-index: 10000;
            overflow-y: auto;
            padding: 20px;
        }

        .welcome-container {
            max-width: 600px;
            margin: 0 auto;
            padding-bottom: 40px;
        }

        .welcome-title {
            text-align: center;
            font-size: 32px;
            color: #ffd700;
            margin: 40px 0 30px;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .quote-box {
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
            text-align: center;
        }

        .quote-text {
            font-size: 18px;
            line-height: 1.6;
            color: #ffd700;
            font-style: italic;
            margin-bottom: 15px;
        }

        .quote-author {
            font-size: 14px;
            color: #bbb;
        }

        .tutorial-section {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(106, 90, 205, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .tutorial-title {
            font-size: 24px;
            color: #ffd700;
            margin-bottom: 20px;
            text-align: center;
        }

        .tutorial-item {
            margin: 15px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border-left: 4px solid #6a5acd;
        }

        .tutorial-item-title {
            font-size: 16px;
            font-weight: bold;
            color: #4ecdc4;
            margin-bottom: 8px;
        }

        .tutorial-item-desc {
            font-size: 14px;
            color: #bbb;
            line-height: 1.5;
        }

        .continue-btn {
            display: block;
            width: 100%;
            max-width: 400px;
            margin: 40px auto;
            padding: 20px;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #000;
            border: none;
            border-radius: 15px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .continue-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.6);
        }

        .daily-quote {
            font-style: italic;
            color: #ffd700;
            font-size: 14px;
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 8px;
        }

        .streak-display {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.2), rgba(255, 0, 0, 0.2));
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
            border: 2px solid rgba(255, 107, 107, 0.5);
        }

        .streak-number {
            font-size: 32px;
            font-weight: bold;
            color: #ffd700;
            margin: 10px 0;
        }

        .streak-bonus {
            font-size: 12px;
            color: #4ecdc4;
        }

        .comparison-box {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            border: 2px solid rgba(255, 215, 0, 0.3);
        }

        .comparison-title {
            font-size: 18px;
            color: #ffd700;
            text-align: center;
            margin-bottom: 15px;
        }

        .comparison-row {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
        }

        .comparison-label {
            color: #bbb;
        }

        .comparison-values {
            display: flex;
            gap: 20px;
        }

        .comparison-old {
            color: #999;
        }

        .comparison-new {
            font-weight: bold;
        }

        .comparison-new.winning {
            color: #4ecdc4;
        }

        .comparison-new.losing {
            color: #ff6b6b;
        }

        /* ====== DAILY LOGIN BONUS ====== */
        .login-bonus-card {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 140, 0, 0.15));
            border: 2px solid rgba(255, 215, 0, 0.4);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        .login-days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
            margin: 15px 0;
        }
        .login-day {
            background: rgba(0,0,0,0.3);
            border: 2px solid rgba(106, 90, 205, 0.3);
            border-radius: 8px;
            padding: 8px 4px;
            font-size: 11px;
            text-align: center;
            transition: all 0.3s;
        }
        .login-day.claimed { background: rgba(255, 215, 0, 0.2); border-color: #ffd700; }
        .login-day.today-day { background: rgba(138, 43, 226, 0.3); border-color: #8a2be2; animation: loginPulse 2s infinite; }
        @keyframes loginPulse {
            0%, 100% { box-shadow: 0 0 5px rgba(138, 43, 226, 0.5); }
            50% { box-shadow: 0 0 15px rgba(138, 43, 226, 1); }
        }
        .login-day.future-day { opacity: 0.4; }
        .login-day .day-reward { font-size: 10px; color: #ffd700; margin-top: 3px; }

        /* ====== BOSS PHASES ====== */
        .boss-phases { display: flex; gap: 8px; margin: 10px 0; }
        .boss-phase {
            flex: 1; padding: 8px; border-radius: 8px; text-align: center; font-size: 12px;
            border: 1px solid rgba(139, 0, 255, 0.4); background: rgba(0,0,0,0.3); transition: all 0.3s;
        }
        .boss-phase.unlocked { background: rgba(139, 0, 255, 0.3); border-color: #8b00ff; }
        .boss-phase.completed { background: rgba(255, 215, 0, 0.2); border-color: #ffd700; }
        .boss-hp-bar {
            width: 100%; height: 25px; background: rgba(0,0,0,0.5); border-radius: 10px;
            overflow: hidden; border: 1px solid rgba(139,0,255,0.5); margin: 10px 0; position: relative;
        }
        .boss-hp-fill {
            height: 100%; background: linear-gradient(90deg, #8b00ff, #ff00ff);
            transition: width 0.5s ease; display: flex; align-items: center;
            justify-content: center; font-size: 12px; font-weight: bold;
        }

        /* ====== THEMES ====== */
        body.theme-purple { background: linear-gradient(135deg, #1a0a2e 0%, #0d0520 100%); }
        body.theme-shadow { background: linear-gradient(135deg, #050505 0%, #0a0a0a 100%); }
        body.theme-gold { background: linear-gradient(135deg, #1a1500 0%, #0d0a00 100%); }
        .theme-selector { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 10px 0; }
        .theme-btn {
            padding: 10px; border-radius: 8px; border: 2px solid rgba(106,90,205,0.3);
            cursor: pointer; font-size: 12px; transition: all 0.3s; background: rgba(0,0,0,0.3); color: white;
        }
        .theme-btn.active { border-color: #ffd700; }
        .unlock-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px; }
        .unlock-item {
            background: rgba(0,0,0,0.3); border-radius: 10px; padding: 10px; text-align: center;
            border: 1px solid rgba(106,90,205,0.3); transition: all 0.3s;
        }
        .unlock-item.available { border-color: #4ecdc4; background: rgba(78, 205, 196, 0.1); }
        .unlock-item.locked { opacity: 0.5; }
        .unlock-icon { font-size: 24px; margin-bottom: 5px; }
        .unlock-name { font-size: 12px; font-weight: bold; }
        .unlock-req { font-size: 10px; color: #999; margin-top: 3px; }

        /* ====== GACHA / MANA CRYSTALS ====== */
        .gacha-section {
            background: linear-gradient(135deg, rgba(100, 0, 200, 0.15), rgba(0, 100, 200, 0.15));
            border: 2px solid rgba(100, 0, 200, 0.4); border-radius: 15px; padding: 20px; margin-bottom: 20px;
        }
        .crystals-display { font-size: 28px; font-weight: bold; color: #9f7aea; text-align: center; margin: 10px 0; }
        .gacha-boxes { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0; }
        .gacha-box {
            border-radius: 12px; padding: 15px 10px; text-align: center;
            cursor: pointer; transition: all 0.3s; border: 2px solid transparent;
        }
        .gacha-box:hover { transform: translateY(-3px); }
        .gacha-box.basic { background: linear-gradient(135deg, rgba(150,150,150,0.2), rgba(100,100,100,0.2)); border-color: rgba(150,150,150,0.4); }
        .gacha-box.rare { background: linear-gradient(135deg, rgba(0,150,255,0.2), rgba(0,100,200,0.2)); border-color: rgba(0,150,255,0.4); }
        .gacha-box.legendary { background: linear-gradient(135deg, rgba(255,165,0,0.2), rgba(200,100,0,0.2)); border-color: rgba(255,165,0,0.4); animation: legendaryShine 3s infinite; }
        @keyframes legendaryShine { 0%, 100% { box-shadow: none; } 50% { box-shadow: 0 0 20px rgba(255, 165, 0, 0.5); } }
        .gacha-box .box-cost { font-size: 11px; color: #9f7aea; margin-top: 5px; }
        .gacha-result-icon { font-size: 60px; margin: 20px 0; animation: resultPop 0.5s ease; display: block; }
        @keyframes resultPop { 0% { transform: scale(0); } 70% { transform: scale(1.2); } 100% { transform: scale(1); } }
        .mystery-box-anim { font-size: 60px; animation: boxShake 0.5s infinite; display: inline-block; }
        @keyframes boxShake { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(-10deg); } 75% { transform: rotate(10deg); } }

        /* ====== IL SISTEMA GIUDICA ====== */
        .judgment-card {
            background: linear-gradient(135deg, rgba(20,0,0,0.9), rgba(40,0,0,0.9));
            border: 2px solid #ff0000;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            animation: judgmentGlow 3s infinite;
        }
        @keyframes judgmentGlow {
            0%, 100% { box-shadow: 0 0 10px rgba(255,0,0,0.3); }
            50% { box-shadow: 0 0 30px rgba(255,0,0,0.8); }
        }
        .judgment-grade {
            font-size: 72px;
            font-weight: 900;
            line-height: 1;
            margin: 10px 0;
            font-family: 'Georgia', serif;
        }
        .grade-S { color: #ffd700; text-shadow: 0 0 20px #ffd700; }
        .grade-A { color: #ff6b6b; text-shadow: 0 0 20px #ff6b6b; }
        .grade-B { color: #4ecdc4; text-shadow: 0 0 20px #4ecdc4; }
        .grade-C { color: #a8dadc; text-shadow: 0 0 10px #a8dadc; }
        .grade-D { color: #6c757d; }
        .grade-F { color: #ff0000; text-shadow: 0 0 20px #ff0000; animation: blink 0.5s infinite; }
        .judgment-comment {
            font-style: italic;
            color: #bbb;
            font-size: 14px;
            margin-top: 10px;
            line-height: 1.5;
            border-top: 1px solid rgba(255,0,0,0.3);
            padding-top: 10px;
        }

        /* ====== PENALTY VISIVA ABBANDONO ====== */
        .player-degraded .player-card {
            filter: grayscale(0.5) sepia(0.3);
        }
        .abandon-warning {
            background: linear-gradient(135deg, rgba(255,100,0,0.2), rgba(200,0,0,0.2));
            border: 2px solid #ff6400;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 15px;
            text-align: center;
            animation: abandonPulse 1.5s infinite;
            font-size: 13px;
        }
        @keyframes abandonPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* ====== FLASH QUEST ====== */
        .flash-quest-banner {
            background: linear-gradient(135deg, rgba(255,200,0,0.2), rgba(255,100,0,0.2));
            border: 2px solid #ffaa00;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            animation: flashPulse 1s infinite;
            position: relative;
            overflow: hidden;
        }
        .flash-quest-banner::before {
            content: '‚ö°';
            position: absolute;
            font-size: 80px;
            opacity: 0.05;
            right: -10px;
            top: -10px;
        }
        @keyframes flashPulse {
            0%, 100% { box-shadow: 0 0 10px rgba(255,170,0,0.4); }
            50% { box-shadow: 0 0 25px rgba(255,170,0,0.9); }
        }
        .flash-timer {
            font-size: 28px;
            font-weight: bold;
            color: #ffaa00;
            font-family: monospace;
        }
        .flash-multiplier {
            display: inline-block;
            background: #ffaa00;
            color: #000;
            font-weight: 900;
            padding: 2px 10px;
            border-radius: 20px;
            font-size: 14px;
        }

        /* ====== DOPPIO O NIENTE ====== */
        .double-or-nothing-btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            margin-top: 8px;
            transition: all 0.3s;
            width: 100%;
        }
        .double-or-nothing-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(255,107,107,0.4); }
        .double-or-nothing-btn.active-bet {
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            color: #000;
            animation: betPulse 1s infinite;
        }
        @keyframes betPulse {
            0%, 100% { box-shadow: 0 0 5px rgba(255,215,0,0.5); }
            50% { box-shadow: 0 0 20px rgba(255,215,0,1); }
        }

        /* ====== SISTEMA MESSAGGI ====== */
        .system-message-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: systemFadeIn 0.3s ease;
        }
        @keyframes systemFadeIn { from { opacity: 0; } to { opacity: 1; } }
        .system-message-box {
            max-width: 360px;
            width: 100%;
            text-align: center;
        }
        .system-message-title {
            font-size: 11px;
            letter-spacing: 4px;
            color: #555;
            margin-bottom: 20px;
            text-transform: uppercase;
        }
        .system-message-text {
            font-size: 20px;
            font-weight: bold;
            color: #e0e0e0;
            line-height: 1.5;
            font-family: 'Georgia', serif;
            font-style: italic;
            margin-bottom: 30px;
            padding: 20px;
            border-left: 3px solid #8a2be2;
        }
        .system-message-close {
            background: none;
            border: 1px solid #333;
            color: #555;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
            letter-spacing: 2px;
            text-transform: uppercase;
            transition: all 0.3s;
        }
        .system-message-close:hover { border-color: #8a2be2; color: #8a2be2; }

        /* ====== HALL OF SHAME ====== */
        .hall-of-shame {
            background: rgba(0,0,0,0.4);
            border: 1px solid rgba(255,0,0,0.2);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }
        .shame-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 13px;
        }
        .shame-grade-badge {
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 12px;
        }

        /* ====== EARLY BIRD ====== */
        .early-bird-badge {
            background: linear-gradient(135deg, rgba(255,200,50,0.2), rgba(255,140,0,0.2));
            border: 1px solid rgba(255,180,0,0.4);
            border-radius: 10px;
            padding: 10px 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
        }
    </style>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-46MVKW4MNQ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-46MVKW4MNQ');
    </script>
</head>
<body>
    <!-- Welcome Screen -->
    <div id="welcomeScreen" style="display: none;">
        <div class="welcome-container">
            <div class="welcome-title">‚öîÔ∏è REAL LIFE LEVELING ‚öîÔ∏è</div>
            
            <div class="quote-box">
                <div class="quote-text">
                    "√à meglio essere temuto che amato, se non si pu√≤ essere entrambi. 
                    Chi controlla s√© stesso, controlla il proprio destino."
                </div>
                <div class="quote-author">‚Äî Niccol√≤ Machiavelli</div>
            </div>

            <div class="tutorial-section">
                <div class="tutorial-title">üìñ COME FUNZIONA</div>

                <div class="tutorial-item">
                    <div class="tutorial-item-title">‚ù§Ô∏è HP (Punti Vita)</div>
                    <div class="tutorial-item-desc">
                        La tua vitalit√†. 0 HP = morte = 24h blocco. Perdi HP fallendo quest accettate.
                    </div>
                </div>

                <div class="tutorial-item">
                    <div class="tutorial-item-title">üíô MP (Punti Mana)</div>
                    <div class="tutorial-item-desc">
                        Energia per abilit√† speciali. Cresce con Intelligenza.
                    </div>
                </div>

                <div class="tutorial-item">
                    <div class="tutorial-item-title">‚≠ê EXP (Esperienza)</div>
                    <div class="tutorial-item-desc">
                        Completa quest per salire di livello e diventare pi√π forte.
                    </div>
                </div>

                <div class="tutorial-item">
                    <div class="tutorial-item-title">üìã QUEST</div>
                    <div class="tutorial-item-desc">
                        Devi ACCETTARE una quest per iniziare il timer. Completa prima della scadenza o subisci penalit√† HP.
                    </div>
                </div>

                <div class="tutorial-item">
                    <div class="tutorial-item-title">üí™ STATISTICHE</div>
                    <div class="tutorial-item-desc">
                        Crescono automaticamente completando quest. Barra EXP sotto ogni stat. 100 EXP ‚Üí +1 stat.
                    </div>
                </div>

                <div class="tutorial-item">
                    <div class="tutorial-item-title">üí∞ MANA STONES</div>
                    <div class="tutorial-item-desc">
                        Valuta per crafting e shop. Guadagni Mana Stones completando quest.
                    </div>
                </div>

                <div class="tutorial-item">
                    <div class="tutorial-item-title">‚öîÔ∏è RANK</div>
                    <div class="tutorial-item-desc">
                        E ‚Üí D ‚Üí C ‚Üí B ‚Üí A ‚Üí S ‚Üí NATIONAL. Sali ogni 10 livelli. A Rank C e A scegli Job Class.
                    </div>
                </div>

                <div class="tutorial-item">
                    <div class="tutorial-item-title">üë• SHADOW ARMY</div>
                    <div class="tutorial-item-desc">
                        Completa stessa quest x30 giorni consecutivi ‚Üí diventa Shadow che lavora per te automaticamente.
                    </div>
                </div>

                <div class="tutorial-item">
                    <div class="tutorial-item-title">üî• STREAK</div>
                    <div class="tutorial-item-desc">
                        Giorni consecutivi con almeno 1 quest completata. Pi√π alto lo streak, pi√π bonus EXP ottieni.
                    </div>
                </div>

                <div class="tutorial-item">
                    <div class="tutorial-item-title">üíÄ MORTE</div>
                    <div class="tutorial-item-desc">
                        0 HP = 24h blocco. Penalit√†: -50% Mana Stones, perdi EXP, Shadow Army danneggiata.
                    </div>
                </div>

                <div class="tutorial-item">
                    <div class="tutorial-item-title">üéÅ DAILY LOGIN BONUS</div>
                    <div class="tutorial-item-desc">
                        Apri l'app ogni giorno per ricevere un bonus crescente. Giorno 1-2: +50 EXP, Giorno 3-4: +100 EXP, Giorno 5-6: +150 EXP, Giorno 7: +300 EXP + Mystery Box! Se salti un giorno lo streak si azzera. Ogni login d√† anche +2 üíé Cristalli di Mana.
                    </div>
                </div>

                <div class="tutorial-item">
                    <div class="tutorial-item-title">üëπ BOSS SETTIMANALE (MULTI-FASE)</div>
                    <div class="tutorial-item-desc">
                        Ogni settimana arriva un nuovo Boss con 3 fasi da completare. Completa ogni fase per reward parziali, sconfiggi il Boss per EXP massicci + titolo raro. Ogni 4 settimane arriva un <strong style="color:#ff4444;">RAID BOSS</strong> con rewards leggendari: 2000 EXP, titolo e slot extra!
                    </div>
                </div>

                <div class="tutorial-item">
                    <div class="tutorial-item-title">üíé CRISTALLI DI MANA ‚Äî Come si ottengono</div>
                    <div class="tutorial-item-desc">
                        I Cristalli sono la valuta premium per il Gacha. Li guadagni cos√¨:<br>
                        ‚Ä¢ <strong>Quest giornaliera</strong> completata: 1-3 üíé<br>
                        ‚Ä¢ <strong>Emergency Quest</strong>: 5 üíé<br>
                        ‚Ä¢ <strong>Boss settimanale</strong> (ogni fase): 3 üíé + 10 üíé a boss sconfitto<br>
                        ‚Ä¢ <strong>Login giornaliero</strong>: 2 üíé fissi<br>
                        ‚Ä¢ <strong>Ritiro bonus giornata</strong>: fino a 10 üíé al giorno 7<br>
                        ‚Ä¢ <strong>Achievement</strong>: 5-20 üíé
                    </div>
                </div>

                <div class="tutorial-item">
                    <div class="tutorial-item-title">üîÆ GACHA ‚Äî Mana Crystal Loot</div>
                    <div class="tutorial-item-desc">
                        Spendi Cristalli di Mana nell'Inventario per aprire scrigni:<br>
                        ‚Ä¢ <strong>üì¶ Basic Box</strong> (10 üíé): EXP boost, titoli comuni, HP restore<br>
                        ‚Ä¢ <strong>üéÅ Rare Box</strong> (50 üíé): EXP surge, frame argento, stat boost<br>
                        ‚Ä¢ <strong>üëë Legendary Box</strong> (100 üíé): jackpot EXP, frame oro, +5 a tutti gli stat (5% di chance!)
                    </div>
                </div>

                <div class="tutorial-item">
                    <div class="tutorial-item-title">üé® CUSTOMIZATION UNLOCKS</div>
                    <div class="tutorial-item-desc">
                        Salendo di livello sblocchi cosmetici e temi:<br>
                        ‚Ä¢ <strong>Livello 5</strong>: Temi colore (SL Purple, Shadow Black, Gold Royal)<br>
                        ‚Ä¢ <strong>Livello 10-20</strong>: Frame Bronze / Silver / Gold<br>
                        ‚Ä¢ <strong>Livello 20</strong>: Titoli personalizzati<br>
                        ‚Ä¢ <strong>Rank S</strong>: Titolo "Shadow Monarch"<br>
                        Trovi tutto nella sezione ‚öôÔ∏è Impostazioni.
                    </div>
                </div>
            </div>

            <div class="quote-box">
                <div class="quote-text">"Il potere non si chiede. Si prende."</div>
            </div>

            <button class="continue-btn" onclick="startApp()">‚öîÔ∏è CONTINUA ‚öîÔ∏è</button>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" style="display: none;">
    <div class="container">
        <header>
            <h1>‚öîÔ∏è REAL LIFE LEVELING ‚öîÔ∏è</h1>
            <div class="daily-quote" id="dailyQuote"></div>
        </header>

        <!-- Tab: Player -->
        <div id="tab-player" class="tab-content active">
            <!-- Daily Login Bonus -->
            <div class="login-bonus-card" id="loginBonusCard">

            <!-- Abandon Warning (shown if not opened for 2+ days) -->
            <div class="abandon-warning" id="abandonWarning" style="display:none;"></div>

            <!-- Weekly Judgment Card -->
            <div class="judgment-card" id="judgmentCard" style="display:none;">
                <div style="font-size:11px; letter-spacing:3px; color:#ff4444; text-transform:uppercase;">‚öñÔ∏è Il Sistema Ha Giudicato</div>
                <div class="judgment-grade" id="judgmentGrade">‚Äî</div>
                <div style="font-size:13px; color:#888;">Settimana <span id="judgmentWeek"></span></div>
                <div class="judgment-comment" id="judgmentComment"></div>
            </div>
                <div style="font-size: 16px; font-weight: bold; color: #ffd700;">üéÅ DAILY LOGIN BONUS</div>
                <div style="font-size: 12px; color: #bbb; margin: 5px 0;" id="loginStreakText">Login streak: 0 giorni</div>
                <div class="login-days-grid" id="loginDaysGrid"></div>
                <button class="complete-btn" id="claimLoginBtn" onclick="claimLoginBonus()" style="display:none; margin-top: 5px;">
                    üéÅ Ritira Bonus!
                </button>
            </div>

            <div class="streak-display">
                <div style="font-size: 14px; color: #bbb;">STREAK GIORNALIERO</div>
                <div class="streak-number" id="streakDisplay">üî• 0 giorni</div>
                <div class="streak-bonus" id="streakBonus">Bonus: +0% EXP</div>
            </div>

            <div class="player-card">
                <div class="player-name" id="playerName">Hunter Novizio</div>
                <span class="rank" id="playerRank">E</span>
                <span class="job-class" id="playerClass">Nessuna Classe</span>
                <div class="level">Livello: <span id="playerLevel">1</span></div>
                
                <div class="stat-bar hp-bar">
                    <div class="stat-label">
                        <span>HP</span>
                        <span><span id="currentHP">100</span>/<span id="maxHP">100</span></span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="hpBar" style="width: 100%;"></div>
                    </div>
                </div>

                <div class="stat-bar mp-bar">
                    <div class="stat-label">
                        <span>MP</span>
                        <span><span id="currentMP">50</span>/<span id="maxMP">50</span></span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="mpBar" style="width: 100%;"></div>
                    </div>
                </div>

                <div class="stat-bar">
                    <div class="stat-label">
                        <span>EXP</span>
                        <span><span id="currentEXP">0</span>/<span id="nextLevelEXP">100</span></span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="expBar" style="width: 0%;"></div>
                    </div>
                </div>

                <div class="status-effects" id="statusEffects"></div>

                <div class="stat-points" id="statPointsDisplay">
                    üíé Punti Stat: <span id="availablePoints">0</span> | ‚≠ê Punti Skill: <span id="skillPoints">0</span>
                </div>

                <div class="stats-grid" id="statsGrid">
                    <!-- Stats rendered dynamically with EXP bars -->
                </div>
            </div>

            <div class="section">
                <div class="section-title">üèÜ Titolo Attivo</div>
                <div id="activeTitle" style="text-align: center; font-size: 18px; color: #ffd700;">
                    Nessun Titolo
                </div>
            </div>

            <div class="section">
                <div class="section-title">üìä Radar Stats</div>
                <div class="radar-chart-container">
                    <canvas id="radarChart" width="300" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Tab: Quests -->
        <div id="tab-quests" class="tab-content">
            <!-- Early Bird Quest -->
            <div id="earlyBirdSection" style="display:none;">
                <div class="early-bird-badge">
                    <span style="font-size:24px;">üåÖ</span>
                    <div>
                        <div style="font-weight:bold; color:#ffd700;">Early Bird Quest disponibile!</div>
                        <div style="color:#bbb; font-size:11px;">Solo tra le 06:00 e le 08:00 ‚Äî reward x2!</div>
                    </div>
                    <button class="complete-btn" style="width:auto; padding:8px 15px;" onclick="claimEarlyBird()">Ritira</button>
                </div>
            </div>

            <!-- Flash Quest -->
            <div id="flashQuestSection" style="display:none;">
                <div class="flash-quest-banner">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                        <div style="font-weight:bold; color:#ffaa00;">‚ö° FLASH QUEST</div>
                        <span class="flash-multiplier" id="flashMultiplier">x3</span>
                    </div>
                    <div id="flashQuestTitle" style="font-size:15px; font-weight:bold; margin-bottom:5px;"></div>
                    <div id="flashQuestDesc" style="font-size:12px; color:#bbb; margin-bottom:10px;"></div>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div class="flash-timer" id="flashTimer">02:00:00</div>
                        <button class="complete-btn" style="width:auto; padding:10px 20px;" onclick="completeFlashQuest()">‚ö° Completa!</button>
                    </div>
                </div>
            </div>
            <div class="section">
                <div class="section-title">üìã Quest Giornaliere</div>
                <div id="penaltyWarning" class="penalty-warning" style="display: none;">
                    ‚ö†Ô∏è ATTENZIONE: Quest giornaliere non completate!<br>
                    Penalit√† attiva: -10 HP
                </div>
                <div id="dailyQuests"></div>
                <button onclick="showCreateQuestModal()" class="complete-btn" style="margin-top: 10px;">
                    ‚úèÔ∏è Crea Quest Personalizzata
                </button>
            </div>

            <div id="emergencyQuestSection" style="display: none;">
                <div class="section">
                    <div class="section-title" style="color: #ff0000;">üö® EMERGENCY QUEST</div>
                    <div id="emergencyQuest"></div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">üíÄ Boss Fight Settimanale</div>
                <div id="bossQuest"></div>
            </div>
        </div>

        <!-- Tab: Progress -->
        <div id="tab-progress" class="tab-content">
            <div class="section">
                <div class="section-title">‚öîÔ∏è Sfida Te Stesso</div>
                <div id="selfComparison"></div>
            </div>

            <!-- Weekly Judgment History -->
            <div class="section">
                <div class="section-title">‚öñÔ∏è Giudizi del Sistema</div>
                <div style="font-size:12px; color:#888; margin-bottom:10px;">Il Sistema ti valuta ogni domenica sera. Nessuna piet√†.</div>
                <div id="weeklyJudgmentStats" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;"></div>
                <div class="hall-of-shame">
                    <div style="font-size:12px; color:#ff4444; letter-spacing:2px; text-transform:uppercase; margin-bottom:10px;">üìú Registro Storico</div>
                    <div id="hallOfShame">
                        <div style="color:#555; text-align:center; padding:15px; font-size:13px;">Nessun giudizio ancora. Il Sistema osserva.</div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">üë• Shadow Army</div>
                <div id="shadowArmyList" class="shadow-army-list"></div>
            </div>

            <div class="section">
                <div class="section-title">üèÜ Achievements</div>
                <div id="achievementsList" class="achievement-grid"></div>
            </div>

            <div class="section">
                <div class="section-title">üå≥ Skill Tree</div>
                <div style="text-align: center; margin-bottom: 15px;">
                    ‚≠ê Punti Skill Disponibili: <span id="skillPointsDisplay" style="color: #ffd700; font-weight: bold;">0</span>
                </div>
                <div id="skillTree" class="skill-tree"></div>
            </div>
        </div>

        <!-- Tab: Inventory -->
        <div id="tab-inventory" class="tab-content">
            <div class="section">
                <div class="section-title">üéí Inventario</div>
                <div style="text-align: center; margin-bottom: 15px;">
                    üí∞ Mana Stones: <span id="manaStones" style="color: #ffd700; font-weight: bold;">0</span>
                </div>
                
                <button onclick="showAddItemModal()" class="complete-btn" style="margin-bottom: 15px;">
                    ‚ûï Aggiungi Oggetto
                </button>
                
                <div class="inventory-grid" id="inventoryGrid">
                    <div style="grid-column: 1/-1; text-align: center; color: #999; padding: 40px;">
                        Nessun oggetto nell'inventario.
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">üî® Crafting</div>
                <div id="craftingGrid" class="crafting-grid"></div>
            </div>

            <!-- Gacha / Loot System -->
            <div class="section gacha-section">
                <div class="section-title" style="color:#9f7aea;">üîÆ Mana Crystal Gacha</div>
                <div style="font-size:13px; color:#bbb; margin-bottom:5px;">Cristalli guadagnati completando quest e login giornaliero.</div>
                <div class="crystals-display">üíé <span id="manaCrystalsDisplay">0</span> Cristalli</div>
                <div class="gacha-boxes">
                    <div class="gacha-box basic" onclick="openGachaBox('basic')">
                        <div style="font-size:30px;">üì¶</div>
                        <div style="font-size:12px; font-weight:bold;">Basic Box</div>
                        <div class="box-cost">üíé 10 cristalli</div>
                    </div>
                    <div class="gacha-box rare" onclick="openGachaBox('rare')">
                        <div style="font-size:30px;">üéÅ</div>
                        <div style="font-size:12px; font-weight:bold;">Rare Box</div>
                        <div class="box-cost">üíé 50 cristalli</div>
                    </div>
                    <div class="gacha-box legendary" onclick="openGachaBox('legendary')">
                        <div style="font-size:30px;">üëë</div>
                        <div style="font-size:12px; font-weight:bold;">Legendary Box</div>
                        <div class="box-cost">üíé 100 cristalli</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Settings -->
        <div id="tab-settings" class="tab-content">
            <div class="section">
                <div class="section-title">‚öôÔ∏è Impostazioni</div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px;">Nome Hunter:</label>
                    <input type="text" id="nameInput" placeholder="Inserisci il tuo nome" 
                           style="width: 100%; padding: 10px; border-radius: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(106, 90, 205, 0.5); color: white;">
                    <button onclick="saveName()" style="margin-top: 10px; width: 100%;" class="complete-btn">Salva Nome</button>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px;">Professione/Lavoro:</label>
                    <input type="text" id="professionInput" placeholder="Es: Programmatore, Studente, Chef, Medico..." 
                           style="width: 100%; padding: 10px; border-radius: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(106, 90, 205, 0.5); color: white;">
                    <button onclick="saveProfession()" style="margin-top: 10px; width: 100%;" class="complete-btn">Salva Professione</button>
                    <p style="font-size: 12px; color: #bbb; margin-top: 10px; line-height: 1.4;">
                        üí° Le quest verranno generate in base alla tua professione. Lascia vuoto per quest generali.
                    </p>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px;">
                        <input type="checkbox" id="notificationsEnabled" onchange="toggleNotifications()"> 
                        Abilita Notifiche Push
                    </label>
                </div>

                <button onclick="showWelcomeTutorial()" class="complete-btn" style="margin-bottom: 10px; width: 100%;">
                    üìñ Rivedi Tutorial
                </button>
                
                <button onclick="resetProgress()" class="reset-btn" style="width: 100%;">üîÑ Reset Progresso</button>

                <!-- Theme Customization -->
                <div style="margin-top: 20px;">
                    <div class="section-title" style="font-size:16px;">üé® Tema App</div>
                    <div style="font-size:12px; color:#bbb; margin-bottom:10px;">Sbloccato al livello 5+</div>
                    <div class="theme-selector" id="themeSelector"></div>
                </div>

                <!-- Progressive Unlocks -->
                <div style="margin-top: 20px;">
                    <div class="section-title" style="font-size:16px;">üîì Unlock Progressivi</div>
                    <div id="unlocksGrid" class="unlock-grid"></div>
                </div>

                <div style="margin: 20px 0; padding: 20px; background: rgba(255,215,0,0.1); border-radius: 10px; text-align: center;">
                    <h3 style="color: #ffd700; margin-bottom: 10px;">üí™ Supporta lo sviluppo!</h3>
                    <p style="color: #bbb; font-size: 14px; margin-bottom: 15px;">Ogni donazione aiuta a migliorare l'app</p>
                    
                    <a href="https://revolut.me/tuonome" target="_blank" 
                       style="display: inline-block; padding: 15px 40px; background: #ffd700; color: #000; text-decoration: none; border-radius: 10px; font-weight: bold; font-size: 16px;">
                        üí≥ Dona con Revolut
                    </a>
                    
                    <p style="font-size: 11px; color: #888; margin-top: 15px;">‚ö†Ô∏è Sostituisci "tuonome" con il tuo username Revolut</p>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <button class="nav-btn active" onclick="switchTab('player')">
                <span class="nav-icon">üë§</span>
                <span>Player</span>
            </button>
            <button class="nav-btn" onclick="switchTab('quests')">
                <span class="nav-icon">üìã</span>
                <span>Quests</span>
            </button>
            <button class="nav-btn" onclick="switchTab('progress')">
                <span class="nav-icon">üìà</span>
                <span>Progress</span>
            </button>
            <button class="nav-btn" onclick="switchTab('inventory')">
                <span class="nav-icon">üéí</span>
                <span>Inventory</span>
            </button>
            <button class="nav-btn" onclick="switchTab('settings')">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span>Settings</span>
            </button>
        </div>
    </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <!-- System Message Overlay -->
    <div id="systemMessageOverlay" class="system-message-overlay" style="display:none;" onclick="closeSystemMessage()">
        <div class="system-message-box" onclick="event.stopPropagation()">
            <div class="system-message-title">‚Äî Il Sistema ‚Äî</div>
            <div class="system-message-text" id="systemMessageText"></div>
            <button class="system-message-close" onclick="closeSystemMessage()">[ Riconosco ]</button>
        </div>
    </div>

    <!-- Double or Nothing Modal -->
    <div id="doubleOrNothingModal" class="modal">
        <div class="modal-content" style="text-align:center; max-width:320px;">
            <div style="font-size:20px; font-weight:bold; color:#ffd700; margin-bottom:5px;">üé≤ DOPPIO O NIENTE</div>
            <div style="font-size:13px; color:#bbb; margin-bottom:20px;">Scommetti l'EXP della tua prossima quest.<br>Vinci ‚Üí <strong style="color:#4ecdc4;">x2 EXP</strong>. Perdi ‚Üí <strong style="color:#ff6b6b;">0 EXP</strong>.</div>
            <div style="font-size:36px; margin: 20px 0;" id="diceAnimation">üé≤</div>
            <div id="donResult" style="display:none; margin-bottom:15px;">
                <div id="donResultIcon" style="font-size:40px;"></div>
                <div id="donResultText" style="font-size:16px; font-weight:bold; margin-top:10px;"></div>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="complete-btn" id="donConfirmBtn" onclick="confirmDoubleOrNothing()" style="background: linear-gradient(135deg, #ff6b6b, #ee5a6f);">üé≤ Scommetti!</button>
                <button class="complete-btn" id="donCancelBtn" onclick="document.getElementById('doubleOrNothingModal').classList.remove('show')" style="background: rgba(255,255,255,0.1);">Annulla</button>
            </div>
        </div>
    </div>

    <!-- Gacha Result Modal -->
    <div id="gachaResultModal" class="modal gacha-result-modal">
        <div class="modal-content" style="text-align:center; max-width:320px;">
            <div id="gachaResultIcon" class="gacha-result-icon">üéÅ</div>
            <div id="gachaResultTitle" style="font-size:20px; font-weight:bold; color:#ffd700; margin-bottom:10px;"></div>
            <div id="gachaResultDesc" style="color:#bbb; font-size:14px; margin-bottom:20px;"></div>
            <button class="complete-btn" onclick="document.getElementById('gachaResultModal').classList.remove('show')">‚ú® Ottimo!</button>
        </div>
    </div>

    <!-- Mystery Box Modal -->
    <div id="mysteryBoxModal" class="modal">
        <div class="modal-content" style="text-align:center; max-width:320px;">
            <div style="font-size:20px; font-weight:bold; color:#ffd700; margin-bottom:15px;">üéÅ MYSTERY BOX!</div>
            <div class="mystery-box-anim" id="mysteryBoxAnim">üéÅ</div>
            <div id="mysteryBoxResult" style="margin-top:20px; display:none;">
                <div id="mysteryBoxIcon" style="font-size:50px; margin-bottom:10px;"></div>
                <div id="mysteryBoxTitle" style="font-size:18px; font-weight:bold; color:#ffd700;"></div>
                <div id="mysteryBoxDesc" style="color:#bbb; font-size:14px; margin-top:8px;"></div>
            </div>
            <button class="complete-btn" id="mysteryBoxBtn" onclick="revealMysteryBox()" style="margin-top:20px;">üé≤ Apri!</button>
        </div>
    </div>

    <!-- Death Screen -->
    <div class="death-screen" id="deathScreen">
        <div class="death-title">‚ö∞Ô∏è SEI MORTO ‚ö∞Ô∏è</div>
        <div class="death-timer" id="deathTimer">23:59:59</div>
        <div class="death-message">
            Hai raggiunto 0 HP.<br><br>
            Penalit√†:<br>
            - Perso 50% Mana Stones<br>
            - Perso progresso EXP verso prossimo livello<br>
            - Shadow Army ridotta di 1 livello<br><br>
            Resurrezione automatica tra...
        </div>
    </div>

    <!-- Add Item Modal -->
    <div id="addItemModal" class="modal">
        <div class="modal-content">
            <h3 style="color: #ffd700; margin-bottom: 20px;">‚ûï Aggiungi Oggetto</h3>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #bbb;">Icona (Emoji)</label>
                <input type="text" id="itemIcon" placeholder="üì¶" maxlength="2" 
                       style="width: 100%; padding: 10px; border-radius: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(106, 90, 205, 0.5); color: white; font-size: 20px; text-align: center;">
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #bbb;">Nome Oggetto</label>
                <input type="text" id="itemName" placeholder="Es: Laptop" 
                       style="width: 100%; padding: 10px; border-radius: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(106, 90, 205, 0.5); color: white;">
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #bbb;">Quantit√†</label>
                <input type="number" id="itemQuantity" value="1" min="1" 
                       style="width: 100%; padding: 10px; border-radius: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(106, 90, 205, 0.5); color: white;">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; color: #bbb;">Effetto Bonus (opzionale)</label>
                <select id="itemEffect" style="width: 100%; padding: 10px; border-radius: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(106, 90, 205, 0.5); color: white;">
                    <option value="">Nessun Effetto</option>
                    <option value="coding">+10% EXP Coding</option>
                    <option value="study">+10% EXP Studio</option>
                    <option value="fitness">+10% EXP Fitness</option>
                    <option value="creative">+10% EXP Creativit√†</option>
                    <option value="hp_regen">+5 HP ogni giorno</option>
                    <option value="mp_regen">+3 MP ogni giorno</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button onclick="addItemToInventory()" class="complete-btn" style="flex: 1;">Aggiungi</button>
                <button onclick="closeAddItemModal()" class="reset-btn" style="flex: 1;">Annulla</button>
            </div>
        </div>
    </div>

    <!-- Create Quest Modal -->
    <div id="createQuestModal" class="modal">
        <div class="modal-content">
            <h3 style="color: #ffd700; margin-bottom: 20px;">‚úèÔ∏è Crea Quest Personalizzata</h3>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #bbb;">Titolo Quest</label>
                <input type="text" id="customQuestTitle" placeholder="Es: Finire progetto X" 
                       style="width: 100%; padding: 10px; border-radius: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(106, 90, 205, 0.5); color: white;">
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #bbb;">Descrizione</label>
                <textarea id="customQuestDesc" placeholder="Descrivi cosa devi fare..." rows="3"
                       style="width: 100%; padding: 10px; border-radius: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(106, 90, 205, 0.5); color: white; resize: none;"></textarea>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; color: #bbb;">Difficolt√† Stimata</label>
                <select id="customQuestDifficulty" style="width: 100%; padding: 10px; border-radius: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(106, 90, 205, 0.5); color: white;">
                    <option value="easy">Facile (30-40 EXP)</option>
                    <option value="medium">Media (50-70 EXP)</option>
                    <option value="hard">Difficile (80-100 EXP)</option>
                    <option value="extreme">Estrema (120-150 EXP)</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button onclick="createCustomQuest()" class="complete-btn" style="flex: 1;">Crea Quest</button>
                <button onclick="closeCreateQuestModal()" class="reset-btn" style="flex: 1;">Annulla</button>
            </div>
        </div>
    </div>

    <script>
        // Machiavellian Quotes
        const machiavelliQuotes = {
            daily: [
                "√à meglio essere temuto che amato, se non si pu√≤ essere entrambi.",
                "Il fine giustifica i mezzi. Sempre.",
                "Chi esita √® perduto. Chi attacca primo controlla il campo.",
                "La fortuna favorisce chi sa coglierla, non chi la aspetta.",
                "Non chiedere permesso. Chiedi perdono dopo aver vinto.",
                "Ogni battaglia vinta prima di essere combattuta √® pura strategia.",
                "La debolezza invita l'aggressione. La forza impone rispetto.",
                "Chi sa fingere regna. Chi mostra tutto perde.",
                "Al vertice si √® sempre soli. Abituati.",
                "La piet√† verso i nemici √® crudelt√† verso te stesso.",
                "I principi morali non conquistano regni.",
                "L'ambizione senza azione √® solo un sogno.",
                "Prendi tutto. Non lasciare nulla agli altri.",
                "O domini o sei dominato. Non c'√® via di mezzo.",
                "Nessuno ti dar√† niente. Prendi tutto.",
                "L'unico su cui puoi contare sei tu stesso."
            ]
        };

        function getDailyQuote() {
            const today = new Date().toDateString();
            const stored = localStorage.getItem('dailyQuoteDate');
            if (stored !== today) {
                const randomQuote = machiavelliQuotes.daily[Math.floor(Math.random() * machiavelliQuotes.daily.length)];
                localStorage.setItem('dailyQuote', randomQuote);
                localStorage.setItem('dailyQuoteDate', today);
            }
            return localStorage.getItem('dailyQuote') || machiavelliQuotes.daily[0];
        }

        function startApp() {
            localStorage.setItem('welcomeShown', 'true');
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            loadGame();
        }

        function showWelcomeTutorial() {
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('welcomeScreen').style.display = 'block';
        }

        // Stat mapping
        const statNames = {
            str: 'Forza',
            agi: 'Agilit√†',
            int: 'Intelligenza',
            vit: 'Vitalit√†',
            sen: 'Sensi',
            luck: 'Fortuna'
        };

        const statCategories = {
            str: 'physical',
            agi: 'physical',
            vit: 'health',
            int: 'intelligence',
            sen: 'social',
            luck: 'productivity'
        };

        // Game State
        let gameState = {
            player: {
                name: "Hunter Novizio",
                level: 1,
                exp: 0,
                hp: 100,
                maxHP: 100,
                mp: 50,
                maxMP: 50,
                stats: {
                    str: 10,
                    agi: 10,
                    int: 10,
                    vit: 10,
                    sen: 10,
                    luck: 10
                },
                statExp: {
                    str: 0,
                    agi: 0,
                    int: 0,
                    vit: 0,
                    sen: 0,
                    luck: 0
                },
                statPoints: 0,
                skillPoints: 0,
                rank: 'E',
                jobClass: 'none',
                profession: 'none',
                activeTitle: null,
                statusEffects: [],
                deathTime: null,
                streak: 0,
                lastQuestDate: null,
                radarStats: {
                    physical: 0,
                    intelligence: 0,
                    health: 0,
                    social: 0,
                    productivity: 0,
                    creativity: 0
                }
            },
            inventory: {
                manaStones: 0,
                items: []
            },
            quests: {
                daily: [],
                emergency: null,
                boss: null,
                custom: []
            },
            shadowArmy: [],
            achievements: [],
            skills: [],
            history: {
                yesterday: { quests: 0, exp: 0 },
                lastWeek: { quests: 0, exp: 0 },
                lastMonth: { quests: 0, exp: 0 }
            },
            lastDailyReset: null,
            lastWeeklyReset: null,
            // Sfida Ossessiva
            weeklyJudgment: null,
            lastJudgmentDate: null,
            weeklyQuestsCompleted: 0,
            weeklyExpGained: 0,
            appLastOpened: null,
            // Imprevedibilit√†
            flashQuest: null,
            earlyBirdClaimed: false,
            doubleOrNothingActive: false,
            doubleOrNothingQuestId: null,
            systemMessages: [],
            lastSystemMessage: null,
            lastEmergencyCheck: null,
            notificationsEnabled: false,
            firstLoginDate: null,
            totalDaysUsed: 0,
            milestonesReached: [],
            // NEW FEATURES
            loginStreak: 0,
            lastLoginDate: null,
            loginBonusClaimed: false,
            manaCrystals: 0,
            selectedTheme: 'default',
            customTitles: [],
            pendingMysteryBox: false,
            bossWeekNumber: 1
        };

        // Quest templates by category
        const questTemplates = {
            fitness: [
                { title: "Allenamento Mattutino", description: "100 flessioni, 100 addominali, 100 squat", reward: 50, category: "physical" },
                { title: "Cardio Training", description: "Corri per 5km o 30 minuti", reward: 45, category: "physical" },
                { title: "Stretching", description: "15 minuti di stretching completo", reward: 30, category: "physical" },
                { title: "Forza", description: "Allenamento pesi per 45 minuti", reward: 55, category: "physical" },
                { title: "Yoga Session", description: "30 minuti di yoga", reward: 40, category: "physical" }
            ],
            mental: [
                { title: "Meditazione", description: "Medita per 15 minuti", reward: 30, category: "intelligence" },
                { title: "Lettura", description: "Leggi per 30 minuti", reward: 40, category: "intelligence" },
                { title: "Journaling", description: "Scrivi nel tuo diario per 10 minuti", reward: 25, category: "intelligence" },
                { title: "Apprendimento", description: "Studia qualcosa di nuovo per 1 ora", reward: 60, category: "intelligence" }
            ],
            health: [
                { title: "Idratazione", description: "Bevi 2 litri d'acqua", reward: 20, category: "health" },
                { title: "Alimentazione Sana", description: "Mangia 5 porzioni di frutta/verdura", reward: 35, category: "health" },
                { title: "Sonno", description: "Dormi almeno 7 ore", reward: 30, category: "health" },
                { title: "No Junk Food", description: "Evita cibo spazzatura tutto il giorno", reward: 40, category: "health" }
            ],
            social: [
                { title: "Connessione Sociale", description: "Chiama un amico o familiare", reward: 35, category: "social" },
                { title: "Atto di Gentilezza", description: "Fai un gesto gentile per qualcuno", reward: 40, category: "social" },
                { title: "Networking", description: "Incontra una nuova persona", reward: 50, category: "social" }
            ],
            productivity: [
                { title: "Deep Work", description: "2 ore di lavoro concentrato senza distrazioni", reward: 70, category: "productivity" },
                { title: "Organizzazione", description: "Organizza la tua giornata e priorit√†", reward: 30, category: "productivity" },
                { title: "Pulizia Spazio", description: "Pulisci e organizza il tuo spazio di lavoro", reward: 35, category: "productivity" },
                { title: "Email Zero", description: "Svuota la inbox email", reward: 40, category: "productivity" }
            ],
            programmer: [
                { title: "Code Review", description: "Rivedi e refactorizza 100 righe di codice", reward: 60, category: "productivity" },
                { title: "Bug Hunting", description: "Risolvi almeno 3 bug", reward: 70, category: "productivity" },
                { title: "New Feature", description: "Implementa una nuova funzionalit√†", reward: 80, category: "productivity" },
                { title: "Documentazione", description: "Documenta il codice scritto oggi", reward: 50, category: "productivity" },
                { title: "Learning", description: "Impara un nuovo framework/linguaggio per 1h", reward: 65, category: "intelligence" }
            ],
            student: [
                { title: "Studio Intensivo", description: "Studia per 3 ore", reward: 70, category: "intelligence" },
                { title: "Esercizi", description: "Completa 20 esercizi", reward: 60, category: "intelligence" },
                { title: "Ripasso", description: "Ripassa gli appunti della settimana", reward: 50, category: "intelligence" },
                { title: "Progetto", description: "Lavora al progetto per 2 ore", reward: 75, category: "productivity" }
            ],
            creative: [
                { title: "Creazione Artistica", description: "Crea qualcosa per 1 ora (arte, musica, scrittura)", reward: 60, category: "creativity" },
                { title: "Brainstorming", description: "Genera 20 nuove idee per progetti", reward: 45, category: "creativity" },
                { title: "Portfolio", description: "Aggiungi un pezzo al tuo portfolio", reward: 70, category: "creativity" }
            ],
            business: [
                { title: "Strategia", description: "Pianifica la strategia della settimana", reward: 65, category: "productivity" },
                { title: "Client Meeting", description: "Incontra un cliente o potenziale cliente", reward: 70, category: "social" },
                { title: "Marketing", description: "Crea contenuto per social/marketing", reward: 60, category: "creativity" },
                { title: "Financial Review", description: "Analizza finanze e metriche", reward: 55, category: "intelligence" }
            ]
        };

        // Emergency Quest Templates
        const emergencyQuestTemplates = {
            programmer: [
                { title: "üö® Critical Bug in Production", description: "Bug critico in produzione! Risolvilo entro 4 ore", reward: 200 },
                { title: "‚ö° Hackathon Challenge", description: "Crea un'app funzionante in 12 ore", reward: 250 },
                { title: "üî• Hotfix Required", description: "Deploy hotfix entro 3 ore", reward: 180 }
            ],
            student: [
                { title: "üìö Exam Preparation Sprint", description: "Studia 8 ore no-stop per l'esame", reward: 220 },
                { title: "üìù Last Minute Assignment", description: "Completa tutto il progetto oggi", reward: 200 },
                { title: "üéØ Final Preparation", description: "Ripassa tutto il materiale in 10 ore", reward: 210 }
            ],
            business: [
                { title: "üíº Closing Deal", description: "Chiudi un contratto importante oggi", reward: 300 },
                { title: "üéØ Pitch Perfect", description: "Prepara e presenta pitch perfetto in 6 ore", reward: 230 },
                { title: "üìä Crisis Management", description: "Risolvi la crisi aziendale entro 8 ore", reward: 250 }
            ],
            creative: [
                { title: "üé® Deadline Crunch", description: "Completa il progetto creativo entro 10 ore", reward: 240 },
                { title: "‚ú® Creative Marathon", description: "Crea 5 pezzi di qualit√† oggi", reward: 220 },
                { title: "üöÄ Launch Day", description: "Finalizza e lancia il progetto oggi", reward: 260 }
            ],
            general: [
                { title: "üí™ 100 Days Tribute", description: "200 flessioni + 200 squat + 20km oggi", reward: 180 },
                { title: "üèÉ Marathon Challenge", description: "Corri una mezza maratona oggi", reward: 250 },
                { title: "üßò Zen Master", description: "Medita per 3 ore totali oggi", reward: 150 }
            ]
        };

        // Boss Quest Templates (Multi-phase, rotating)
        const weeklyBosses = [
            {
                id: 'procrastination_demon',
                title: 'üëπ Procrastination Demon',
                description: 'Il demone della procrastinazione ti sfida! Completa tutte le quest giornaliere per 7 giorni di fila.',
                totalPhases: 3,
                phaseReqs: ['Completa 3 quest', 'Completa 5 quest in un giorno', 'Zero missioni fallite per 3 giorni'],
                phaseRewards: [100, 150, 200],
                reward: 600,
                title_reward: '‚öîÔ∏è Demon Slayer'
            },
            {
                id: 'distraction_dragon',
                title: 'üêâ Distraction Dragon',
                description: 'Il drago delle distrazioni blocca il tuo cammino! Mantieni il focus completando quest di produttivit√†.',
                totalPhases: 3,
                phaseReqs: ['2 quest productivity', '4 quest senza interruzioni', 'Deep Work per 3 giorni'],
                phaseRewards: [120, 180, 220],
                reward: 650,
                title_reward: 'üéØ Dragon Tamer'
            },
            {
                id: 'laziness_lich',
                title: 'üíÄ Laziness Lich',
                description: 'Il Lich della Pigrizia vuole il tuo spirito! Allenati duramente per sconfiggerlo.',
                totalPhases: 3,
                phaseReqs: ['3 quest fitness', '5 sessioni di allenamento', '7 giorni attivi'],
                phaseRewards: [130, 190, 250],
                reward: 700,
                title_reward: 'üí™ Lich Breaker'
            },
            {
                id: 'raid_boss',
                title: 'üåë RAID BOSS: Shadow King',
                description: '‚ö†Ô∏è EVENTO SPECIALE! Il Shadow King √® apparso! Completa TUTTE le quest per 7 giorni consecutivi.',
                totalPhases: 3,
                phaseReqs: ['100% quest x2 giorni', '100% quest x5 giorni', '100% quest x7 giorni'],
                phaseRewards: [300, 500, 700],
                reward: 2000,
                title_reward: 'üëë Shadow King Slayer',
                isRaid: true
            }
        ];

        const bossQuestTemplates = {
            programmer: [
                { title: "üíÄ Final Boss: Major Release", description: "Completa e deploya un major release questa settimana con zero bug critici", reward: 500 }
            ],
            student: [
                { title: "üíÄ Final Boss: Perfect Week", description: "Completa tutti gli assignment + studia 40 ore questa settimana", reward: 500 }
            ],
            business: [
                { title: "üíÄ Final Boss: Growth Sprint", description: "Ottieni 10 nuovi clienti questa settimana", reward: 600 }
            ],
            creative: [
                { title: "üíÄ Final Boss: Creative Marathon", description: "Completa 3 progetti maggiori questa settimana", reward: 550 }
            ],
            general: [
                { title: "üíÄ Final Boss: Perfect Week", description: "Completa TUTTE le quest giornaliere per 7 giorni + 50km corsa totale", reward: 500 }
            ]
        };

        // Achievements definitions
        const achievementDefinitions = [
            { id: 'iron_will', icon: 'üí™', title: 'Iron Will', desc: '30 giorni streak', unlocked: false, bonus: '+10 HP permanente' },
            { id: 'early_bird', icon: 'üåÖ', title: 'Early Bird', desc: 'Quest prima 8am x7 giorni', unlocked: false, bonus: '+5% EXP mattina' },
            { id: 'perfectionist', icon: '‚ú®', title: 'Perfectionist', desc: '100% quest x1 mese', unlocked: false, bonus: '+10% EXP totale' },
            { id: 'shadow_master', icon: 'üë•', title: 'Shadow Master', desc: '10 Shadow Army attive', unlocked: false, bonus: '+20 MP permanente' },
            { id: 'survivor', icon: '‚ö∞Ô∏è', title: 'Survivor', desc: 'Resurrezione da morte', unlocked: false, bonus: '+15% HP regen' },
            { id: 'scholar', icon: 'üìö', title: 'Scholar', desc: '100 quest intellettuali', unlocked: false, bonus: '+15 INT' },
            { id: 'warrior', icon: '‚öîÔ∏è', title: 'Warrior', desc: '100 quest fisiche', unlocked: false, bonus: '+15 STR' },
            { id: 'emergency_hero', icon: 'üö®', title: 'Emergency Hero', desc: '5 Emergency Quest completate', unlocked: false, bonus: '+100 HP max' }
        ];

        // Skills definitions
        const skillDefinitions = {
            combat: [
                { id: 'second_wind', name: 'Second Wind', desc: 'Recupera 20 HP 1 volta al giorno', cost: 1, unlocked: false },
                { id: 'berserker', name: 'Berserker', desc: '+50% EXP quando HP < 20%', cost: 2, unlocked: false, requires: 'second_wind' },
                { id: 'immortal', name: 'Immortal', desc: 'Sopravvivi a 0 HP 1 volta (no death penalty)', cost: 3, unlocked: false, requires: 'berserker' }
            ],
            magic: [
                { id: 'mana_boost', name: 'Mana Boost', desc: '+20 MP max', cost: 1, unlocked: false },
                { id: 'double_exp', name: 'Double EXP', desc: '1 quest al giorno d√† 2x EXP', cost: 2, unlocked: false, requires: 'mana_boost' },
                { id: 'time_master', name: 'Time Master', desc: '+2 ore su deadline Emergency Quest', cost: 3, unlocked: false, requires: 'double_exp' }
            ],
            support: [
                { id: 'lucky_charm', name: 'Lucky Charm', desc: '+10% chance Emergency Quest', cost: 1, unlocked: false },
                { id: 'wealthy', name: 'Wealthy', desc: '+50% Mana Stones da quest', cost: 2, unlocked: false, requires: 'lucky_charm' },
                { id: 'master_crafter', name: 'Master Crafter', desc: 'Sblocca ricette rare', cost: 3, unlocked: false, requires: 'wealthy' }
            ]
        };

        // Crafting recipes
        const craftingRecipes = [
            { 
                id: 'hp_potion', 
                name: '‚ù§Ô∏è HP Potion', 
                materials: [{ name: 'Mana Stones', count: 50 }], 
                result: { type: 'consumable', effect: 'restore_hp', value: 50 },
                unlocked: true 
            },
            { 
                id: 'exp_boost', 
                name: '‚≠ê EXP Boost', 
                materials: [{ name: 'Mana Stones', count: 100 }], 
                result: { type: 'buff', effect: 'exp_boost', value: 20, duration: 3600000 },
                unlocked: true 
            },
            { 
                id: 'shield', 
                name: 'üõ°Ô∏è Emergency Shield', 
                materials: [{ name: 'Mana Stones', count: 200 }], 
                result: { type: 'buff', effect: 'damage_reduction', value: 50, duration: 86400000 },
                unlocked: false 
            }
        ];

        // Job Classes
        const jobClasses = {
            E: { name: 'Nessuna Classe', bonuses: {} },
            D: { name: 'Nessuna Classe', bonuses: {} },
            C: { 
                options: ['Tank', 'Assassin', 'Mage'],
                Tank: { name: 'Tank', bonuses: { hp: 50, def: 20 } },
                Assassin: { name: 'Assassin', bonuses: { agi: 15, crit: 10 } },
                Mage: { name: 'Mage', bonuses: { int: 15, mp: 30 } }
            },
            B: { name: 'Inherited from C', bonuses: {} },
            A: {
                options: ['Shadow Monarch', 'Berserker', 'Sage'],
                'Shadow Monarch': { name: 'Shadow Monarch', bonuses: { shadow_power: 50 } },
                Berserker: { name: 'Berserker', bonuses: { str: 25, hp: 100 } },
                Sage: { name: 'Sage', bonuses: { int: 25, mp: 50 } }
            },
            S: { name: 'Inherited from A', bonuses: {} },
            NATIONAL: { name: 'National Level Hunter', bonuses: { all_stats: 50 } }
        };

        // Login Bonus Rewards (must be declared before loadGame)
        const LOGIN_REWARDS = [
            { day: 1, exp: 50, crystals: 2, label: 'Giorno 1' },
            { day: 2, exp: 50, crystals: 2, label: 'Giorno 2' },
            { day: 3, exp: 100, crystals: 3, label: 'Giorno 3' },
            { day: 4, exp: 100, crystals: 3, label: 'Giorno 4' },
            { day: 5, exp: 150, crystals: 5, label: 'Giorno 5' },
            { day: 6, exp: 150, crystals: 5, label: 'Giorno 6' },
            { day: 7, exp: 300, crystals: 10, label: 'Giorno 7', mysteryBox: true }
        ];

        const THEMES = [
            { id: 'default', name: 'üåë Dark Mode', colors: '#1a1a2e', reqLevel: 1 },
            { id: 'purple', name: 'üíú SL Purple', colors: '#1a0a2e', reqLevel: 5 },
            { id: 'shadow', name: 'üñ§ Shadow Black', colors: '#050505', reqLevel: 5 },
            { id: 'gold', name: 'üëë Gold Royal', colors: '#1a1500', reqLevel: 5 }
        ];

        const PROGRESSIVE_UNLOCKS = [
            { id: 'color_themes', icon: 'üé®', name: 'Color Themes', req: 'Livello 5', reqLevel: 5 },
            { id: 'bronze_frame', icon: 'ü•â', name: 'Bronze Frame', req: 'Livello 10', reqLevel: 10 },
            { id: 'silver_frame', icon: 'ü•à', name: 'Silver Frame', req: 'Livello 15', reqLevel: 15 },
            { id: 'gold_frame', icon: 'ü•á', name: 'Gold Frame', req: 'Livello 20', reqLevel: 20 },
            { id: 'custom_title', icon: 'üè∑Ô∏è', name: 'Custom Titles', req: 'Livello 20', reqLevel: 20 },
            { id: 'eternal_grinder', icon: 'üí™', name: '"Eternal Grinder"', req: 'Livello 30', reqLevel: 30 },
            { id: 'shadow_monarch_title', icon: 'üåë', name: '"Shadow Monarch"', req: 'Rank S', reqLevel: 0, reqRank: 'S' },
            { id: 'matrix_theme', icon: 'üé≠', name: 'Matrix Theme', req: 'Livello 50', reqLevel: 50 }
        ];

        const GACHA_BOXES = {
            basic: {
                cost: 10,
                pools: [
                    { weight: 60, icon: '‚≠ê', name: 'EXP Boost', desc: '+100 EXP bonus!', action: () => gainEXP(100) },
                    { weight: 25, icon: 'üìú', name: 'Titolo: Cacciatore', desc: 'Titolo "Il Cacciatore" sbloccato!', action: () => unlockTitle('üó°Ô∏è Il Cacciatore') },
                    { weight: 10, icon: 'üíé', name: '+5 Cristalli', desc: 'Bonus cristalli!', action: () => { gameState.manaCrystals += 5; } },
                    { weight: 5, icon: '‚ù§Ô∏è', name: 'HP Restore', desc: 'HP ripristinati al massimo!', action: () => { gameState.player.hp = gameState.player.maxHP; } }
                ]
            },
            rare: {
                cost: 50,
                pools: [
                    { weight: 50, icon: 'üí´', name: 'EXP Surge', desc: '+350 EXP bonus!', action: () => gainEXP(350) },
                    { weight: 25, icon: 'üñºÔ∏è', name: 'Silver Frame', desc: 'Frame argento sbloccato!', action: () => unlockTitle('ü•à Silver Hunter') },
                    { weight: 15, icon: 'üíé', name: '+25 Cristalli', desc: 'Bonus cristalli!', action: () => { gameState.manaCrystals += 25; } },
                    { weight: 7, icon: 'üõ°Ô∏è', name: 'Quest Slot Extra', desc: '+1 slot quest custom!', action: () => showNotification('üõ°Ô∏è Quest slot extra sbloccato!') },
                    { weight: 3, icon: '‚ö°', name: 'Stat Boost', desc: '+2 a tutti gli stat!', action: () => { Object.keys(gameState.player.stats).forEach(k => gameState.player.stats[k] += 2); } }
                ]
            },
            legendary: {
                cost: 100,
                pools: [
                    { weight: 40, icon: 'üåü', name: 'EXP Jackpot', desc: '+750 EXP bonus!', action: () => gainEXP(750) },
                    { weight: 25, icon: 'üëë', name: 'Gold Frame', desc: 'Frame oro sbloccato!', action: () => unlockTitle('üëë Gold Hunter') },
                    { weight: 20, icon: 'üíé', name: '+60 Cristalli', desc: 'Bonus cristalli!', action: () => { gameState.manaCrystals += 60; } },
                    { weight: 10, icon: 'üë•', name: 'Shadow Slot Extra', desc: '+1 slot Shadow Army!', action: () => showNotification('üë• Shadow Army slot extra!') },
                    { weight: 5, icon: 'üèÜ', name: 'JACKPOT! Stat Boost', desc: '+5 a TUTTI gli stat! Permanente!', action: () => { Object.keys(gameState.player.stats).forEach(k => gameState.player.stats[k] += 5); showNotification('üèÜ JACKPOT! +5 a tutti gli stat!'); } }
                ]
            }
        };

        // Initialize
        if (!localStorage.getItem('welcomeShown')) {
            document.getElementById('welcomeScreen').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
        } else {
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            loadGame();
        }
        setInterval(checkEmergencyQuest, 3600000); // Check every hour
        setInterval(updateTimers, 1000); // Update timers every second
        setInterval(checkDeath, 1000); // Check death status

        function updateTotalDaysUsed() {
            if (!gameState.firstLoginDate) return;
            
            const firstLogin = new Date(gameState.firstLoginDate);
            const today = new Date();
            const daysDiff = Math.floor((today - firstLogin) / (1000 * 60 * 60 * 24));
            gameState.totalDaysUsed = Math.max(1, daysDiff + 1);
        }

        function checkMilestones() {
            const milestones = [
                { days: 7, name: 'first_week', title: 'üéâ First Week Survivor', expReward: 200, message: '7 giorni di uso consecutivo! Incredibile!' },
                { days: 30, name: 'monthly_champion', title: 'üèÜ Monthly Champion', expReward: 500, message: '30 giorni! Sei un vero Hunter!' },
                { days: 100, name: 'centurion', title: 'üí™ Centurion', expReward: 1000, message: '100 giorni! Potere assoluto!' },
                { days: 365, name: 'eternal_hunter', title: '‚≠ê Eternal Hunter', expReward: 2000, message: 'UN ANNO! Sei una leggenda vivente!' }
            ];
            
            milestones.forEach(milestone => {
                if (gameState.totalDaysUsed >= milestone.days && !gameState.milestonesReached.includes(milestone.name)) {
                    gameState.milestonesReached.push(milestone.name);
                    
                    // Give rewards
                    gainEXP(milestone.expReward);
                    
                    // Unlock title if not exists
                    if (!gameState.achievements.some(a => a.id === milestone.name)) {
                        gameState.achievements.push({
                            id: milestone.name,
                            name: milestone.title,
                            description: milestone.message,
                            unlocked: true,
                            bonus: `+${milestone.expReward} EXP`,
                            icon: milestone.title.split(' ')[0]
                        });
                    }
                    
                    // Show celebration
                    showMilestoneCelebration(milestone);
                    
                    saveGame();
                }
            });
        }

        function showMilestoneCelebration(milestone) {
            const celebration = document.createElement('div');
            celebration.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                padding: 40px;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                z-index: 10001;
                text-align: center;
                max-width: 90%;
                animation: bounceIn 0.6s ease-out;
            `;
            
            celebration.innerHTML = `
                <div style="font-size: 60px; margin-bottom: 20px;">üéâ</div>
                <div style="font-size: 28px; font-weight: bold; color: #ffd700; margin-bottom: 15px;">
                    MILESTONE RAGGIUNTO!
                </div>
                <div style="font-size: 24px; color: white; margin-bottom: 10px;">
                    ${milestone.title}
                </div>
                <div style="font-size: 16px; color: #e0e0e0; margin-bottom: 20px;">
                    ${milestone.message}
                </div>
                <div style="font-size: 20px; color: #4ecdc4; font-weight: bold; margin-bottom: 30px;">
                    +${milestone.expReward} EXP!
                </div>
                <button onclick="this.parentElement.remove()" style="
                    background: #ffd700;
                    color: #000;
                    border: none;
                    padding: 15px 40px;
                    border-radius: 10px;
                    font-size: 18px;
                    font-weight: bold;
                    cursor: pointer;
                    box-shadow: 0 4px 15px rgba(255,215,0,0.4);
                ">
                    FANTASTICO! üî•
                </button>
            `;
            
            // Add animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes bounceIn {
                    0% { transform: translate(-50%, -50%) scale(0.3); opacity: 0; }
                    50% { transform: translate(-50%, -50%) scale(1.05); }
                    70% { transform: translate(-50%, -50%) scale(0.9); }
                    100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(celebration);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (celebration.parentElement) {
                    celebration.remove();
                }
            }, 10000);
        }

        function loadGame() {
            const saved = localStorage.getItem('realLifeLevelingComplete');
            if (saved) {
                const savedState = JSON.parse(saved);
                gameState = {...gameState, ...savedState};
                
                // Initialize missing properties for backward compatibility
                if (!gameState.player.radarStats) {
                    gameState.player.radarStats = {
                        physical: 0, intelligence: 0, health: 0,
                        social: 0, productivity: 0, creativity: 0
                    };
                }
                if (!gameState.player.statusEffects) gameState.player.statusEffects = [];
                if (!gameState.player.streak) gameState.player.streak = 0;
                if (!gameState.player.lastQuestDate) gameState.player.lastQuestDate = null;
                if (!gameState.player.statExp) {
                    gameState.player.statExp = {
                        str: 0, agi: 0, int: 0, vit: 0, sen: 0, luck: 0
                    };
                }
                if (!gameState.history) {
                    gameState.history = {
                        yesterday: { quests: 0, exp: 0 },
                        lastWeek: { quests: 0, exp: 0 },
                        lastMonth: { quests: 0, exp: 0 }
                    };
                }
                if (!gameState.achievements) {
                    gameState.achievements = achievementDefinitions.map(a => ({...a}));
                }
                if (!gameState.skills) {
                    gameState.skills = {
                        combat: skillDefinitions.combat.map(s => ({...s})),
                        magic: skillDefinitions.magic.map(s => ({...s})),
                        support: skillDefinitions.support.map(s => ({...s}))
                    };
                }
                if (!gameState.firstLoginDate) {
                    gameState.firstLoginDate = new Date().toISOString();
                }
                if (!gameState.totalDaysUsed) gameState.totalDaysUsed = 0;
                if (!gameState.milestonesReached) gameState.milestonesReached = [];
                
                // NEW FEATURES backward compat
                if (gameState.loginStreak === undefined) gameState.loginStreak = 0;
                if (!gameState.lastLoginDate) gameState.lastLoginDate = null;
                if (gameState.loginBonusClaimed === undefined) gameState.loginBonusClaimed = false;
                if (gameState.manaCrystals === undefined) gameState.manaCrystals = 0;
                if (!gameState.selectedTheme) gameState.selectedTheme = 'default';
                if (!gameState.customTitles) gameState.customTitles = [];
                if (gameState.pendingMysteryBox === undefined) gameState.pendingMysteryBox = false;
                if (!gameState.bossWeekNumber) gameState.bossWeekNumber = 1;
                // Obsessive + Unpredictability compat
                if (!gameState.judgmentHistory) gameState.judgmentHistory = [];
                if (gameState.weeklyQuestsCompleted === undefined) gameState.weeklyQuestsCompleted = 0;
                if (gameState.weeklyExpGained === undefined) gameState.weeklyExpGained = 0;
                if (!gameState.appLastOpened) gameState.appLastOpened = null;
                if (gameState.flashQuest === undefined) gameState.flashQuest = null;
                if (gameState.earlyBirdClaimed === undefined) gameState.earlyBirdClaimed = false;
                if (gameState.doubleOrNothingActive === undefined) gameState.doubleOrNothingActive = false;
                if (gameState.doubleOrNothingQuestId === undefined) gameState.doubleOrNothingQuestId = null;
                // Upgrade old boss quests to new format
                if (gameState.quests.boss && gameState.quests.boss.totalPhases === undefined) {
                    gameState.quests.boss = generateBossQuest();
                }
                
                updateTotalDaysUsed();
                checkDailyReset();
            } else {
                gameState.quests.daily = generateDailyQuests();
                gameState.quests.boss = generateBossQuest();
                gameState.lastDailyReset = new Date().toDateString();
                gameState.lastWeeklyReset = new Date().toDateString();
                gameState.lastEmergencyCheck = Date.now();
                gameState.firstLoginDate = new Date().toISOString();
                gameState.totalDaysUsed = 1;
                gameState.milestonesReached = [];
                gameState.achievements = achievementDefinitions.map(a => ({...a}));
                gameState.skills = {
                    combat: skillDefinitions.combat.map(s => ({...s})),
                    magic: skillDefinitions.magic.map(s => ({...s})),
                    support: skillDefinitions.support.map(s => ({...s}))
                };
                // NEW
                gameState.loginStreak = 0;
                gameState.lastLoginDate = null;
                gameState.loginBonusClaimed = false;
                gameState.manaCrystals = 0;
                gameState.selectedTheme = 'default';
                gameState.customTitles = [];
                gameState.pendingMysteryBox = false;
                gameState.bossWeekNumber = 1;
            }
            
            applyItemEffects();
            document.getElementById('dailyQuote').textContent = getDailyQuote();
            checkDailyLoginBonus();
            applyTheme(gameState.selectedTheme);
            checkAbandonPenalty();
            checkEarlyBirdQuest();
            checkWeeklyJudgment();
            scheduleSystemMessage();
            scheduleFlashQuest();
            updateUI();
            drawRadarChart();
            checkMilestones();
            requestNotificationPermission();
            if (gameState.pendingMysteryBox) {
                setTimeout(() => openMysteryBox(), 1000);
            }
        }

        function saveGame() {
            localStorage.setItem('realLifeLevelingComplete', JSON.stringify(gameState));
        }

        function checkDailyReset() {
            const today = new Date().toDateString();
            
            if (gameState.lastDailyReset !== today) {
                const allCompleted = gameState.quests.daily.every(q => q.completed);
                
                // Save today's data as yesterday's before reset (including custom quests)
                const dailyCompleted = gameState.quests.daily.filter(q => q.completed).length;
                const customCompleted = (gameState.quests.custom || []).filter(q => q.completed).length;
                gameState.history.yesterday = {
                    quests: dailyCompleted + customCompleted,
                    exp: gameState.player.exp
                };
                
                if (!allCompleted && gameState.player.deathTime === null) {
                    takeDamage(10, "Quest giornaliere non completate");
                }
                
                // Update shadow army streaks
                gameState.quests.daily.forEach(quest => {
                    if (quest.completed) {
                        updateShadowArmy(quest);
                    } else {
                        breakShadowStreak(quest);
                    }
                });
                
                gameState.quests.daily = generateDailyQuests();
                gameState.lastDailyReset = today;
                saveGame();
            }
            
            // Check weekly reset
            const lastReset = new Date(gameState.lastWeeklyReset || 0);
            const now = new Date();
            const daysSinceReset = Math.floor((now - lastReset) / (1000 * 60 * 60 * 24));
            const currentDay = now.getDay();
            
            if (!gameState.lastWeeklyReset || (daysSinceReset >= 7 && currentDay === 1)) {
                if (gameState.quests.boss && !gameState.quests.boss.completed) {
                    takeDamage(30, "Boss Fight non completata");
                }
                gameState.bossWeekNumber = (gameState.bossWeekNumber || 1) + 1;
                gameState.quests.boss = generateBossQuest();
                gameState.lastWeeklyReset = now.toDateString();
                saveGame();
            }
        }

        function generateDailyQuests() {
            const quests = [];
            let questId = Date.now();
            
            const fitnessQuest = questTemplates.fitness[Math.floor(Math.random() * questTemplates.fitness.length)];
            quests.push({...fitnessQuest, id: questId++, completed: false, accepted: false, type: 'daily'});
            
            const healthQuest = questTemplates.health[Math.floor(Math.random() * questTemplates.health.length)];
            quests.push({...healthQuest, id: questId++, completed: false, accepted: false, type: 'daily'});
            
            const mentalQuest = questTemplates.mental[Math.floor(Math.random() * questTemplates.mental.length)];
            quests.push({...mentalQuest, id: questId++, completed: false, accepted: false, type: 'daily'});
            
            // Check if profession exists in templates, otherwise generate custom quest
            if (gameState.player.profession !== 'none' && gameState.player.profession !== '') {
                if (questTemplates[gameState.player.profession]) {
                    // Use predefined template
                    const profQuest = questTemplates[gameState.player.profession][Math.floor(Math.random() * questTemplates[gameState.player.profession].length)];
                    quests.push({...profQuest, id: questId++, completed: false, accepted: false, type: 'daily'});
                } else {
                    // Generate custom quest based on profession text
                    const customQuest = generateCustomProfessionQuest(gameState.player.profession);
                    quests.push({...customQuest, id: questId++, completed: false, accepted: false, type: 'daily'});
                }
            } else {
                const prodQuest = questTemplates.productivity[Math.floor(Math.random() * questTemplates.productivity.length)];
                quests.push({...prodQuest, id: questId++, completed: false, accepted: false, type: 'daily'});
            }
            
            return quests;
        }

        function generateCustomProfessionQuest(profession) {
            const questTemplates = [
                {
                    title: `Compito ${profession}`,
                    description: `Completa un'attivit√† importante legata al tuo lavoro da ${profession}`,
                    reward: 60,
                    category: 'productivity'
                },
                {
                    title: `Progetto ${profession}`,
                    description: `Lavora su un progetto o iniziativa professionale da ${profession}`,
                    reward: 70,
                    category: 'productivity'
                },
                {
                    title: `Skill Development`,
                    description: `Migliora una competenza chiave per un ${profession}`,
                    reward: 65,
                    category: 'intelligence'
                },
                {
                    title: `Networking Professionale`,
                    description: `Connettiti con qualcuno nel settore da ${profession}`,
                    reward: 55,
                    category: 'social'
                },
                {
                    title: `Obiettivo Professionale`,
                    description: `Fai progressi verso un obiettivo di carriera da ${profession}`,
                    reward: 75,
                    category: 'productivity'
                }
            ];
            
            return questTemplates[Math.floor(Math.random() * questTemplates.length)];
        }

        function generateBossQuest() {
            // Get current week number to rotate bosses
            const weekNum = gameState.bossWeekNumber || 1;
            // Every 4th week is a raid boss
            const bossIndex = weekNum % 4 === 0 ? 3 : (weekNum - 1) % 3;
            const bossTemplate = weeklyBosses[bossIndex];
            
            return {
                ...bossTemplate,
                id: Date.now(),
                completed: false,
                accepted: false,
                type: 'boss',
                currentPhase: 0,   // 0 = no phase completed
                phasesCompleted: [false, false, false],
                bossHP: 100,
                weekNum: weekNum
            };
        }

        function checkEmergencyQuest() {
            if (gameState.quests.emergency || gameState.player.deathTime) return;
            
            const hoursSinceLastCheck = (Date.now() - (gameState.lastEmergencyCheck || Date.now())) / 3600000;
            
            if (hoursSinceLastCheck < 1) return;
            
            let emergencyChance = 0.05; // 5% base chance per hour
            
            // Increase chance with Lucky Charm skill
            const luckyCharm = gameState.skills.support?.find(s => s.id === 'lucky_charm' && s.unlocked);
            if (luckyCharm) emergencyChance *= 1.1;
            
            if (Math.random() < emergencyChance) {
                generateEmergencyQuest();
            }
            
            gameState.lastEmergencyCheck = Date.now();
            saveGame();
        }

        function generateEmergencyQuest() {
            const templates = gameState.player.profession !== 'none' && emergencyQuestTemplates[gameState.player.profession]
                ? emergencyQuestTemplates[gameState.player.profession]
                : emergencyQuestTemplates.general;
            
            const template = templates[Math.floor(Math.random() * templates.length)];
            
            gameState.quests.emergency = {
                ...template,
                id: Date.now(),
                completed: false,
                accepted: true, // Emergency quests auto-accept
                type: 'emergency',
                deadline: Date.now() + 86400000 // 24 hours
            };
            
            saveGame();
            updateUI();
            
            showNotification("üö® EMERGENCY QUEST DETECTED! üö®", true, true);
            sendPushNotification("Emergency Quest!", template.title);
        }

        function updateUI() {
            // Player stats
            document.getElementById('playerName').textContent = gameState.player.name;
            document.getElementById('playerLevel').textContent = gameState.player.level;
            document.getElementById('playerRank').textContent = gameState.player.rank;
            document.getElementById('playerRank').className = 'rank ' + gameState.player.rank;
            
            const jobClassName = gameState.player.jobClass !== 'none' 
                ? gameState.player.jobClass 
                : 'Nessuna Classe';
            document.getElementById('playerClass').textContent = jobClassName;
            
            document.getElementById('currentHP').textContent = gameState.player.hp;
            document.getElementById('maxHP').textContent = gameState.player.maxHP;
            document.getElementById('currentMP').textContent = gameState.player.mp;
            document.getElementById('maxMP').textContent = gameState.player.maxMP;
            
            const nextLevelEXP = gameState.player.level * 100;
            document.getElementById('currentEXP').textContent = gameState.player.exp;
            document.getElementById('nextLevelEXP').textContent = nextLevelEXP;
            
            // Update Streak Display
            const streakBonus = Math.floor(gameState.player.streak / 7) * 5;
            const streakEmoji = gameState.player.streak >= 30 ? 'üî•üî•üî•üíé' : 
                                gameState.player.streak >= 14 ? 'üî•üî•üî•' : 
                                gameState.player.streak >= 7 ? 'üî•üî•' : 'üî•';
            document.getElementById('streakDisplay').textContent = `${streakEmoji} ${gameState.player.streak} giorni`;
            document.getElementById('streakBonus').textContent = `Bonus: +${streakBonus}% EXP`;
            
            // Update bars with HP warnings
            const hpPercent = (gameState.player.hp / gameState.player.maxHP * 100);
            const hpBar = document.getElementById('hpBar');
            hpBar.style.width = hpPercent + '%';
            hpBar.classList.remove('hp-warning', 'hp-critical');
            if (hpPercent < 30 && hpPercent > 15) {
                hpBar.classList.add('hp-warning');
            } else if (hpPercent <= 15) {
                hpBar.classList.add('hp-critical');
            }
            
            document.getElementById('mpBar').style.width = (gameState.player.mp / gameState.player.maxMP * 100) + '%';
            document.getElementById('expBar').style.width = (gameState.player.exp / nextLevelEXP * 100) + '%';
            
            // Stats
            document.getElementById('skillPoints').textContent = gameState.player.skillPoints;
            document.getElementById('skillPointsDisplay').textContent = gameState.player.skillPoints;
            renderStats();
            
            // Status Effects
            renderStatusEffects();
            
            // Title
            const titleDisplay = gameState.player.activeTitle 
                ? gameState.achievements.find(a => a.id === gameState.player.activeTitle)?.title || 'Nessun Titolo'
                : 'Nessun Titolo';
            document.getElementById('activeTitle').textContent = titleDisplay;
            
            // Inventory
            document.getElementById('manaStones').textContent = gameState.inventory.manaStones;
            const crystalEl = document.getElementById('manaCrystalsDisplay');
            if (crystalEl) crystalEl.textContent = gameState.manaCrystals || 0;
            renderInventory();
            
            // Quests
            renderQuests();
            
            // Shadow Army
            renderShadowArmy();
            
            // Self Comparison
            renderSelfComparison();
            
            // Achievements
            renderAchievements();
            
            // Skills
            renderSkillTree();
            
            // Crafting
            renderCrafting();
            
            // Settings
            document.getElementById('professionInput').value = gameState.player.profession === 'none' ? '' : gameState.player.profession;
            document.getElementById('notificationsEnabled').checked = gameState.notificationsEnabled;
            
            // Penalty warning
            const allCompleted = gameState.quests.daily.every(q => q.completed);
            const penaltyWarning = document.getElementById('penaltyWarning');
            if (!allCompleted) {
                penaltyWarning.style.display = 'block';
            } else {
                penaltyWarning.style.display = 'none';
            }
            
            // Update radar chart
            drawRadarChart();
            
            // NEW FEATURES
            renderLoginBonus();
            renderThemeSelector();
            renderUnlocks();
            renderFlashQuest();
            renderWeeklyJudgment();
            checkEarlyBirdQuest();
        }

        function renderStats() {
            const container = document.getElementById('statsGrid');
            container.innerHTML = '';
            
            Object.keys(gameState.player.stats).forEach(statKey => {
                const statValue = gameState.player.stats[statKey];
                const statExp = gameState.player.statExp[statKey];
                const expNeeded = 100;
                const expPercent = (statExp / expNeeded) * 100;
                
                const div = document.createElement('div');
                div.className = 'stat-item';
                div.innerHTML = `
                    <div class="stat-header">
                        <div class="stat-name">${statNames[statKey]}</div>
                        <div class="stat-value">${statValue}</div>
                    </div>
                    <div class="stat-exp-bar">
                        <div class="stat-exp-fill" style="width: ${expPercent}%"></div>
                    </div>
                    <div class="stat-exp-label">${statExp}/${expNeeded} EXP</div>
                `;
                container.appendChild(div);
            });
        }

        function renderStatusEffects() {
            const container = document.getElementById('statusEffects');
            container.innerHTML = '';
            
            gameState.player.statusEffects.forEach(effect => {
                const div = document.createElement('div');
                div.className = `status-effect ${effect.type}`;
                div.textContent = `${effect.name} ${effect.duration ? formatTime(effect.duration - Date.now()) : ''}`;
                container.appendChild(div);
            });
        }

        function renderQuests() {
            const dailyContainer = document.getElementById('dailyQuests');
            const emergencySection = document.getElementById('emergencyQuestSection');
            const emergencyContainer = document.getElementById('emergencyQuest');
            const bossContainer = document.getElementById('bossQuest');
            
            dailyContainer.innerHTML = '';
            gameState.quests.daily.forEach(quest => {
                dailyContainer.innerHTML += createQuestHTML(quest);
            });
            
            gameState.quests.custom?.forEach(quest => {
                dailyContainer.innerHTML += createQuestHTML(quest);
            });
            
            if (gameState.quests.emergency) {
                emergencySection.style.display = 'block';
                emergencyContainer.innerHTML = createQuestHTML(gameState.quests.emergency);
            } else {
                emergencySection.style.display = 'none';
            }
            
            if (gameState.quests.boss) {
                bossContainer.innerHTML = createQuestHTML(gameState.quests.boss);
            }
        }

        function createQuestHTML(quest) {
            const timerHTML = quest.accepted && quest.deadline ? `
                <div class="quest-timer">‚è∞ <span id="timer-${quest.id}"></span></div>
            ` : '';
            
            const statusHTML = !quest.accepted ? `
                <div class="quest-status">‚ùì Non accettata</div>
            ` : '';
            
            const emergencyClass = quest.type === 'emergency' ? 'emergency' : '';
            const bossClass = quest.type === 'boss' ? 'boss' : '';
            const acceptedClass = quest.accepted ? 'accepted' : '';
            
            const acceptBtn = !quest.accepted && !quest.completed ? `
                <button class="accept-btn" onclick="acceptQuest(${quest.id}, '${quest.type || 'daily'}')">‚úÖ Accetta Quest</button>
            ` : '';
            
            const completeBtn = quest.accepted && !quest.completed ? `
                <button class="complete-btn" onclick="completeQuest(${quest.id}, '${quest.type || 'daily'}')">‚úì Completa</button>
            ` : '';

            // Double or Nothing button (only for daily/custom accepted quests)
            const isActiveBet = gameState.doubleOrNothingActive && gameState.doubleOrNothingQuestId === quest.id;
            const donBtn = quest.accepted && !quest.completed && (quest.type === 'daily' || quest.type === 'custom') ? `
                <button class="double-or-nothing-btn ${isActiveBet ? 'active-bet' : ''}" onclick="openDoubleOrNothing(${quest.id})">
                    ${isActiveBet ? 'üé≤ SCOMMESSA ATTIVA ‚Äî Completa per x2!' : 'üé≤ Doppio o Niente'}
                </button>
            ` : '';
            
            // Boss phase rendering
            let bossExtras = '';
            if (quest.type === 'boss' && quest.totalPhases) {
                const bossHPPercent = quest.bossHP || 100;
                const phaseMarkers = quest.phasesCompleted || [false, false, false];
                const phasesHTML = quest.phaseReqs ? quest.phaseReqs.map((req, i) => {
                    const cls = phaseMarkers[i] ? 'completed' : (i === quest.currentPhase ? 'unlocked' : '');
                    const icon = phaseMarkers[i] ? '‚úÖ' : (i === quest.currentPhase ? '‚öîÔ∏è' : 'üîí');
                    return `<div class="boss-phase ${cls}">
                        <div>${icon}</div>
                        <div style="font-size:10px; margin-top:3px;">${req}</div>
                        <div style="color:#ffd700; font-size:10px;">+${quest.phaseRewards ? quest.phaseRewards[i] : 0} EXP</div>
                    </div>`;
                }).join('') : '';
                
                const raidBadge = quest.isRaid ? '<span style="background:#ff0000; color:white; padding:2px 8px; border-radius:10px; font-size:10px; font-weight:bold; margin-left:8px;">üî¥ RAID</span>' : '';
                
                bossExtras = `
                    ${raidBadge}
                    <div class="boss-hp-bar">
                        <div class="boss-hp-fill" style="width:${bossHPPercent}%">${bossHPPercent}% HP</div>
                    </div>
                    <div class="boss-phases">${phasesHTML}</div>
                    ${quest.accepted && !quest.completed && quest.currentPhase < 3 ? `<button class="complete-btn" style="background: linear-gradient(135deg, #8b00ff, #ff00ff); margin-bottom: 8px;" onclick="completeBossPhase(${quest.id})">‚öîÔ∏è Completa Fase ${quest.currentPhase + 1}</button>` : ''}
                `;
            }
            
            return `
                <div class="quest-item ${quest.completed ? 'completed' : ''} ${emergencyClass} ${bossClass} ${acceptedClass}">
                    <div class="quest-header">
                        <div class="quest-title">${quest.completed ? '‚úÖ ' : ''}${quest.title}</div>
                        <div class="quest-reward">+${quest.reward} EXP</div>
                    </div>
                    <div class="quest-description">${quest.description}</div>
                    ${statusHTML}
                    ${timerHTML}
                    ${bossExtras}
                    ${quest.type !== 'boss' ? acceptBtn : ((!quest.accepted && !quest.completed) ? `<button class="accept-btn" onclick="acceptQuest(${quest.id}, 'boss')">‚úÖ Accetta Boss Fight</button>` : '')}
                    ${quest.type !== 'boss' ? completeBtn : (quest.accepted && !quest.completed && !quest.totalPhases ? `<button class="complete-btn" onclick="completeQuest(${quest.id}, 'boss')">‚úì Completa Boss</button>` : '')}
                    ${donBtn}
                </div>
            `;
        }

        function acceptQuest(questId, type) {
            let quest;
            
            if (type === 'emergency') {
                quest = gameState.quests.emergency;
            } else if (type === 'boss') {
                quest = gameState.quests.boss;
            } else if (type === 'custom') {
                quest = gameState.quests.custom?.find(q => q.id === questId);
            } else {
                quest = gameState.quests.daily.find(q => q.id === questId);
            }
            
            if (quest && !quest.accepted) {
                quest.accepted = true;
                const duration = quest.duration || 86400000; // Use quest duration or default to 24 hours
                quest.deadline = Date.now() + duration;
                showNotification(`‚úÖ Quest Accettata!`);
                saveGame();
                updateUI();
            }
        }

        function completeQuest(questId, type) {
            let quest;
            
            if (type === 'emergency') {
                quest = gameState.quests.emergency;
            } else if (type === 'boss') {
                quest = gameState.quests.boss;
            } else if (type === 'custom') {
                quest = gameState.quests.custom?.find(q => q.id === questId);
            } else {
                quest = gameState.quests.daily.find(q => q.id === questId);
            }
            
            if (quest && !quest.completed) {
                quest.completed = true;
                
                // Update streak
                const today = new Date().toDateString();
                if (gameState.player.lastQuestDate !== today) {
                    const yesterday = new Date(Date.now() - 86400000).toDateString();
                    if (gameState.player.lastQuestDate === yesterday) {
                        gameState.player.streak++;
                    } else {
                        gameState.player.streak = 1;
                    }
                    gameState.player.lastQuestDate = today;
                }
                
                let expGain = quest.reward;
                
                // Apply streak bonus
                const streakBonus = Math.floor(gameState.player.streak / 7) * 5;
                if (streakBonus > 0) {
                    expGain *= (1 + streakBonus / 100);
                }
                
                // Apply Weekend XP Boost
                const todayDate = new Date();
                const isWeekend = todayDate.getDay() === 0 || todayDate.getDay() === 6;
                if (isWeekend) {
                    expGain *= 1.5;
                    if (!quest.weekendBonusShown) {
                        showNotification("üî• Weekend XP Boost! +50% EXP!");
                        quest.weekendBonusShown = true;
                    }
                }
                
                // Apply EXP bonuses from items
                gameState.inventory.items.forEach(item => {
                    if (item.effect && quest.category) {
                        if (item.effect === 'coding' && quest.category === 'productivity') expGain *= 1.1;
                        if (item.effect === 'study' && quest.category === 'intelligence') expGain *= 1.1;
                        if (item.effect === 'fitness' && quest.category === 'physical') expGain *= 1.1;
                        if (item.effect === 'creative' && quest.category === 'creativity') expGain *= 1.1;
                    }
                });
                
                // Apply Double EXP skill if active
                const doubleExpSkill = gameState.skills.magic?.find(s => s.id === 'double_exp' && s.unlocked);
                if (doubleExpSkill && !quest.doubleExpUsed) {
                    const useDoubleExp = confirm("Vuoi usare Double EXP su questa quest? (1 volta al giorno)");
                    if (useDoubleExp) {
                        expGain *= 2;
                        quest.doubleExpUsed = true;
                        showNotification("‚≠ê Double EXP Attivato!");
                    }
                }
                
                gainEXP(Math.floor(expGain));
                
                // AUTOMATIC STAT PROGRESSION
                if (quest.category) {
                    let statType = null;
                    if (quest.category === 'physical') statType = Math.random() < 0.5 ? 'str' : 'agi';
                    if (quest.category === 'intelligence') statType = 'int';
                    if (quest.category === 'health') statType = 'vit';
                    if (quest.category === 'social') statType = 'sen';
                    if (quest.category === 'productivity') statType = 'luck';
                    if (quest.category === 'creativity') statType = 'int';
                    
                    if (statType) {
                        gameState.player.statExp[statType] += 10;
                        
                        if (gameState.player.statExp[statType] >= 100) {
                            gameState.player.stats[statType]++;
                            gameState.player.statExp[statType] -= 100;
                            
                            if (statType === 'vit') {
                                gameState.player.maxHP += 5;
                                gameState.player.hp += 5;
                            }
                            if (statType === 'int') {
                                gameState.player.maxMP += 3;
                                gameState.player.mp += 3;
                            }
                            
                            showNotification(`‚¨ÜÔ∏è ${statNames[statType]} +1!`);
                        }
                    }
                }
                
                const manaGain = Math.floor(quest.reward / 10);
                gameState.inventory.manaStones += manaGain;
                
                // Award Mana Crystals
                const crystalGain = quest.type === 'boss' ? 10 : quest.type === 'emergency' ? 5 : Math.floor(Math.random() * 3) + 1;
                gameState.manaCrystals = (gameState.manaCrystals || 0) + crystalGain;
                
                // Update radar stats
                if (quest.category) {
                    gameState.player.radarStats[quest.category] = Math.min(100, gameState.player.radarStats[quest.category] + 2);
                }
                
                showNotification(`‚úÖ Quest completata! +${Math.floor(expGain)} EXP, +${manaGain} Mana Stones, +${crystalGain} üíé`);
                
                if (type === 'emergency') {
                    gameState.quests.emergency = null;
                    checkAchievement('emergency_hero');
                }
                
                // Track weekly stats for judgment
                gameState.weeklyQuestsCompleted = (gameState.weeklyQuestsCompleted || 0) + 1;
                gameState.weeklyExpGained = (gameState.weeklyExpGained || 0) + Math.floor(expGain);
                
                // Double or Nothing resolution
                if (gameState.doubleOrNothingActive && gameState.doubleOrNothingQuestId === questId) {
                    if (Math.random() < 0.5) {
                        gainEXP(Math.floor(expGain)); // extra x2
                        showNotification('üé≤ HAI VINTO! EXP raddoppiati!', false);
                    } else {
                        gameState.player.exp = Math.max(0, gameState.player.exp - Math.floor(expGain));
                        showNotification('üé≤ HAI PERSO! EXP azzerati per questa quest!', false);
                    }
                    gameState.doubleOrNothingActive = false;
                    gameState.doubleOrNothingQuestId = null;
                }
                
                checkAchievements();
                saveGame();
                updateUI();
            }
        }

        function gainEXP(amount) {
            gameState.player.exp += amount;
            const nextLevelEXP = gameState.player.level * 100;
            
            if (gameState.player.exp >= nextLevelEXP) {
                levelUp();
            }
        }

        function levelUp() {
            gameState.player.level++;
            gameState.player.exp = 0;
            gameState.player.statPoints += 5;
            gameState.player.maxHP += 10;
            gameState.player.hp = gameState.player.maxHP;
            gameState.player.maxMP += 5;
            gameState.player.mp = gameState.player.maxMP;
            
            // Grant skill points every 5 levels
            if (gameState.player.level % 5 === 0) {
                gameState.player.skillPoints += 1;
            }
            
            // Update rank and offer job class selection
            updateRank();
            
            showNotification(`üéâ LEVEL UP! Sei ora livello ${gameState.player.level}! +5 Stat Points!`);
            sendPushNotification("Level Up!", `Congratulazioni! Ora sei livello ${gameState.player.level}`);
        }

        function updateRank() {
            const oldRank = gameState.player.rank;
            
            if (gameState.player.level >= 100) gameState.player.rank = 'NATIONAL';
            else if (gameState.player.level >= 50) gameState.player.rank = 'S';
            else if (gameState.player.level >= 40) gameState.player.rank = 'A';
            else if (gameState.player.level >= 30) gameState.player.rank = 'B';
            else if (gameState.player.level >= 20) gameState.player.rank = 'C';
            else if (gameState.player.level >= 10) gameState.player.rank = 'D';
            
            if (oldRank !== gameState.player.rank) {
                showNotification(`üéä RANK UP! Ora sei Rank ${gameState.player.rank}!`);
                
                // Offer job class selection at C and A rank
                if (gameState.player.rank === 'C' && gameState.player.jobClass === 'none') {
                    setTimeout(() => offerJobClass('C'), 1000);
                } else if (gameState.player.rank === 'A' && !gameState.player.jobClass.includes('Shadow') && !gameState.player.jobClass.includes('Berserker') && !gameState.player.jobClass.includes('Sage')) {
                    setTimeout(() => offerJobClass('A'), 1000);
                }
            }
        }

        function offerJobClass(rank) {
            const options = jobClasses[rank].options;
            const choice = prompt(`üéä HAI RAGGIUNTO RANK ${rank}!\n\nScegli la tua Job Class:\n\n1. ${options[0]}\n2. ${options[1]}\n3. ${options[2]}\n\nInserisci 1, 2 o 3:`);
            
            if (choice === '1' || choice === '2' || choice === '3') {
                const selectedClass = options[parseInt(choice) - 1];
                gameState.player.jobClass = selectedClass;
                showNotification(`‚öîÔ∏è Sei diventato un ${selectedClass}!`);
                saveGame();
                updateUI();
            }
        }

        function takeDamage(amount, reason) {
            gameState.player.hp = Math.max(0, gameState.player.hp - amount);
            
            showNotification(`‚ö†Ô∏è -${amount} HP: ${reason}`, false, true);
            
            if (gameState.player.hp === 0) {
                triggerDeath();
            }
            
            saveGame();
            updateUI();
        }

        function triggerDeath() {
            // Check Immortal skill
            const immortalSkill = gameState.skills.combat?.find(s => s.id === 'immortal' && s.unlocked);
            if (immortalSkill && !immortalSkill.used) {
                immortalSkill.used = true;
                gameState.player.hp = 1;
                showNotification("üíÄ Immortal Skill Attivato! Sei sopravvissuto con 1 HP!");
                saveGame();
                updateUI();
                return;
            }
            
            // Apply death penalties
            gameState.player.exp = 0;
            gameState.inventory.manaStones = Math.floor(gameState.inventory.manaStones * 0.5);
            
            // Reduce shadow army levels
            gameState.shadowArmy.forEach(shadow => {
                shadow.level = Math.max(1, shadow.level - 1);
                shadow.streak = Math.max(0, shadow.streak - 7);
            });
            
            // Set death timer
            gameState.player.deathTime = Date.now() + 86400000; // 24 hours
            
            showNotification("üíÄ SEI MORTO! Resurrezione tra 24 ore...", false, true);
            sendPushNotification("üíÄ Morte", "Sei morto! L'app sar√† bloccata per 24 ore.");
            
            checkAchievement('survivor');
            
            saveGame();
            updateUI();
        }

        function checkDeath() {
            if (gameState.player.deathTime) {
                const timeLeft = gameState.player.deathTime - Date.now();
                
                if (timeLeft <= 0) {
                    // Resurrection
                    gameState.player.deathTime = null;
                    gameState.player.hp = Math.floor(gameState.player.maxHP * 0.5);
                    document.getElementById('deathScreen').classList.remove('active');
                    showNotification("‚ú® Sei risorto! Benvenuto indietro, Hunter!");
                    saveGame();
                    updateUI();
                } else {
                    // Update death timer
                    document.getElementById('deathScreen').classList.add('active');
                    document.getElementById('deathTimer').textContent = formatTime(timeLeft);
                }
            } else {
                document.getElementById('deathScreen').classList.remove('active');
            }
        }

        function updateTimers() {
            // Update daily quest timers
            gameState.quests.daily.forEach(quest => {
                if (quest.accepted && quest.deadline && !quest.completed) {
                    const timeLeft = quest.deadline - Date.now();
                    const timerEl = document.getElementById(`timer-${quest.id}`);
                    
                    if (timerEl) {
                        if (timeLeft <= 0) {
                            takeDamage(quest.penalty || 10, `Quest "${quest.title}" scaduta!`);
                            quest.accepted = false;
                            quest.deadline = null;
                            saveGame();
                            updateUI();
                        } else {
                            timerEl.textContent = formatTime(timeLeft);
                        }
                    }
                }
            });
            
            // Update custom quest timers
            (gameState.quests.custom || []).forEach(quest => {
                if (quest.accepted && quest.deadline && !quest.completed) {
                    const timeLeft = quest.deadline - Date.now();
                    const timerEl = document.getElementById(`timer-${quest.id}`);
                    
                    if (timerEl) {
                        if (timeLeft <= 0) {
                            takeDamage(quest.penalty || 10, `Quest "${quest.title}" scaduta!`);
                            quest.accepted = false;
                            quest.deadline = null;
                            saveGame();
                            updateUI();
                        } else {
                            timerEl.textContent = formatTime(timeLeft);
                        }
                    }
                }
            });
            
            // Update emergency quest timer
            if (gameState.quests.emergency && gameState.quests.emergency.deadline) {
                const timeLeft = gameState.quests.emergency.deadline - Date.now();
                const timerEl = document.getElementById(`timer-${gameState.quests.emergency.id}`);
                
                if (timerEl) {
                    if (timeLeft <= 0) {
                        takeDamage(20, "Emergency Quest Fallita!");
                        gameState.quests.emergency = null;
                        saveGame();
                        updateUI();
                    } else {
                        timerEl.textContent = formatTime(timeLeft);
                    }
                }
            }
            
            // Update boss quest timer
            if (gameState.quests.boss && gameState.quests.boss.accepted && gameState.quests.boss.deadline) {
                const timeLeft = gameState.quests.boss.deadline - Date.now();
                const timerEl = document.getElementById(`timer-${gameState.quests.boss.id}`);
                
                if (timerEl) {
                    if (timeLeft <= 0) {
                        takeDamage(gameState.quests.boss.penalty || 30, "Boss Fight Fallita!");
                        gameState.quests.boss.accepted = false;
                        gameState.quests.boss.deadline = null;
                        saveGame();
                        updateUI();
                    } else {
                        timerEl.textContent = formatTime(timeLeft);
                    }
                }
            }
            
            // Update status effect timers
            gameState.player.statusEffects = gameState.player.statusEffects.filter(effect => {
                if (effect.duration) {
                    return effect.duration > Date.now();
                }
                return true;
            });
        }

        function formatTime(ms) {
            const hours = Math.floor(ms / 3600000);
            const minutes = Math.floor((ms % 3600000) / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function updateShadowArmy(quest) {
            let shadow = gameState.shadowArmy.find(s => s.questTitle === quest.title);
            
            if (shadow) {
                shadow.streak++;
                if (shadow.streak >= 30 && shadow.level < 3) {
                    shadow.level++;
                    showNotification(`üë• Shadow Army Level Up! ${shadow.name} √® ora livello ${shadow.level}!`);
                }
            } else if (quest.completed) {
                gameState.shadowArmy.push({
                    name: quest.title,
                    questTitle: quest.title,
                    level: 1,
                    streak: 1,
                    bonus: calculateShadowBonus(quest)
                });
            }
            
            checkAchievement('shadow_master');
        }

        function breakShadowStreak(quest) {
            const shadow = gameState.shadowArmy.find(s => s.questTitle === quest.title);
            if (shadow) {
                shadow.streak = Math.max(0, shadow.streak - 3);
                if (shadow.streak === 0) {
                    gameState.shadowArmy = gameState.shadowArmy.filter(s => s !== shadow);
                    showNotification(`üë• Shadow persa: ${shadow.name}`);
                }
            }
        }

        function calculateShadowBonus(quest) {
            const baseBonus = Math.floor(quest.reward / 10);
            return `+${baseBonus} ${quest.category || 'general'} auto`;
        }

        function renderSelfComparison() {
            const container = document.getElementById('selfComparison');
            // Count both daily and custom completed quests
            const dailyCompleted = gameState.quests.daily.filter(q => q.completed).length;
            const customCompleted = (gameState.quests.custom || []).filter(q => q.completed).length;
            const todayQuests = dailyCompleted + customCompleted;
            const yesterdayQuests = gameState.history.yesterday.quests || 0;
            
            container.innerHTML = `
                <div class="comparison-box">
                    <div class="comparison-title">‚öîÔ∏è OGGI vs IERI</div>
                    <div class="comparison-row">
                        <div class="comparison-label">Quest Completate</div>
                        <div class="comparison-values">
                            <span class="comparison-old">Ieri: ${yesterdayQuests}</span>
                            <span class="comparison-new ${todayQuests >= yesterdayQuests ? 'winning' : 'losing'}">Oggi: ${todayQuests}</span>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 15px; font-size: 18px; color: ${todayQuests >= yesterdayQuests ? '#4ecdc4' : '#ff6b6b'};">
                        ${todayQuests > yesterdayQuests ? '‚úÖ DOMINIO TOTALE!' : todayQuests === yesterdayQuests ? '‚öñÔ∏è PAREGGIO' : '‚ö†Ô∏è Stai perdendo! Fai meglio!'}
                    </div>
                </div>
            `;
        }

        function renderShadowArmy() {
            const container = document.getElementById('shadowArmyList');
            
            if (gameState.shadowArmy.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">Completa quest per 30 giorni di fila per ottenere Shadow Army!</div>';
                return;
            }
            
            container.innerHTML = '';
            gameState.shadowArmy.forEach(shadow => {
                const div = document.createElement('div');
                div.className = 'shadow-item';
                div.innerHTML = `
                    <div class="shadow-name">Lv.${shadow.level} ${shadow.name}</div>
                    <div class="shadow-streak">üî• Streak: ${shadow.streak} giorni</div>
                    <div class="shadow-bonus">Bonus: ${shadow.bonus}</div>
                `;
                container.appendChild(div);
            });
        }

        function checkAchievements() {
            // Iron Will
            const longestStreak = Math.max(...(gameState.shadowArmy.map(s => s.streak) || [0]));
            if (longestStreak >= 30) checkAchievement('iron_will');
            
            // Shadow Master
            if (gameState.shadowArmy.length >= 10) checkAchievement('shadow_master');
            
            // Count quest types
            const physicalCount = gameState.shadowArmy.filter(s => s.bonus.includes('physical')).length;
            const intellectualCount = gameState.shadowArmy.filter(s => s.bonus.includes('intelligence')).length;
            
            if (physicalCount >= 100) checkAchievement('warrior');
            if (intellectualCount >= 100) checkAchievement('scholar');
        }

        function checkAchievement(achievementId) {
            const achievement = gameState.achievements.find(a => a.id === achievementId);
            if (achievement && !achievement.unlocked) {
                achievement.unlocked = true;
                showNotification(`üèÜ Achievement Sbloccato: ${achievement.title}!`);
                applyAchievementBonus(achievement);
                saveGame();
                updateUI();
            }
        }

        function applyAchievementBonus(achievement) {
            switch(achievement.id) {
                case 'iron_will':
                    gameState.player.maxHP += 10;
                    gameState.player.hp += 10;
                    break;
                case 'shadow_master':
                    gameState.player.maxMP += 20;
                    gameState.player.mp += 20;
                    break;
                case 'scholar':
                    gameState.player.stats.int += 15;
                    break;
                case 'warrior':
                    gameState.player.stats.str += 15;
                    break;
                case 'emergency_hero':
                    gameState.player.maxHP += 100;
                    gameState.player.hp += 100;
                    break;
            }
        }

        function renderAchievements() {
            const container = document.getElementById('achievementsList');
            container.innerHTML = '';
            
            gameState.achievements.forEach(achievement => {
                const div = document.createElement('div');
                div.className = `achievement-item ${achievement.unlocked ? 'unlocked' : ''}`;
                div.innerHTML = `
                    <div class="achievement-icon">${achievement.icon}</div>
                    <div class="achievement-title">${achievement.title}</div>
                    <div class="achievement-desc">${achievement.desc}</div>
                `;
                div.onclick = () => {
                    if (achievement.unlocked) {
                        const setActive = confirm(`Vuoi impostare "${achievement.title}" come titolo attivo?\nBonus: ${achievement.bonus}`);
                        if (setActive) {
                            gameState.player.activeTitle = achievement.id;
                            saveGame();
                            updateUI();
                        }
                    }
                };
                container.appendChild(div);
            });
        }

        function renderSkillTree() {
            const container = document.getElementById('skillTree');
            container.innerHTML = '';
            
            ['combat', 'magic', 'support'].forEach(branch => {
                const branchDiv = document.createElement('div');
                branchDiv.className = 'skill-branch';
                
                const titles = { combat: '‚öîÔ∏è Combat', magic: '‚ú® Magic', support: 'üõ°Ô∏è Support' };
                branchDiv.innerHTML = `<div class="skill-branch-title">${titles[branch]}</div><div class="skill-list" id="${branch}-skills"></div>`;
                
                container.appendChild(branchDiv);
                
                const skillList = document.getElementById(`${branch}-skills`);
                gameState.skills[branch].forEach(skill => {
                    const canUnlock = !skill.requires || gameState.skills[branch].find(s => s.id === skill.requires)?.unlocked;
                    const isLocked = !skill.unlocked && (!canUnlock || gameState.player.skillPoints < skill.cost);
                    
                    const div = document.createElement('div');
                    div.className = `skill-item ${skill.unlocked ? 'unlocked' : ''} ${isLocked ? 'locked' : ''}`;
                    div.innerHTML = `
                        <div class="skill-name">${skill.name} ${skill.unlocked ? '‚úÖ' : ''}</div>
                        <div class="skill-desc">${skill.desc}</div>
                        <div class="skill-cost">Costo: ${skill.cost} SP ${skill.requires ? `| Richiede: ${skill.requires}` : ''}</div>
                    `;
                    
                    div.onclick = () => {
                        if (!skill.unlocked && canUnlock && gameState.player.skillPoints >= skill.cost) {
                            const confirm = window.confirm(`Sbloccare ${skill.name} per ${skill.cost} Skill Points?`);
                            if (confirm) {
                                skill.unlocked = true;
                                gameState.player.skillPoints -= skill.cost;
                                showNotification(`‚ú® Skill Sbloccata: ${skill.name}!`);
                                saveGame();
                                updateUI();
                            }
                        }
                    };
                    
                    skillList.appendChild(div);
                });
            });
        }

        function renderInventory() {
            const grid = document.getElementById('inventoryGrid');
            
            if (gameState.inventory.items.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; color: #999; padding: 40px;">
                        Nessun oggetto nell'inventario.
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = '';
            gameState.inventory.items.forEach((item, index) => {
                const slot = document.createElement('div');
                slot.className = `inventory-slot ${item.effect ? 'has-effect' : ''}`;
                slot.innerHTML = `
                    <div class="item-icon">${item.icon}</div>
                    <div style="font-size: 10px; text-align: center; margin-top: 5px;">${item.name}</div>
                    <div class="item-count">x${item.quantity}</div>
                    ${item.effect ? `<div class="item-effect">‚ú®</div>` : ''}
                `;
                slot.onclick = () => showItemOptions(index);
                grid.appendChild(slot);
            });
        }

        function applyItemEffects() {
            // Apply passive effects from items
            gameState.inventory.items.forEach(item => {
                if (item.effect === 'hp_regen') {
                    // Check if already applied today
                    if (!item.lastRegenDate || item.lastRegenDate !== new Date().toDateString()) {
                        gameState.player.hp = Math.min(gameState.player.maxHP, gameState.player.hp + 5);
                        item.lastRegenDate = new Date().toDateString();
                    }
                }
                if (item.effect === 'mp_regen') {
                    if (!item.lastRegenDate || item.lastRegenDate !== new Date().toDateString()) {
                        gameState.player.mp = Math.min(gameState.player.maxMP, gameState.player.mp + 3);
                        item.lastRegenDate = new Date().toDateString();
                    }
                }
            });
        }

        function showAddItemModal() {
            document.getElementById('addItemModal').classList.add('show');
            document.getElementById('itemIcon').value = 'üì¶';
            document.getElementById('itemName').value = '';
            document.getElementById('itemQuantity').value = '1';
            document.getElementById('itemEffect').value = '';
        }

        function closeAddItemModal() {
            document.getElementById('addItemModal').classList.remove('show');
        }

        function addItemToInventory() {
            const icon = document.getElementById('itemIcon').value || 'üì¶';
            const name = document.getElementById('itemName').value.trim();
            const quantity = parseInt(document.getElementById('itemQuantity').value) || 1;
            const effect = document.getElementById('itemEffect').value;
            
            if (!name) {
                showNotification('‚ö†Ô∏è Inserisci un nome per l\'oggetto!');
                return;
            }
            
            const existingItem = gameState.inventory.items.find(item => item.name === name);
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                gameState.inventory.items.push({
                    icon, name, quantity, effect: effect || null
                });
            }
            
            saveGame();
            updateUI();
            closeAddItemModal();
            showNotification(`‚úÖ ${icon} ${name} aggiunto all'inventario!`);
        }

        function showItemOptions(index) {
            const item = gameState.inventory.items[index];
            const effectText = item.effect ? `\nEffetto: ${item.effect}` : '';
            const action = confirm(`${item.icon} ${item.name} (x${item.quantity})${effectText}\n\nVuoi rimuovere questo oggetto?`);
            
            if (action) {
                gameState.inventory.items.splice(index, 1);
                saveGame();
                updateUI();
                showNotification('üóëÔ∏è Oggetto rimosso dall\'inventario');
            }
        }

        function renderCrafting() {
            const grid = document.getElementById('craftingGrid');
            grid.innerHTML = '';
            
            craftingRecipes.forEach(recipe => {
                if (!recipe.unlocked) {
                    const masterCrafter = gameState.skills.support?.find(s => s.id === 'master_crafter' && s.unlocked);
                    if (!masterCrafter) return;
                    recipe.unlocked = true;
                }
                
                const canCraft = recipe.materials.every(mat => {
                    if (mat.name === 'Mana Stones') {
                        return gameState.inventory.manaStones >= mat.count;
                    }
                    const item = gameState.inventory.items.find(i => i.name === mat.name);
                    return item && item.quantity >= mat.count;
                });
                
                const div = document.createElement('div');
                div.className = `recipe-item ${recipe.unlocked ? 'unlocked' : ''}`;
                div.innerHTML = `
                    <div class="recipe-name">${recipe.name}</div>
                    <div class="recipe-materials">
                        ${recipe.materials.map(m => `${m.name} x${m.count}`).join(', ')}
                    </div>
                    <button class="craft-btn" ${canCraft ? '' : 'disabled'} onclick="craft('${recipe.id}')">
                        Craft
                    </button>
                `;
                grid.appendChild(div);
            });
        }

        function craft(recipeId) {
            const recipe = craftingRecipes.find(r => r.id === recipeId);
            if (!recipe) return;
            
            // Check materials
            const canCraft = recipe.materials.every(mat => {
                if (mat.name === 'Mana Stones') {
                    return gameState.inventory.manaStones >= mat.count;
                }
                const item = gameState.inventory.items.find(i => i.name === mat.name);
                return item && item.quantity >= mat.count;
            });
            
            if (!canCraft) {
                showNotification('‚ö†Ô∏è Materiali insufficienti!');
                return;
            }
            
            // Consume materials
            recipe.materials.forEach(mat => {
                if (mat.name === 'Mana Stones') {
                    gameState.inventory.manaStones -= mat.count;
                } else {
                    const item = gameState.inventory.items.find(i => i.name === mat.name);
                    item.quantity -= mat.count;
                    if (item.quantity <= 0) {
                        gameState.inventory.items = gameState.inventory.items.filter(i => i !== item);
                    }
                }
            });
            
            // Apply result
            if (recipe.result.type === 'consumable') {
                if (recipe.result.effect === 'restore_hp') {
                    gameState.player.hp = Math.min(gameState.player.maxHP, gameState.player.hp + recipe.result.value);
                    showNotification(`‚úÖ Craftato! +${recipe.result.value} HP`);
                }
            } else if (recipe.result.type === 'buff') {
                gameState.player.statusEffects.push({
                    name: recipe.name,
                    type: 'buff',
                    effect: recipe.result.effect,
                    value: recipe.result.value,
                    duration: Date.now() + recipe.result.duration
                });
                showNotification(`‚úÖ Craftato! ${recipe.name} attivo!`);
            }
            
            saveGame();
            updateUI();
        }

        function showCreateQuestModal() {
            document.getElementById('createQuestModal').classList.add('show');
            document.getElementById('customQuestTitle').value = '';
            document.getElementById('customQuestDesc').value = '';
            document.getElementById('customQuestDifficulty').value = 'medium';
        }

        function closeCreateQuestModal() {
            document.getElementById('createQuestModal').classList.remove('show');
        }

        function createCustomQuest() {
            const title = document.getElementById('customQuestTitle').value.trim();
            const desc = document.getElementById('customQuestDesc').value.trim();
            const difficulty = document.getElementById('customQuestDifficulty').value;
            
            if (!title || !desc) {
                showNotification('‚ö†Ô∏è Compila tutti i campi!');
                return;
            }
            
            const rewardMap = {
                easy: 30 + Math.floor(Math.random() * 10),
                medium: 50 + Math.floor(Math.random() * 20),
                hard: 80 + Math.floor(Math.random() * 20),
                extreme: 120 + Math.floor(Math.random() * 30)
            };
            
            const reward = rewardMap[difficulty];
            const penalty = Math.floor(reward / 5); // Penalty is 20% of reward
            
            if (!gameState.quests.custom) gameState.quests.custom = [];
            
            gameState.quests.custom.push({
                id: Date.now(),
                title,
                description: desc,
                reward,
                penalty,
                completed: false,
                type: 'custom',
                category: 'productivity'
            });
            
            saveGame();
            updateUI();
            closeCreateQuestModal();
            showNotification(`‚úÖ Quest creata! Reward: ${reward} EXP, Penalit√†: -${penalty} HP`);
        }

        function drawRadarChart() {
            const canvas = document.getElementById('radarChart');
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = 120;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const stats = [
                { label: 'Fisico', value: gameState.player.radarStats.physical },
                { label: 'Intel', value: gameState.player.radarStats.intelligence },
                { label: 'Salute', value: gameState.player.radarStats.health },
                { label: 'Sociale', value: gameState.player.radarStats.social },
                { label: 'Produttivit√†', value: gameState.player.radarStats.productivity },
                { label: 'Creativit√†', value: gameState.player.radarStats.creativity }
            ];
            
            const angleStep = (Math.PI * 2) / stats.length;
            
            // Draw grid
            ctx.strokeStyle = 'rgba(106, 90, 205, 0.3)';
            ctx.lineWidth = 1;
            for (let i = 1; i <= 5; i++) {
                ctx.beginPath();
                const r = (radius / 5) * i;
                for (let j = 0; j <= stats.length; j++) {
                    const angle = angleStep * j - Math.PI / 2;
                    const x = centerX + Math.cos(angle) * r;
                    const y = centerY + Math.sin(angle) * r;
                    if (j === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.closePath();
                ctx.stroke();
            }
            
            // Draw axes
            ctx.strokeStyle = 'rgba(106, 90, 205, 0.5)';
            stats.forEach((stat, i) => {
                const angle = angleStep * i - Math.PI / 2;
                const x = centerX + Math.cos(angle) * radius;
                const y = centerY + Math.sin(angle) * radius;
                
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.lineTo(x, y);
                ctx.stroke();
                
                // Draw labels
                const labelX = centerX + Math.cos(angle) * (radius + 20);
                const labelY = centerY + Math.sin(angle) * (radius + 20);
                ctx.fillStyle = '#ffd700';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(stat.label, labelX, labelY);
            });
            
            // Draw data
            ctx.fillStyle = 'rgba(138, 43, 226, 0.3)';
            ctx.strokeStyle = 'rgba(138, 43, 226, 0.8)';
            ctx.lineWidth = 2;
            
            ctx.beginPath();
            stats.forEach((stat, i) => {
                const angle = angleStep * i - Math.PI / 2;
                const value = (stat.value / 100) * radius;
                const x = centerX + Math.cos(angle) * value;
                const y = centerY + Math.sin(angle) * value;
                
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
        }

        function showNotification(message, persistent = false, isEmergency = false) {
            const notif = document.getElementById('notification');
            notif.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; gap: 10px;">
                    <div style="flex: 1;">${message}</div>
                    <button onclick="closeNotification()" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">‚úï</button>
                </div>
            `;
            notif.classList.remove('emergency');
            
            if (isEmergency) {
                notif.classList.add('emergency');
            }
            
            notif.classList.add('show');
            
            if (!persistent) {
                setTimeout(() => {
                    notif.classList.remove('show');
                }, 3000);
            }
        }

        function closeNotification() {
            const notif = document.getElementById('notification');
            notif.classList.remove('show');
        }

        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        function sendPushNotification(title, body) {
            if (!gameState.notificationsEnabled) return;
            
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, {
                    body: body,
                    icon: '‚öîÔ∏è',
                    badge: '‚öîÔ∏è'
                });
            }
        }

        function toggleNotifications() {
            gameState.notificationsEnabled = document.getElementById('notificationsEnabled').checked;
            
            if (gameState.notificationsEnabled && 'Notification' in window) {
                if (Notification.permission === 'default') {
                    Notification.requestPermission().then(permission => {
                        if (permission !== 'granted') {
                            gameState.notificationsEnabled = false;
                            document.getElementById('notificationsEnabled').checked = false;
                            showNotification('‚ö†Ô∏è Permesso notifiche negato!');
                        }
                    });
                } else if (Notification.permission === 'denied') {
                    gameState.notificationsEnabled = false;
                    document.getElementById('notificationsEnabled').checked = false;
                    showNotification('‚ö†Ô∏è Permesso notifiche negato! Abilitale nelle impostazioni del browser.');
                }
            }
            
            saveGame();
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById('tab-' + tab).classList.add('active');
            
            const navButtons = document.querySelectorAll('.nav-btn');
            const buttonIndex = {'player': 0, 'quests': 1, 'progress': 2, 'inventory': 3, 'settings': 4};
            if (buttonIndex[tab] !== undefined) {
                navButtons[buttonIndex[tab]].classList.add('active');
            }
        }

        function saveProfession() {
            const profession = document.getElementById('professionInput').value.trim();
            gameState.player.profession = profession || 'none';
            gameState.quests.daily = generateDailyQuests();
            saveGame();
            updateUI();
            showNotification('‚úÖ Professione aggiornata! Le quest sono state rigenerate.');
        }

        function saveName() {
            const name = document.getElementById('nameInput').value.trim();
            if (name) {
                gameState.player.name = name;
                saveGame();
                updateUI();
                showNotification('‚úÖ Nome salvato!');
            }
        }

        function resetProgress() {
            if (confirm('Sei sicuro di voler resettare tutto il progresso?')) {
                localStorage.removeItem('realLifeLevelingComplete');
                location.reload();
            }
        }

        // ============================================================
        // FEATURE #4: DAILY LOGIN BONUS
        // ============================================================
        function checkDailyLoginBonus() {
            const today = new Date().toDateString();
            const lastLogin = gameState.lastLoginDate;
            
            if (lastLogin === today) {
                // Already logged in today
                return;
            }
            
            const yesterday = new Date(Date.now() - 86400000).toDateString();
            if (lastLogin === yesterday) {
                gameState.loginStreak = (gameState.loginStreak || 0) + 1;
            } else if (lastLogin !== today) {
                gameState.loginStreak = 1; // Reset streak
            }
            
            // Cap streak display at 7, cycle
            if (gameState.loginStreak > 7) gameState.loginStreak = 1;
            
            gameState.lastLoginDate = today;
            gameState.loginBonusClaimed = false;
            saveGame();
        }

        function claimLoginBonus() {
            if (gameState.loginBonusClaimed) return;
            
            const streak = gameState.loginStreak || 1;
            const rewardIndex = Math.min(streak - 1, 6);
            const reward = LOGIN_REWARDS[rewardIndex];
            
            gainEXP(reward.exp);
            gameState.manaCrystals = (gameState.manaCrystals || 0) + (reward.crystals || 2);
            gameState.loginBonusClaimed = true;
            
            // Award daily crystals
            gameState.manaCrystals += 2;
            
            saveGame();
            
            if (reward.mysteryBox) {
                gameState.pendingMysteryBox = true;
                saveGame();
                showNotification(`üéÅ Giorno 7! +${reward.exp} EXP +${reward.crystals} üíé + MYSTERY BOX!`, true);
                setTimeout(() => openMysteryBox(), 1500);
            } else {
                showNotification(`üéÅ Login Day ${streak}! +${reward.exp} EXP +${reward.crystals} üíé`);
            }
            
            updateUI();
        }

        function renderLoginBonus() {
            const grid = document.getElementById('loginDaysGrid');
            const btn = document.getElementById('claimLoginBtn');
            const streakText = document.getElementById('loginStreakText');
            if (!grid) return;
            
            const streak = gameState.loginStreak || 0;
            streakText.textContent = `Login streak: ${streak} giorni`;
            
            grid.innerHTML = LOGIN_REWARDS.map((r, i) => {
                const dayNum = i + 1;
                let cls = 'future-day';
                let icon = r.mysteryBox ? 'üéÅ' : '‚≠ê';
                
                if (dayNum < streak) cls = 'claimed';
                else if (dayNum === streak) cls = 'today-day';
                
                return `<div class="login-day ${cls}">
                    <div>${icon}</div>
                    <div style="font-weight:bold; font-size:10px;">D${dayNum}</div>
                    <div class="day-reward">+${r.exp} EXP</div>
                    ${r.mysteryBox ? '<div style="font-size:8px; color:#ff9500;">üì¶BOX</div>' : ''}
                </div>`;
            }).join('');
            
            // Show claim button if today's bonus not claimed
            const today = new Date().toDateString();
            if (gameState.lastLoginDate === today && !gameState.loginBonusClaimed && streak > 0) {
                btn.style.display = 'block';
            } else {
                btn.style.display = 'none';
            }
        }

        // ============================================================
        // BOSS PHASE SYSTEM
        // ============================================================
        function completeBossPhase(questId) {
            const boss = gameState.quests.boss;
            if (!boss || boss.id !== questId || boss.completed) return;
            
            const phase = boss.currentPhase;
            if (phase >= 3) return;
            
            boss.phasesCompleted[phase] = true;
            const phaseReward = boss.phaseRewards ? boss.phaseRewards[phase] : 100;
            gainEXP(phaseReward);
            gameState.manaCrystals = (gameState.manaCrystals || 0) + 3;
            
            // Reduce boss HP by 33% per phase
            boss.bossHP = Math.max(0, 100 - ((phase + 1) * 33));
            boss.currentPhase = phase + 1;
            
            if (phase === 2) {
                // All 3 phases done = boss defeated!
                boss.completed = true;
                const totalReward = boss.reward || 500;
                gainEXP(totalReward);
                gameState.manaCrystals = (gameState.manaCrystals || 0) + 10;
                
                // Add title reward
                if (boss.title_reward) {
                    if (!gameState.customTitles) gameState.customTitles = [];
                    if (!gameState.customTitles.includes(boss.title_reward)) {
                        gameState.customTitles.push(boss.title_reward);
                    }
                }
                
                const raidMsg = boss.isRaid ? ' üåü RAID COMPLETATO!' : '';
                showNotification(`üíÄ BOSS SCONFITTO!${raidMsg} +${totalReward} EXP +Titolo "${boss.title_reward}"`, true);
            } else {
                showNotification(`‚öîÔ∏è Fase ${phase + 1} completata! +${phaseReward} EXP. Prossima fase sbloccata!`);
            }
            
            saveGame();
            updateUI();
        }

        // ============================================================
        // FEATURE #6: THEME CUSTOMIZATION & UNLOCKS
        // ============================================================
        function applyTheme(themeId) {
            document.body.className = document.body.className.replace(/theme-\w+/g, '');
            if (themeId && themeId !== 'default') {
                document.body.classList.add('theme-' + themeId);
            }
        }

        function setTheme(themeId) {
            const theme = THEMES.find(t => t.id === themeId);
            if (!theme) return;
            if (gameState.player.level < theme.reqLevel) {
                showNotification(`üîí Richiede livello ${theme.reqLevel}!`);
                return;
            }
            gameState.selectedTheme = themeId;
            applyTheme(themeId);
            saveGame();
            renderThemeSelector();
        }

        function renderThemeSelector() {
            const el = document.getElementById('themeSelector');
            if (!el) return;
            el.innerHTML = THEMES.map(t => {
                const locked = gameState.player.level < t.reqLevel;
                const active = gameState.selectedTheme === t.id;
                return `<button class="theme-btn ${active ? 'active' : ''} ${locked ? '' : ''}" 
                    onclick="setTheme('${t.id}')" 
                    style="${locked ? 'opacity:0.4;' : ''}; background:${t.colors};">
                    ${t.name} ${locked ? 'üîí Lv.' + t.reqLevel : ''}
                </button>`;
            }).join('');
        }

        function renderUnlocks() {
            const el = document.getElementById('unlocksGrid');
            if (!el) return;
            const RANK_ORDER = ['E','D','C','B','A','S','NATIONAL'];
            el.innerHTML = PROGRESSIVE_UNLOCKS.map(u => {
                const levelOk = gameState.player.level >= u.reqLevel;
                const rankOk = !u.reqRank || RANK_ORDER.indexOf(gameState.player.rank) >= RANK_ORDER.indexOf(u.reqRank);
                const unlocked = levelOk && rankOk;
                return `<div class="unlock-item ${unlocked ? 'available' : 'locked'}">
                    <div class="unlock-icon">${u.icon}</div>
                    <div class="unlock-name">${u.name}</div>
                    <div class="unlock-req">${unlocked ? '‚úÖ Sbloccato' : u.req}</div>
                </div>`;
            }).join('');
        }

        // ============================================================
        // FEATURE #9: GACHA / LOOT SYSTEM
        // ============================================================
        function unlockTitle(titleStr) {
            if (!gameState.customTitles) gameState.customTitles = [];
            if (!gameState.customTitles.includes(titleStr)) {
                gameState.customTitles.push(titleStr);
            }
        }

        function openGachaBox(boxType) {
            const box = GACHA_BOXES[boxType];
            if (!box) return;
            
            if ((gameState.manaCrystals || 0) < box.cost) {
                showNotification(`‚ùå Cristalli insufficienti! Servono ${box.cost} üíé`);
                return;
            }
            
            gameState.manaCrystals -= box.cost;
            
            // Weighted random selection
            const totalWeight = box.pools.reduce((s, p) => s + p.weight, 0);
            let rand = Math.random() * totalWeight;
            let result = box.pools[box.pools.length - 1];
            for (const pool of box.pools) {
                rand -= pool.weight;
                if (rand <= 0) { result = pool; break; }
            }
            
            // Apply reward
            result.action();
            saveGame();
            
            // Show result modal
            const modal = document.getElementById('gachaResultModal');
            document.getElementById('gachaResultIcon').textContent = result.icon;
            document.getElementById('gachaResultTitle').textContent = result.name;
            document.getElementById('gachaResultDesc').textContent = result.desc;
            modal.classList.add('show');
            
            updateUI();
        }

        // Mystery Box (Day 7 reward)
        function openMysteryBox() {
            const modal = document.getElementById('mysteryBoxModal');
            const anim = document.getElementById('mysteryBoxAnim');
            const resultDiv = document.getElementById('mysteryBoxResult');
            const btn = document.getElementById('mysteryBoxBtn');
            
            anim.style.display = 'inline-block';
            resultDiv.style.display = 'none';
            btn.style.display = 'block';
            btn.textContent = 'üé≤ Apri!';
            btn.onclick = revealMysteryBox;
            modal.classList.add('show');
        }

        function revealMysteryBox() {
            const rand = Math.random();
            let reward;
            
            if (rand < 0.60) {
                const expBonus = 500 + Math.floor(Math.random() * 501);
                gainEXP(expBonus);
                reward = { icon: '‚≠ê', title: `+${expBonus} EXP BONUS!`, desc: 'Hai ottenuto un\'esplosione di esperienza!' };
            } else if (rand < 0.85) {
                const titles = ['üåü "Rising Star"', '‚ö° "The Unstoppable"', 'üî• "Week Champion"'];
                const t = titles[Math.floor(Math.random() * titles.length)];
                unlockTitle(t);
                reward = { icon: 'üìú', title: `Titolo Raro: ${t}`, desc: 'Hai sbloccato un titolo speciale!' };
            } else if (rand < 0.95) {
                reward = { icon: 'üéØ', title: 'Quest Slot Extra!', desc: '+1 slot per le tue quest personalizzate!' };
                showNotification('üéØ Quest slot extra sbloccato da Mystery Box!');
            } else {
                Object.keys(gameState.player.stats).forEach(k => gameState.player.stats[k] += 3);
                reward = { icon: 'üèÜ', title: 'JACKPOT! Stat Boost Permanente!', desc: '+3 a TUTTI gli stat per sempre! Sei leggendario!' };
            }
            
            gameState.pendingMysteryBox = false;
            saveGame();
            updateUI();
            
            // Show result
            document.getElementById('mysteryBoxAnim').style.display = 'none';
            document.getElementById('mysteryBoxIcon').textContent = reward.icon;
            document.getElementById('mysteryBoxTitle').textContent = reward.title;
            document.getElementById('mysteryBoxDesc').textContent = reward.desc;
            document.getElementById('mysteryBoxResult').style.display = 'block';
            
            const btn = document.getElementById('mysteryBoxBtn');
            btn.textContent = '‚ú® Fantastico!';
            btn.onclick = () => document.getElementById('mysteryBoxModal').classList.remove('show');
        }

        // ============================================================
        // SFIDA OSSESSIVA #1: IL SISTEMA GIUDICA (Domenica sera)
        // ============================================================
        const JUDGMENT_COMMENTS = {
            S: [
                "Impressionante. Il Sistema raramente concede questo riconoscimento. Continua cos√¨ e forse un giorno sarai degno del rango supremo.",
                "Sei un'anomalia in questo mondo di mediocri. Il Sistema ti osserva con interesse. Non sprecare questo potenziale.",
                "Questa settimana hai dimostrato che la volont√† umana pu√≤ superare i propri limiti. Il Sistema ne prende nota."
            ],
            A: [
                "Buono. Non eccellente. Non sufficiente per diventare leggenda. Il Sistema sa che puoi fare di pi√π.",
                "Hai mostrato disciplina. Ma la disciplina senza eccellenza √® solo routine. Punta pi√π in alto.",
                "A √® il voto dei quasi-grandi. I veri campioni non si accontentano di 'quasi'."
            ],
            B: [
                "Nella media. Esattamente dove si trovano tutti gli altri. Vuoi davvero essere nella media?",
                "Hai completato il minimo. Il Sistema non punisce il minimo. Il Sistema lo dimentica.",
                "B significa che ci hai provato abbastanza da non fallire. Non √® un complimento."
            ],
            C: [
                "Deludente. Il Sistema aveva aspettative pi√π alte per te. Evidentemente erano eccessive.",
                "Met√† delle quest saltate. Met√† potenziale sprecato. Questa √® la matematica della mediocrit√†.",
                "Il Sistema registra questa settimana come 'sprecata'. Hai 7 giorni per riscattarti."
            ],
            D: [
                "Il Sistema quasi non ti riconosce pi√π. Sei sicuro di essere ancora un Hunter?",
                "Quest fallite, streak rotto, potenziale ignorato. Il Sistema √®... deluso.",
                "A questo ritmo non raggiungerai mai il tuo rango. Forse non lo vuoi davvero."
            ],
            F: [
                "Vergognoso. Il Sistema considera di revocare il tuo status di Hunter. Ridiscutiti.",
                "Questa settimana non esiste nei tuoi annali. Il Sistema la cancella. Cancella anche la tua pigrizia.",
                "Zero queste completate. Zero rispetto di te stesso. Il Sistema ti guarda e non vede nulla."
            ]
        };

        function calculateWeeklyGrade() {
            const quests = gameState.weeklyQuestsCompleted || 0;
            const streak = gameState.player.streak || 0;
            // Score: quests completate (max 28 = 4/giorno x 7), streak bonus
            const score = quests + Math.min(streak, 7);
            if (score >= 30) return 'S';
            if (score >= 22) return 'A';
            if (score >= 15) return 'B';
            if (score >= 8) return 'C';
            if (score >= 3) return 'D';
            return 'F';
        }

        function checkWeeklyJudgment() {
            const now = new Date();
            const isSunday = now.getDay() === 0;
            const isEvening = now.getHours() >= 20;
            const today = now.toDateString();

            if ((isSunday && isEvening) || (gameState.lastJudgmentDate !== today && isSunday)) {
                if (gameState.lastJudgmentDate === today) return;
                runWeeklyJudgment();
            }
        }

        function runWeeklyJudgment() {
            const grade = calculateWeeklyGrade();
            const comments = JUDGMENT_COMMENTS[grade];
            const comment = comments[Math.floor(Math.random() * comments.length)];
            const now = new Date();
            const weekStr = `${now.toLocaleDateString('it-IT', {day:'numeric', month:'short'})}`;

            const judgment = { grade, comment, week: weekStr, quests: gameState.weeklyQuestsCompleted || 0, exp: gameState.weeklyExpGained || 0 };
            
            // Save to history
            if (!gameState.judgmentHistory) gameState.judgmentHistory = [];
            gameState.judgmentHistory.unshift(judgment);
            if (gameState.judgmentHistory.length > 8) gameState.judgmentHistory.pop();
            
            gameState.weeklyJudgment = judgment;
            gameState.lastJudgmentDate = new Date().toDateString();
            // Reset weekly counters
            gameState.weeklyQuestsCompleted = 0;
            gameState.weeklyExpGained = 0;
            
            // EXP/HP consequences
            if (grade === 'S') { gainEXP(200); showNotification('‚öñÔ∏è Giudizio S! +200 EXP bonus!'); }
            else if (grade === 'F') { takeDamage(20, 'Settimana catastrofica'); }
            
            saveGame();
            renderWeeklyJudgment();
            
            // Show dramatic system message
            setTimeout(() => {
                triggerSystemMessage(`"${comment}"\n\n‚Äî Voto settimana: ${grade} ‚Äî`);
            }, 1500);
        }

        function renderWeeklyJudgment() {
            const j = gameState.weeklyJudgment;
            const card = document.getElementById('judgmentCard');
            if (!card) return;
            
            if (!j) { card.style.display = 'none'; return; }
            
            card.style.display = 'block';
            document.getElementById('judgmentGrade').textContent = j.grade;
            document.getElementById('judgmentGrade').className = `judgment-grade grade-${j.grade}`;
            document.getElementById('judgmentWeek').textContent = j.week;
            document.getElementById('judgmentComment').textContent = `"${j.comment}"`;

            // Hall of Shame
            const history = gameState.judgmentHistory || [];
            const shameEl = document.getElementById('hallOfShame');
            if (shameEl && history.length > 0) {
                const gradeColors = { S:'#ffd700', A:'#ff6b6b', B:'#4ecdc4', C:'#a8dadc', D:'#6c757d', F:'#ff0000' };
                shameEl.innerHTML = history.map(h => `
                    <div class="shame-entry">
                        <div>
                            <div style="font-weight:bold; font-size:12px;">${h.week}</div>
                            <div style="font-size:11px; color:#666;">${h.quests} quest ¬∑ ${h.exp} EXP</div>
                        </div>
                        <span class="shame-grade-badge" style="background:${gradeColors[h.grade]}22; color:${gradeColors[h.grade]}; border:1px solid ${gradeColors[h.grade]}44;">${h.grade}</span>
                    </div>
                `).join('');
            }

            // Weekly stats
            const statsEl = document.getElementById('weeklyJudgmentStats');
            if (statsEl) {
                statsEl.innerHTML = `
                    <div style="background:rgba(0,0,0,0.3); padding:12px; border-radius:8px; text-align:center;">
                        <div style="font-size:24px; font-weight:bold; color:#ffd700;">${gameState.weeklyQuestsCompleted || 0}</div>
                        <div style="font-size:11px; color:#888;">Quest questa settimana</div>
                    </div>
                    <div style="background:rgba(0,0,0,0.3); padding:12px; border-radius:8px; text-align:center;">
                        <div style="font-size:24px; font-weight:bold; color:#8a2be2;">${gameState.weeklyExpGained || 0}</div>
                        <div style="font-size:11px; color:#888;">EXP questa settimana</div>
                    </div>
                `;
            }
        }

        // ============================================================
        // SFIDA OSSESSIVA #2: PENALTY VISIVA ABBANDONO
        // ============================================================
        function checkAbandonPenalty() {
            const today = new Date().toDateString();
            const lastOpen = gameState.appLastOpened;
            gameState.appLastOpened = today;
            
            if (!lastOpen) { saveGame(); return; }
            
            const daysSince = Math.floor((new Date(today) - new Date(lastOpen)) / 86400000);
            
            const warning = document.getElementById('abandonWarning');
            if (!warning) return;
            
            if (daysSince >= 2) {
                const messages = [
                    `‚ö†Ô∏è Sei sparito per ${daysSince} giorni. Il Sistema ti ha notato. Il tuo personaggio √® debilitato.`,
                    `üíÄ ${daysSince} giorni di assenza. Sei sicuro di voler essere un Hunter?`,
                    `ü©∏ Il tuo Hunter ha subito ${daysSince * 5} danni passivi durante la tua assenza.`
                ];
                warning.style.display = 'block';
                warning.textContent = messages[Math.min(daysSince - 2, messages.length - 1)];
                document.getElementById('tab-player').classList.add('player-degraded');
                
                // Passive damage for abandonment
                if (daysSince >= 3) {
                    takeDamage(daysSince * 5, `${daysSince} giorni di abbandono`);
                }
                
                // Trigger system message after 2s
                setTimeout(() => {
                    triggerSystemMessage(`Hai abbandonato il tuo percorso per ${daysSince} giorni.\n\nIl Sistema non dimentica. La debolezza si accumula in silenzio.`);
                }, 2000);
            }
            saveGame();
        }

        // ============================================================
        // IMPREVEDIBILIT√Ä #1: MESSAGGI RANDOM DAL SISTEMA
        // ============================================================
        const SYSTEM_MESSAGES = [
            "Hunter, sei osservato. Non deludere.",
            "Il potere non si chiede. Si prende. Oggi ne hai preso abbastanza?",
            "Ogni secondo di pigrizia √® un vantaggio regalato al tuo nemico.",
            "Il Sistema ha registrato la tua ultima settimana. Non era sufficiente.",
            "Quanti altri ti stanno superando mentre tu leggi questo?",
            "La disciplina √® la differenza tra chi diventa leggenda e chi la racconta.",
            "Non esiste 'riprover√≤ domani'. Esiste solo adesso.",
            "Il tuo rango attuale non riflette il tuo potenziale. Questo √® un problema.",
            "Sung Jin-Woo non aspettava momenti migliori. Li creava.",
            "Sei a un passo dal cedere. Il Sistema lo sa. Resisti.",
            "Gli altri hunter ti guardano. Cosa vedono?",
            "Il limite che percepisci non √® reale. √à paura travestita da ragione.",
            "Una quest completata vale pi√π di mille intenzioni.",
            "Il Sistema ha analizzato le tue performance. Il margine di miglioramento √® significativo.",
            "Non ricevere questo messaggio come critica. Ricevilo come una verit√†."
        ];

        function scheduleSystemMessage() {
            // Show random message between 3min and 15 minutes after load
            const delay = (3 + Math.floor(Math.random() * 12)) * 60 * 1000;
            setTimeout(() => {
                const msg = SYSTEM_MESSAGES[Math.floor(Math.random() * SYSTEM_MESSAGES.length)];
                triggerSystemMessage(msg);
                // Schedule another one
                setTimeout(scheduleSystemMessage, 60 * 60 * 1000);
            }, delay);
        }

        function triggerSystemMessage(text) {
            const overlay = document.getElementById('systemMessageOverlay');
            document.getElementById('systemMessageText').textContent = text;
            overlay.style.display = 'flex';
        }

        function closeSystemMessage() {
            document.getElementById('systemMessageOverlay').style.display = 'none';
        }

        // ============================================================
        // IMPREVEDIBILIT√Ä #2: FLASH QUEST (appare a sorpresa)
        // ============================================================
        const FLASH_QUESTS = [
            { title: "‚ö° Sprint 10 Minuti", desc: "Corri o cammina veloce per 10 minuti adesso. Subito.", multiplier: 3 },
            { title: "‚ö° 50 Flessioni Adesso", desc: "Interrompi tutto. 50 flessioni. Nessuna scusa.", multiplier: 3 },
            { title: "‚ö° Bevi 500ml d'Acqua", desc: "Adesso. Non tra un minuto. Adesso.", multiplier: 2 },
            { title: "‚ö° 5 Minuti di Meditazione", desc: "Chiudi gli occhi. Respira. 5 minuti di silenzio totale.", multiplier: 2 },
            { title: "‚ö° Scrivi 3 Obiettivi", desc: "Carta e penna o telefono. 3 obiettivi concreti per questa settimana.", multiplier: 2 },
            { title: "‚ö° Chiama Qualcuno", desc: "Una persona che non senti da troppo. Fallo adesso.", multiplier: 3 },
            { title: "‚ö° Pulisci la Scrivania", desc: "5 minuti. Butta il superfluo. Ordina il resto.", multiplier: 2 },
            { title: "‚ö° 100 Squat", desc: "Alzati. 100 squat. Siediti solo dopo.", multiplier: 3 }
        ];

        function scheduleFlashQuest() {
            if (gameState.flashQuest) { renderFlashQuest(); return; }
            // Appear randomly between 30min and 3h
            const delay = (30 + Math.floor(Math.random() * 150)) * 60 * 1000;
            setTimeout(() => spawnFlashQuest(), delay);
        }

        function spawnFlashQuest() {
            if (gameState.flashQuest) return;
            const tpl = FLASH_QUESTS[Math.floor(Math.random() * FLASH_QUESTS.length)];
            gameState.flashQuest = {
                ...tpl,
                id: Date.now(),
                expReward: 80 * tpl.multiplier,
                deadline: Date.now() + (2 * 60 * 60 * 1000) // 2 hours
            };
            saveGame();
            updateUI();
            showNotification('‚ö° FLASH QUEST apparsa! Hai 2 ore!', true);
            // Schedule next one after this expires
            setTimeout(() => {
                if (gameState.flashQuest && Date.now() > gameState.flashQuest.deadline) {
                    gameState.flashQuest = null;
                    saveGame();
                    updateUI();
                    setTimeout(() => spawnFlashQuest(), 60 * 60 * 1000);
                }
            }, 2 * 60 * 60 * 1000 + 1000);
        }

        function completeFlashQuest() {
            if (!gameState.flashQuest) return;
            const exp = gameState.flashQuest.expReward;
            gainEXP(exp);
            gameState.manaCrystals = (gameState.manaCrystals || 0) + 5;
            showNotification(`‚ö° FLASH QUEST completata! +${exp} EXP +5 üíé`);
            gameState.flashQuest = null;
            saveGame();
            updateUI();
            // Schedule next
            setTimeout(() => spawnFlashQuest(), 90 * 60 * 1000);
        }

        function renderFlashQuest() {
            const section = document.getElementById('flashQuestSection');
            if (!section) return;
            
            if (!gameState.flashQuest || Date.now() > gameState.flashQuest.deadline) {
                if (gameState.flashQuest) { gameState.flashQuest = null; saveGame(); }
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            document.getElementById('flashQuestTitle').textContent = gameState.flashQuest.title;
            document.getElementById('flashQuestDesc').textContent = gameState.flashQuest.desc;
            document.getElementById('flashMultiplier').textContent = `x${gameState.flashQuest.multiplier} ‚Äî +${gameState.flashQuest.expReward} EXP`;
        }

        // ============================================================
        // IMPREVEDIBILIT√Ä #3: EARLY BIRD QUEST
        // ============================================================
        function checkEarlyBirdQuest() {
            const now = new Date();
            const hour = now.getHours();
            const today = now.toDateString();
            const section = document.getElementById('earlyBirdSection');
            if (!section) return;
            
            if (hour >= 6 && hour < 8 && gameState.earlyBirdClaimed !== today) {
                section.style.display = 'block';
            } else {
                section.style.display = 'none';
            }
        }

        function claimEarlyBird() {
            const today = new Date().toDateString();
            if (gameState.earlyBirdClaimed === today) return;
            gainEXP(150);
            gameState.manaCrystals = (gameState.manaCrystals || 0) + 5;
            gameState.earlyBirdClaimed = today;
            saveGame();
            updateUI();
            showNotification('üåÖ Early Bird! +150 EXP +5 üíé ‚Äî Il Sistema approva il tuo sacrificio.');
            document.getElementById('earlyBirdSection').style.display = 'none';
        }

        // ============================================================
        // IMPREVEDIBILIT√Ä #4: DOPPIO O NIENTE
        // ============================================================
        function openDoubleOrNothing(questId) {
            if (gameState.doubleOrNothingActive && gameState.doubleOrNothingQuestId === questId) {
                // Toggle off
                gameState.doubleOrNothingActive = false;
                gameState.doubleOrNothingQuestId = null;
                saveGame();
                updateUI();
                showNotification('üé≤ Scommessa annullata.');
                return;
            }
            gameState.doubleOrNothingQuestId = questId;
            const modal = document.getElementById('doubleOrNothingModal');
            document.getElementById('donResult').style.display = 'none';
            document.getElementById('diceAnimation').style.display = 'block';
            document.getElementById('donConfirmBtn').style.display = 'inline-block';
            document.getElementById('donCancelBtn').textContent = 'Annulla';
            modal.classList.add('show');
        }

        function confirmDoubleOrNothing() {
            gameState.doubleOrNothingActive = true;
            saveGame();
            updateUI();
            document.getElementById('doubleOrNothingModal').classList.remove('show');
            showNotification('üé≤ Scommessa attiva! Completa la quest per scoprire il risultato.');
        }
    </script>
</body>
</html>
