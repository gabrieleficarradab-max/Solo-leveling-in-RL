<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Life Leveling - Complete Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 80px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 2px solid rgba(106, 90, 205, 0.3);
        }

        h1 {
            color: #ffd700;
            font-size: 28px;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .player-card {
            background: linear-gradient(135deg, rgba(106, 90, 205, 0.2), rgba(72, 61, 139, 0.2));
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid rgba(138, 43, 226, 0.5);
            box-shadow: 0 0 20px rgba(138, 43, 226, 0.3);
        }

        .player-name {
            font-size: 24px;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 10px;
        }

        .rank {
            display: inline-block;
            padding: 5px 15px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 15px;
            margin-right: 10px;
        }

        .rank.S { background: linear-gradient(135deg, #ffd700, #ffed4e); color: #000; }
        .rank.A { background: linear-gradient(135deg, #ff6b6b, #ee5a6f); }
        .rank.B { background: linear-gradient(135deg, #4ecdc4, #44a08d); }
        .rank.C { background: linear-gradient(135deg, #95e1d3, #76c7c0); }
        .rank.D { background: linear-gradient(135deg, #a8dadc, #457b9d); }
        .rank.E { background: linear-gradient(135deg, #6c757d, #495057); }
        .rank.NATIONAL { background: linear-gradient(135deg, #ff00ff, #8b00ff); color: #fff; animation: pulse 2s infinite; }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 5px rgba(255, 0, 255, 0.5); }
            50% { box-shadow: 0 0 20px rgba(255, 0, 255, 1); }
        }

        .job-class {
            display: inline-block;
            padding: 5px 15px;
            background: rgba(138, 43, 226, 0.3);
            border-radius: 20px;
            font-size: 12px;
            border: 1px solid rgba(138, 43, 226, 0.5);
        }

        .level {
            font-size: 20px;
            margin-bottom: 10px;
        }

        .stat-bar {
            margin: 10px 0;
        }

        .stat-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #6a5acd, #8a2be2);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .hp-bar .progress-fill { background: linear-gradient(90deg, #ff6b6b, #ee5a6f); }
        .mp-bar .progress-fill { background: linear-gradient(90deg, #4ecdc4, #44a08d); }

        .hp-warning { background: linear-gradient(90deg, #ff9500, #ff6b00) !important; animation: blink 1s infinite; }
        .hp-critical { background: linear-gradient(90deg, #ff0000, #cc0000) !important; animation: blink 0.5s infinite; }

        /* ===== DUNGEON STYLES ===== */
        .dungeon-header {
            background: linear-gradient(135deg, rgba(139,0,0,0.3), rgba(80,0,80,0.3));
            border: 2px solid rgba(139,0,0,0.6);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
        }
        .dungeon-title { font-size: 20px; color: #ff4444; font-weight: bold; margin-bottom: 8px; text-shadow: 0 0 10px rgba(255,68,68,0.5); }
        .dungeon-hp-bar { margin: 10px 0; }
        .dungeon-hp-fill { height: 100%; background: linear-gradient(90deg, #8b0000, #ff0000); transition: width 0.5s ease; }
        .dungeon-room {
            background: rgba(0,0,0,0.4);
            border: 1px solid rgba(139,0,0,0.4);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
            transition: all 0.3s;
        }
        .dungeon-room.locked { opacity: 0.4; pointer-events: none; }
        .dungeon-room.completed { border-color: #4ecdc4; opacity: 0.7; }
        .dungeon-room.active { border-color: #ff4444; box-shadow: 0 0 15px rgba(255,68,68,0.3); }
        .room-number {
            position: absolute; top: 10px; right: 10px;
            background: rgba(139,0,0,0.5); padding: 3px 8px;
            border-radius: 10px; font-size: 11px; color: #ff8888;
        }
        .dungeon-btn {
            background: linear-gradient(135deg, #8b0000, #cc0000);
            border: none; color: white; padding: 10px 20px;
            border-radius: 8px; cursor: pointer; font-weight: bold;
            width: 100%; margin-top: 8px; transition: all 0.3s;
        }
        .dungeon-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(200,0,0,0.4); }
        .dungeon-btn.abandon { background: linear-gradient(135deg, #333, #555); margin-top: 15px; }
        .dungeon-completed-banner {
            text-align: center; padding: 20px;
            background: linear-gradient(135deg, rgba(255,215,0,0.1), rgba(138,43,226,0.2));
            border: 2px solid #ffd700; border-radius: 12px; margin-bottom: 10px;
        }

        /* ===== DOUBLE OR NOTHING ===== */
        .gamble-btn {
            background: linear-gradient(135deg, #1a1a00, #444400);
            border: 1px solid #ffd700; color: #ffd700;
            padding: 8px 15px; border-radius: 8px; cursor: pointer;
            font-weight: bold; margin-top: 8px; width: 100%;
            transition: all 0.3s; font-size: 13px;
        }
        .gamble-btn:hover { background: linear-gradient(135deg, #333300, #666600); box-shadow: 0 0 10px rgba(255,215,0,0.4); }
        .gamble-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .gamble-result-win { color: #4ecdc4; font-weight: bold; font-size: 13px; margin-top: 5px; text-align: center; }
        .gamble-result-lose { color: #ff6b6b; font-weight: bold; font-size: 13px; margin-top: 5px; text-align: center; }

        /* ===== GIUDIZIO DEL SISTEMA ===== */
        .judgment-card {
            background: linear-gradient(135deg, rgba(20,20,40,0.8), rgba(10,10,30,0.9));
            border: 2px solid rgba(106,90,205,0.5);
            border-radius: 15px; padding: 20px; margin-bottom: 15px;
            text-align: center;
        }
        .judgment-grade {
            font-size: 72px; font-weight: 900; margin: 10px 0;
            text-shadow: 0 0 20px currentColor;
            line-height: 1;
        }
        .judgment-grade.S { color: #ffd700; }
        .judgment-grade.A { color: #ff6b6b; }
        .judgment-grade.B { color: #4ecdc4; }
        .judgment-grade.C { color: #95e1d3; }
        .judgment-grade.D { color: #a8dadc; }
        .judgment-grade.F { color: #6c757d; }
        .judgment-comment {
            font-style: italic; color: #bbb; font-size: 14px;
            line-height: 1.6; margin: 15px 0; padding: 10px;
            border-left: 3px solid rgba(106,90,205,0.5);
            text-align: left;
        }
        .judgment-stats {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 8px; margin: 15px 0; text-align: left;
        }
        .judgment-stat { background: rgba(0,0,0,0.3); padding: 8px 12px; border-radius: 8px; font-size: 13px; }
        .judgment-stat span { color: #ffd700; float: right; font-weight: bold; }
        .judgment-history-item {
            background: rgba(0,0,0,0.3); border-radius: 8px;
            padding: 10px 15px; margin-bottom: 8px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .judgment-history-grade { font-size: 24px; font-weight: bold; }
        .judgment-history-grade.S { color: #ffd700; }
        .judgment-history-grade.A { color: #ff6b6b; }
        .judgment-history-grade.B { color: #4ecdc4; }
        .judgment-history-grade.C { color: #95e1d3; }
        .judgment-history-grade.D { color: #a8dadc; }
        .judgment-history-grade.F { color: #6c757d; }

        /* ===== ARCHIVIO DEL SISTEMA ===== */
        .archive-chapter {
            background: linear-gradient(135deg, rgba(5,5,20,0.9), rgba(20,10,40,0.9));
            border: 1px solid rgba(80,60,150,0.4);
            border-radius: 10px; padding: 15px; margin-bottom: 10px;
            cursor: pointer; transition: all 0.3s;
        }
        .archive-chapter:hover { border-color: rgba(138,43,226,0.7); }
        .archive-chapter.locked {
            opacity: 0.4; cursor: not-allowed;
            border-color: rgba(50,50,50,0.4);
        }
        .archive-chapter.locked:hover { border-color: rgba(50,50,50,0.4); }
        .archive-chapter-header { display: flex; justify-content: space-between; align-items: center; }
        .archive-chapter-title { font-size: 14px; color: #8a6fe8; font-weight: bold; }
        .archive-chapter-lock { color: #555; font-size: 16px; }
        .archive-chapter-preview { font-size: 12px; color: #666; margin-top: 5px; font-style: italic; }
        .archive-content {
            display: none; margin-top: 12px; padding-top: 12px;
            border-top: 1px solid rgba(106,90,205,0.2);
            font-size: 13px; color: #9a8fc0; line-height: 1.8;
            font-style: italic;
        }
        .archive-chapter.open .archive-content { display: block; }
        .archive-unlock-condition { font-size: 11px; color: #555; margin-top: 5px; }

        /* ===== DAILY LOGIN BONUS ===== */
        .login-bonus-modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85); z-index: 9999;
            display: flex; align-items: center; justify-content: center;
        }
        .login-bonus-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 2px solid #ffd700;
            border-radius: 20px; padding: 30px; text-align: center;
            max-width: 360px; width: 90%;
            box-shadow: 0 0 40px rgba(255,215,0,0.3);
            animation: loginPop 0.5s cubic-bezier(0.34,1.56,0.64,1);
        }
        @keyframes loginPop {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .login-streak-row {
            display: flex; justify-content: center; gap: 6px; margin: 15px 0;
        }
        .login-day-dot {
            width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 11px; font-weight: bold;
            border: 2px solid rgba(255,215,0,0.2);
            background: rgba(0,0,0,0.4); color: #666;
        }
        .login-day-dot.done { background: rgba(255,215,0,0.2); border-color: #ffd700; color: #ffd700; }
        .login-day-dot.today { background: #ffd700; color: #000; border-color: #ffd700; animation: pulse 1.5s infinite; }
        .login-claim-btn {
            background: linear-gradient(135deg, #ffd700, #ff9900);
            border: none; color: #000; font-weight: bold; font-size: 18px;
            padding: 14px 40px; border-radius: 12px; cursor: pointer;
            margin-top: 15px; width: 100%; transition: all 0.3s;
        }
        .login-claim-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(255,215,0,0.5); }

        /* ===== BOSS PHASES ===== */
        .boss-card {
            background: linear-gradient(135deg, rgba(80,0,80,0.3), rgba(40,0,40,0.4));
            border: 2px solid rgba(139,0,255,0.5);
            border-radius: 15px; padding: 20px; margin-bottom: 10px;
        }
        .boss-card.raid {
            border-color: #ffd700;
            background: linear-gradient(135deg, rgba(50,30,0,0.5), rgba(20,10,0,0.6));
            box-shadow: 0 0 25px rgba(255,215,0,0.2);
        }
        .boss-name { font-size: 20px; font-weight: bold; color: #cc44ff; margin-bottom: 3px; }
        .boss-name.raid { color: #ffd700; }
        .boss-subtitle { font-size: 13px; color: #888; font-style: italic; margin-bottom: 8px; }
        .boss-lore { font-size: 12px; color: #7a5a9a; margin-bottom: 12px; line-height: 1.5; }
        .boss-phase {
            background: rgba(0,0,0,0.3); border-radius: 8px; padding: 10px 12px;
            margin-bottom: 8px; border-left: 3px solid rgba(139,0,255,0.4);
            transition: all 0.3s;
        }
        .boss-phase.raid-phase { border-left-color: rgba(255,215,0,0.5); }
        .boss-phase.completed { border-left-color: #4ecdc4; opacity: 0.65; }
        .boss-phase.active { border-left-color: #cc44ff; box-shadow: 0 0 10px rgba(204,68,255,0.2); }
        .boss-phase.locked { opacity: 0.35; }
        .boss-phase-title { font-size: 13px; font-weight: bold; color: #cc44ff; margin-bottom: 4px; }
        .boss-phase-title.raid-phase-title { color: #ffd700; }
        .boss-phase-desc { font-size: 12px; color: #aaa; line-height: 1.5; }
        .boss-phase-reward { font-size: 11px; color: #4ecdc4; margin-top: 4px; }
        .boss-complete-btn {
            background: linear-gradient(135deg, #6600cc, #9900ff);
            border: none; color: white; padding: 10px 20px;
            border-radius: 8px; cursor: pointer; font-weight: bold;
            width: 100%; margin-top: 10px; transition: all 0.3s;
        }
        .boss-complete-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(150,0,255,0.4); }
        .boss-complete-btn.raid-btn {
            background: linear-gradient(135deg, #cc8800, #ffcc00);
            color: #000;
        }
        .boss-defeat-banner {
            text-align: center; padding: 20px;
            background: linear-gradient(135deg, rgba(138,43,226,0.15), rgba(255,215,0,0.1));
            border: 2px solid #cc44ff; border-radius: 12px;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .stat-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .stat-name {
            font-size: 12px;
            color: #bbb;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #ffd700;
        }

        .stat-exp-bar {
            width: 100%;
            height: 8px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .stat-exp-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffd700, #ffed4e);
            transition: width 0.3s ease;
        }

        .stat-exp-label {
            font-size: 10px;
            color: #999;
            margin-top: 3px;
            text-align: center;
        }

        .stat-points {
            background: rgba(255, 215, 0, 0.2);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            margin-top: 15px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .stat-exp-bar {
            width: 100%;
            height: 8px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .stat-exp-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffd700, #ffed4e);
            transition: width 0.3s ease;
        }

        .stat-exp-label {
            font-size: 10px;
            color: #999;
            margin-top: 3px;
            text-align: center;
        }

        .section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid rgba(106, 90, 205, 0.3);
        }

        .section-title {
            font-size: 20px;
            color: #ffd700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quest-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #6a5acd;
            transition: all 0.3s;
        }

        .quest-item:hover {
            background: rgba(0, 0, 0, 0.5);
            transform: translateX(5px);
        }

        .quest-item.completed {
            opacity: 0.6;
            border-left-color: #4ecdc4;
        }

        .quest-item.emergency {
            border-left: 4px solid #ff0000;
            background: linear-gradient(90deg, rgba(255, 0, 0, 0.1), rgba(0, 0, 0, 0.3));
            animation: emergencyPulse 2s infinite;
        }

        .quest-item.boss {
            border-left: 4px solid #8b00ff;
            background: linear-gradient(90deg, rgba(139, 0, 255, 0.1), rgba(0, 0, 0, 0.3));
        }

        @keyframes emergencyPulse {
            0%, 100% { box-shadow: 0 0 10px rgba(255, 0, 0, 0.3); }
            50% { box-shadow: 0 0 20px rgba(255, 0, 0, 0.8); }
        }

        .quest-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .quest-title {
            font-weight: bold;
            font-size: 16px;
        }

        .quest-reward {
            background: rgba(255, 215, 0, 0.2);
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 12px;
            color: #ffd700;
        }

        .quest-description {
            font-size: 14px;
            color: #bbb;
            margin-bottom: 10px;
        }

        .quest-timer {
            font-size: 12px;
            color: #ff6b6b;
            margin-bottom: 10px;
        }

        .complete-btn {
            background: linear-gradient(135deg, #6a5acd, #8a2be2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            transition: all 0.3s;
        }

        .complete-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(138, 43, 226, 0.4);
        }

        .complete-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #6a5acd, #8a2be2);
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
            max-width: 300px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.emergency {
            background: linear-gradient(135deg, #ff0000, #cc0000);
            animation: shake 0.5s infinite;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            25% { transform: translateX(5px) rotate(2deg); }
            75% { transform: translateX(-5px) rotate(-2deg); }
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .inventory-slot {
            aspect-ratio: 1;
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid rgba(106, 90, 205, 0.3);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .inventory-slot:hover {
            border-color: rgba(138, 43, 226, 0.8);
            background: rgba(138, 43, 226, 0.2);
        }

        .inventory-slot.has-effect {
            border-color: #ffd700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .item-icon {
            font-size: 30px;
            margin-bottom: 5px;
        }

        .item-count {
            font-size: 12px;
            color: #ffd700;
        }

        .item-effect {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 10px;
            background: rgba(255, 215, 0, 0.3);
            padding: 2px 5px;
            border-radius: 5px;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(26, 26, 46, 0.95);
            border-top: 2px solid rgba(106, 90, 205, 0.3);
            display: flex;
            justify-content: space-around;
            padding: 15px 0;
            backdrop-filter: blur(10px);
        }

        .nav-btn {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            transition: all 0.3s;
        }

        .nav-btn.active {
            color: #ffd700;
        }

        .nav-icon {
            font-size: 24px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .penalty-warning {
            background: rgba(255, 107, 107, 0.2);
            border: 2px solid #ff6b6b;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
        }

        .reset-btn {
            background: rgba(255, 107, 107, 0.3);
            border: 1px solid #ff6b6b;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 15px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            width: 100%;
            border: 2px solid rgba(106, 90, 205, 0.5);
            max-height: 80vh;
            overflow-y: auto;
        }

        .shadow-army-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .shadow-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #8a2be2;
        }

        .shadow-item .shadow-name {
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 5px;
        }

        .shadow-item .shadow-streak {
            font-size: 12px;
            color: #4ecdc4;
        }

        .shadow-item .shadow-bonus {
            font-size: 12px;
            color: #aaa;
            margin-top: 5px;
        }

        .achievement-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .achievement-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid rgba(106, 90, 205, 0.3);
        }

        .achievement-item.unlocked {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.1);
        }

        .achievement-icon {
            font-size: 30px;
            margin-bottom: 5px;
        }

        .achievement-title {
            font-size: 12px;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 5px;
        }

        .achievement-desc {
            font-size: 10px;
            color: #999;
        }

        .skill-tree {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .skill-branch {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
        }

        .skill-branch-title {
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 10px;
        }

        .skill-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .skill-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
            border-left: 3px solid #6a5acd;
            cursor: pointer;
            transition: all 0.3s;
        }

        .skill-item:hover {
            background: rgba(106, 90, 205, 0.2);
        }

        .skill-item.unlocked {
            border-left-color: #4ecdc4;
            background: rgba(76, 205, 196, 0.1);
        }

        .skill-item.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .skill-name {
            font-weight: bold;
            font-size: 14px;
        }

        .skill-desc {
            font-size: 12px;
            color: #bbb;
            margin-top: 5px;
        }

        .skill-cost {
            font-size: 11px;
            color: #ffd700;
            margin-top: 5px;
        }

        .radar-chart-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }

        .death-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            z-index: 9999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #ff0000;
        }

        .death-screen.active {
            display: flex;
        }

        .death-title {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 0 0 20px #ff0000;
            animation: deathPulse 2s infinite;
        }

        @keyframes deathPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .death-timer {
            font-size: 36px;
            margin-bottom: 20px;
        }

        .death-message {
            font-size: 18px;
            text-align: center;
            color: #999;
            max-width: 400px;
            line-height: 1.6;
        }

        .crafting-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .recipe-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid rgba(106, 90, 205, 0.3);
        }

        .recipe-item.unlocked {
            border-color: #4ecdc4;
        }

        .recipe-name {
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 5px;
        }

        .recipe-materials {
            font-size: 12px;
            color: #bbb;
            margin-bottom: 10px;
        }

        .craft-btn {
            background: linear-gradient(135deg, #6a5acd, #8a2be2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            width: 100%;
        }

        .craft-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status-effects {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        .status-effect {
            background: rgba(76, 205, 196, 0.2);
            border: 1px solid #4ecdc4;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 11px;
        }

        .status-effect.buff {
            background: rgba(76, 205, 196, 0.2);
            border-color: #4ecdc4;
        }

        .status-effect.debuff {
            background: rgba(255, 107, 107, 0.2);
            border-color: #ff6b6b;
        }

        /* Welcome Screen Styles */
        #welcomeScreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #0a0a1e 0%, #16213e 100%);
            z-index: 10000;
            overflow-y: auto;
            padding: 20px;
        }

        .welcome-container {
            max-width: 600px;
            margin: 0 auto;
            padding-bottom: 40px;
        }

        .welcome-title {
            text-align: center;
            font-size: 32px;
            color: #ffd700;
            margin: 40px 0 30px;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .quote-box {
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
            text-align: center;
        }

        .quote-text {
            font-size: 18px;
            line-height: 1.6;
            color: #ffd700;
            font-style: italic;
            margin-bottom: 15px;
        }

        .quote-author {
            font-size: 14px;
            color: #bbb;
        }

        .tutorial-section {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(106, 90, 205, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .tutorial-title {
            font-size: 24px;
            color: #ffd700;
            margin-bottom: 20px;
            text-align: center;
        }

        .tutorial-item {
            margin: 15px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border-left: 4px solid #6a5acd;
        }

        .tutorial-item-title {
            font-size: 16px;
            font-weight: bold;
            color: #4ecdc4;
            margin-bottom: 8px;
        }

        .tutorial-item-desc {
            font-size: 14px;
            color: #bbb;
            line-height: 1.5;
        }

        .continue-btn {
            display: block;
            width: 100%;
            max-width: 400px;
            margin: 40px auto;
            padding: 20px;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #000;
            border: none;
            border-radius: 15px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .continue-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.6);
        }

        .daily-quote {
            font-style: italic;
            color: #ffd700;
            font-size: 14px;
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 8px;
        }

        .streak-display {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.2), rgba(255, 0, 0, 0.2));
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
            border: 2px solid rgba(255, 107, 107, 0.5);
        }

        .streak-number {
            font-size: 32px;
            font-weight: bold;
            color: #ffd700;
            margin: 10px 0;
        }

        .streak-bonus {
            font-size: 12px;
            color: #4ecdc4;
        }

        .comparison-box {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            border: 2px solid rgba(255, 215, 0, 0.3);
        }

        .comparison-title {
            font-size: 18px;
            color: #ffd700;
            text-align: center;
            margin-bottom: 15px;
        }

        .comparison-row {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
        }

        .comparison-label {
            color: #bbb;
        }

        .comparison-values {
            display: flex;
            gap: 20px;
        }

        .comparison-old {
            color: #999;
        }

        .comparison-new {
            font-weight: bold;
        }

        .comparison-new.winning {
            color: #4ecdc4;
        }

        .comparison-new.losing {
            color: #ff6b6b;
        }
        
        /* Developer Message Popup */
        .dev-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
        }

        .dev-popup {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 2px solid #ffd700;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            position: relative;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
            animation: popupSlide 0.3s ease-out;
        }

        @keyframes popupSlide {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .dev-popup-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid #ff0000;
            color: #fff;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            line-height: 28px;
            text-align: center;
            transition: all 0.3s;
        }

        .dev-popup-close:hover {
            background: rgba(255, 0, 0, 0.5);
            transform: scale(1.1);
        }

        .dev-popup-title {
            color: #ffd700;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .dev-popup-content {
            color: #ddd;
            font-size: 15px;
            line-height: 1.8;
            margin-bottom: 20px;
        }

        .dev-popup-content p {
            margin-bottom: 15px;
        }

        .dev-popup-highlight {
            color: #ffd700;
            font-weight: bold;
        }

        /* Theme Store */
        .theme-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .theme-card {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(106, 90, 205, 0.3);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .theme-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(106, 90, 205, 0.5);
            border-color: rgba(106, 90, 205, 0.8);
        }

        .theme-card.purchased {
            border-color: rgba(255, 215, 0, 0.5);
            background: rgba(255, 215, 0, 0.1);
        }

        .theme-card.active {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.2);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        .theme-preview {
            width: 60px;
            height: 60px;
            margin: 0 auto 10px;
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .theme-name {
            font-size: 14px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 8px;
        }

        .theme-price {
            font-size: 18px;
            color: #4ecdc4;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .theme-status {
            font-size: 11px;
            color: #ffd700;
            margin-top: 8px;
        }

        .theme-btn {
            background: #4ecdc4;
            color: #000;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 13px;
            transition: all 0.3s;
            width: 100%;
        }

        .theme-btn:hover {
            background: #44a08d;
            transform: scale(1.05);
        }

        .theme-btn.active-btn {
            background: #ffd700;
        }

        .theme-btn.active-btn:hover {
            background: #ffed4e;
        }

        /* Gacha Section */
        .gacha-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .gacha-box {
            background: linear-gradient(135deg, rgba(106, 90, 205, 0.2), rgba(72, 61, 139, 0.2));
            border: 2px solid rgba(138, 43, 226, 0.5);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .gacha-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(138, 43, 226, 0.5);
            border-color: rgba(138, 43, 226, 0.8);
        }

        .gacha-box.common {
            border-color: rgba(128, 128, 128, 0.5);
        }

        .gacha-box.rare {
            border-color: rgba(100, 149, 237, 0.5);
            background: linear-gradient(135deg, rgba(100, 149, 237, 0.2), rgba(65, 105, 225, 0.2));
        }

        .gacha-box.legendary {
            border-color: rgba(255, 215, 0, 0.5);
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 165, 0, 0.2));
            animation: legendaryGlow 2s infinite;
        }

        @keyframes legendaryGlow {
            0%, 100% { box-shadow: 0 0 10px rgba(255, 215, 0, 0.3); }
            50% { box-shadow: 0 0 25px rgba(255, 215, 0, 0.6); }
        }

        .gacha-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .gacha-name {
            font-size: 16px;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 8px;
        }

        .gacha-cost {
            font-size: 14px;
            color: #4ecdc4;
            margin-bottom: 12px;
        }

        .gacha-btn {
            background: #6a5acd;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            width: 100%;
        }

        .gacha-btn:hover {
            background: #483d8b;
            transform: scale(1.05);
        }
    </style>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-46MVKW4MNQ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-46MVKW4MNQ');
    </script>
</head>
<body>
    <!-- Developer Message Popup (shows once) -->
    <div id="devMessagePopup" class="dev-popup-overlay" style="display: none;">
        <div class="dev-popup">
            <div class="dev-popup-close" onclick="closeDevMessage()">‚úï</div>
            <div class="dev-popup-title">üì¢ Messaggio dello Sviluppatore</div>
            <div class="dev-popup-content">
                <p><span class="dev-popup-highlight">L'applicazione non verr√† pi√π aggiornata fino a fine marzo</span> cos√¨ da permettervi di prendere familiarit√† con il gioco e le sue meccaniche.</p>
                
                <p><span class="dev-popup-highlight">Ogni aggiornamento avverr√† l'ultimo giorno del mese.</span></p>
                
                <p>‚ö†Ô∏è <strong>Mi scuso</strong> se in questi giorni magari le statistiche si sono azzerate, ci√≤ non ricapiter√† pi√π. Vi ringrazio se continuerete a usare l'app.</p>
                
                <p><span class="dev-popup-highlight">‚ö†Ô∏è IMPORTANTE:</span> Salvate i dati nell'eventualit√† che altri aggiornamenti azzerino le statistiche, cos√¨ da poterli reinserire nell'app aggiornata.</p>
                
                <p style="text-align: center; margin-top: 20px;">
                    <button onclick="closeDevMessage()" class="complete-btn" style="padding: 12px 30px;">
                        Ho capito! üëç
                    </button>
                </p>
            </div>
        </div>
    </div>

    <!-- Welcome Screen -->
    <div id="welcomeScreen" style="display: none;">
        <div class="welcome-container">
            <div class="welcome-title">‚öîÔ∏è REAL LIFE LEVELING ‚öîÔ∏è</div>
            
            <div class="quote-box">
                <div class="quote-text">
                    "√à meglio essere temuto che amato, se non si pu√≤ essere entrambi. 
                    Chi controlla s√© stesso, controlla il proprio destino."
                </div>
                <div class="quote-author">‚Äî Niccol√≤ Machiavelli</div>
            </div>

            <div class="tutorial-section">
                <div class="tutorial-title">üìñ COME FUNZIONA</div>

                <div class="tutorial-item">
                    <div class="tutorial-item-title">‚ù§Ô∏è HP (Punti Vita)</div>
                    <div class="tutorial-item-desc">
                        La tua vitalit√†. 0 HP = morte = 24h blocco. Perdi HP fallendo quest accettate.
                    </div>
                </div>

                <div class="tutorial-item">
                    <div class="tutorial-item-title">üíô MP (Punti Mana)</div>
                    <div class="tutorial-item-desc">
                        Energia per abilit√† speciali. Cresce con Intelligenza.
                    </div>
                </div>

                <div class="tutorial-item">
                    <div class="tutorial-item-title">‚≠ê EXP (Esperienza)</div>
                    <div class="tutorial-item-desc">
                        Completa quest per salire di livello e diventare pi√π forte.
                    </div>
                </div>

                <div class="tutorial-item">
                    <div class="tutorial-item-title">üìã QUEST</div>
                    <div class="tutorial-item-desc">
                        Devi ACCETTARE una quest per iniziare il timer. Completa prima della scadenza o subisci penalit√† HP.
                    </div>
                </div>

                <div class="tutorial-item">
                    <div class="tutorial-item-title">üí™ STATISTICHE</div>
                    <div class="tutorial-item-desc">
                        Crescono automaticamente completando quest. Barra EXP sotto ogni stat. 100 EXP ‚Üí +1 stat.
                    </div>
                </div>

                <div class="tutorial-item">
                    <div class="tutorial-item-title">üí∞ MANA STONES</div>
                    <div class="tutorial-item-desc">
                        Valuta per crafting e shop. Guadagni Mana Stones completando quest.
                    </div>
                </div>

                <div class="tutorial-item">
                    <div class="tutorial-item-title">‚öîÔ∏è RANK</div>
                    <div class="tutorial-item-desc">
                        E ‚Üí D ‚Üí C ‚Üí B ‚Üí A ‚Üí S ‚Üí NATIONAL. Sali ogni 10 livelli. A Rank C e A scegli Job Class.
                    </div>
                </div>

                <div class="tutorial-item">
                    <div class="tutorial-item-title">üë• SHADOW ARMY</div>
                    <div class="tutorial-item-desc">
                        Completa stessa quest x30 giorni consecutivi ‚Üí diventa Shadow che lavora per te automaticamente.
                    </div>
                </div>

                <div class="tutorial-item">
                    <div class="tutorial-item-title">üî• STREAK</div>
                    <div class="tutorial-item-desc">
                        Giorni consecutivi con almeno 1 quest completata. Pi√π alto lo streak, pi√π bonus EXP ottieni.
                    </div>
                </div>

                <div class="tutorial-item">
                    <div class="tutorial-item-title">üíÄ MORTE</div>
                    <div class="tutorial-item-desc">
                        0 HP = 24h blocco. Penalit√†: -50% Mana Stones, perdi EXP, Shadow Army danneggiata.
                    </div>
                </div>
            </div>

            <div class="quote-box">
                <div class="quote-text">"Il potere non si chiede. Si prende."</div>
            </div>

            <button class="continue-btn" onclick="startApp()">‚öîÔ∏è CONTINUA ‚öîÔ∏è</button>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" style="display: none;">
    <div class="container">
        <header>
            <h1>‚öîÔ∏è REAL LIFE LEVELING ‚öîÔ∏è</h1>
            <div class="daily-quote" id="dailyQuote"></div>
        </header>

        <!-- Tab: Player -->
        <div id="tab-player" class="tab-content active">
            <div class="streak-display">
                <div style="font-size: 14px; color: #bbb;">STREAK GIORNALIERO</div>
                <div class="streak-number" id="streakDisplay">üî• 0 giorni</div>
                <div class="streak-bonus" id="streakBonus">Bonus: +0% EXP</div>
            </div>

            <div class="player-card">
                <div class="player-name" id="playerName">Hunter Novizio</div>
                <span class="rank" id="playerRank">E</span>
                <span class="job-class" id="playerClass">Nessuna Classe</span>
                <div class="level">Livello: <span id="playerLevel">1</span></div>
                
                <div class="stat-bar hp-bar">
                    <div class="stat-label">
                        <span>HP</span>
                        <span><span id="currentHP">100</span>/<span id="maxHP">100</span></span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="hpBar" style="width: 100%;"></div>
                    </div>
                </div>

                <div class="stat-bar mp-bar">
                    <div class="stat-label">
                        <span>MP</span>
                        <span><span id="currentMP">50</span>/<span id="maxMP">50</span></span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="mpBar" style="width: 100%;"></div>
                    </div>
                </div>

                <div class="stat-bar">
                    <div class="stat-label">
                        <span>EXP</span>
                        <span><span id="currentEXP">0</span>/<span id="nextLevelEXP">100</span></span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="expBar" style="width: 0%;"></div>
                    </div>
                </div>

                <div class="status-effects" id="statusEffects"></div>

                <div class="stat-points" id="statPointsDisplay">
                    üíé Punti Stat: <span id="availablePoints">0</span> | ‚≠ê Punti Skill: <span id="skillPoints">0</span>
                </div>

                <div class="stats-grid" id="statsGrid">
                    <!-- Stats rendered dynamically with EXP bars -->
                </div>
            </div>

            <div class="section">
                <div class="section-title">üèÜ Titolo Attivo</div>
                <div id="activeTitle" style="text-align: center; font-size: 18px; color: #ffd700;">
                    Nessun Titolo
                </div>
            </div>

            <div class="section">
                <div class="section-title">üìä Radar Stats</div>
                <div class="radar-chart-container">
                    <canvas id="radarChart" width="300" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Tab: Quests -->
        <div id="tab-quests" class="tab-content">
            <div class="section">
                <div class="section-title">üìã Quest Giornaliere</div>
                <div id="penaltyWarning" class="penalty-warning" style="display: none;">
                    ‚ö†Ô∏è ATTENZIONE: Quest giornaliere non completate!<br>
                    Penalit√† attiva: -10 HP
                </div>
                <div id="dailyQuests"></div>
                <button onclick="showCreateQuestModal()" class="complete-btn" style="margin-top: 10px;">
                    ‚úèÔ∏è Crea Quest Personalizzata
                </button>
            </div>

            <div id="emergencyQuestSection" style="display: none;">
                <div class="section">
                    <div class="section-title" style="color: #ff0000;">üö® EMERGENCY QUEST</div>
                    <div id="emergencyQuest"></div>
                </div>
            </div>

            <div class="section">
                <div class="section-title" id="bossTitle">üíÄ Boss Fight Settimanale</div>
                <div id="bossQuest"></div>
            </div>

            <div class="section">
                <div class="section-title" style="color: #ff4444;">üè∞ Dungeon Settimanale</div>
                <div id="dungeonSection"></div>
            </div>
        </div>

        <!-- Tab: Progress -->
        <div id="tab-progress" class="tab-content">
            <div class="section">
                <div class="section-title">‚öñÔ∏è Giudizio del Sistema</div>
                <div id="judgmentSection"></div>
            </div>

            <div class="section">
                <div class="section-title" style="color: #8a6fe8;">üìö Archivio del Sistema</div>
                <p style="color: #666; font-size: 12px; margin-bottom: 15px; font-style: italic;">
                    Frammenti di memoria. Il Sistema ricorda ci√≤ che tu hai dimenticato.
                </p>
                <div id="archiveSection"></div>
            </div>
            <div class="section">
                <div class="section-title">‚öîÔ∏è Sfida Te Stesso</div>
                <div id="selfComparison"></div>
            </div>

            <div class="section">
                <div class="section-title">üìÖ Calendario Completamenti</div>
                <div id="completionCalendar" style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px;"></div>
            </div>

            <div class="section">
                <div class="section-title">üë• Shadow Army</div>
                <div id="shadowArmyList" class="shadow-army-list"></div>
            </div>

            <div class="section">
                <div class="section-title">üèÜ Achievements</div>
                <div id="achievementsList" class="achievement-grid"></div>
            </div>

            <div class="section">
                <div class="section-title">üå≥ Skill Tree</div>
                <div style="text-align: center; margin-bottom: 15px;">
                    ‚≠ê Punti Skill Disponibili: <span id="skillPointsDisplay" style="color: #ffd700; font-weight: bold;">0</span>
                </div>
                <div id="skillTree" class="skill-tree"></div>
            </div>
        </div>

        <!-- Tab: Inventory -->
        <div id="tab-inventory" class="tab-content">
            <div class="section">
                <div class="section-title">üéí Inventario</div>
                <div style="text-align: center; margin-bottom: 15px;">
                    üí∞ Mana Stones: <span id="manaStones" style="color: #ffd700; font-weight: bold;">0</span>
                </div>
                
                <button onclick="showAddItemModal()" class="complete-btn" style="margin-bottom: 15px;">
                    ‚ûï Aggiungi Oggetto
                </button>
                
                <div class="inventory-grid" id="inventoryGrid">
                    <div style="grid-column: 1/-1; text-align: center; color: #999; padding: 40px;">
                        Nessun oggetto nell'inventario.
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">üî® Crafting</div>
                <div id="craftingGrid" class="crafting-grid"></div>
            </div>

            <div class="section">
                <div class="section-title">üé∞ Gacha System</div>
                <p style="color: #bbb; font-size: 13px; margin-bottom: 15px; text-align: center;">
                    Usa i Mana Stones per aprire box e ottenere reward casuali!
                </p>
                
                <div class="gacha-container">
                    <div class="gacha-box common" onclick="openGachaBox('common')">
                        <div class="gacha-icon">üì¶</div>
                        <div class="gacha-name">Box Comune</div>
                        <div class="gacha-cost">üí∞ 10 Mana Stones</div>
                        <button class="gacha-btn">Apri Box</button>
                    </div>

                    <div class="gacha-box rare" onclick="openGachaBox('rare')">
                        <div class="gacha-icon">üéÅ</div>
                        <div class="gacha-name">Box Raro</div>
                        <div class="gacha-cost">üí∞ 50 Mana Stones</div>
                        <button class="gacha-btn">Apri Box</button>
                    </div>

                    <div class="gacha-box legendary" onclick="openGachaBox('legendary')">
                        <div class="gacha-icon">üíé</div>
                        <div class="gacha-name">Box Leggendario</div>
                        <div class="gacha-cost">üí∞ 200 Mana Stones</div>
                        <button class="gacha-btn">Apri Box</button>
                    </div>
                </div>

                <div id="gachaResult" style="margin-top: 20px; text-align: center; min-height: 100px;"></div>
            </div>
        </div>

        <!-- Tab: Shop -->
        <div id="tab-shop" class="tab-content">
            <div class="section">
                <div class="section-title">üé® Theme Store</div>
                <p style="color: #bbb; font-size: 13px; margin-bottom: 15px; text-align: center;">
                    Personalizza l'aspetto della tua app con temi unici!
                </p>

                <h3 style="color: #4ecdc4; margin: 20px 0 15px 0; text-align: center;">üíö Temi Base - ‚Ç¨0.50</h3>
                <div class="theme-grid" id="basicThemes"></div>

                <h3 style="color: #ffd700; margin: 30px 0 15px 0; text-align: center;">üëë Temi Premium - ‚Ç¨1.00</h3>
                <div class="theme-grid" id="premiumThemes"></div>

                <div style="margin-top: 30px; padding: 15px; background: rgba(255, 215, 0, 0.1); border-radius: 10px; text-align: center;">
                    <p style="color: #bbb; font-size: 12px; line-height: 1.6;">
                        ‚ÑπÔ∏è I temi acquistati sono permanenti e potrai cambiarli quando vuoi.<br>
                        L'acquisto supporta lo sviluppo continuo dell'app! üíñ
                    </p>
                </div>
            </div>
        </div>

        <!-- Tab: Settings -->
        <div id="tab-settings" class="tab-content">
            <div class="section">
                <div class="section-title">‚öôÔ∏è Impostazioni</div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px;">Nome Hunter:</label>
                    <input type="text" id="nameInput" placeholder="Inserisci il tuo nome" 
                           style="width: 100%; padding: 10px; border-radius: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(106, 90, 205, 0.5); color: white;">
                    <button onclick="saveName()" style="margin-top: 10px; width: 100%;" class="complete-btn">Salva Nome</button>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px;">Professione/Lavoro:</label>
                    <input type="text" id="professionInput" placeholder="Es: Programmatore, Studente, Chef, Medico..." 
                           style="width: 100%; padding: 10px; border-radius: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(106, 90, 205, 0.5); color: white;">
                    <button onclick="saveProfession()" style="margin-top: 10px; width: 100%;" class="complete-btn">Salva Professione</button>
                    <p style="font-size: 12px; color: #bbb; margin-top: 10px; line-height: 1.4;">
                        üí° Le quest verranno generate in base alla tua professione. Lascia vuoto per quest generali.
                    </p>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px;">
                        <input type="checkbox" id="notificationsEnabled" onchange="toggleNotifications()"> 
                        Abilita Notifiche Push
                    </label>
                </div>

                <button onclick="showWelcomeTutorial()" class="complete-btn" style="margin-bottom: 10px; width: 100%;">
                    üìñ Rivedi Tutorial
                </button>

                <div style="margin: 20px 0; padding: 20px; background: rgba(106, 90, 205, 0.1); border-radius: 10px; border: 1px solid rgba(106, 90, 205, 0.3);">
                    <h3 style="color: #ffd700; margin-bottom: 10px; text-align: center;">üíæ Backup & Recovery</h3>
                    <p style="color: #bbb; font-size: 13px; margin-bottom: 15px; text-align: center; line-height: 1.4;">
                        Proteggi i tuoi progressi! Esporta il salvataggio prima di ogni aggiornamento.
                    </p>
                    
                    <button onclick="exportSave()" class="complete-btn" style="width: 100%; margin-bottom: 10px;">
                        üì• Esporta Salvataggio
                    </button>
                    
                    <button onclick="document.getElementById('importFileInput').click()" class="complete-btn" style="width: 100%; background: #4ecdc4;">
                        üì§ Importa Salvataggio
                    </button>
                    <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="importSave(event)">
                    
                    <p style="font-size: 11px; color: #888; margin-top: 10px; text-align: center; line-height: 1.3;">
                        üí° Esporta regolarmente il tuo save! In caso di problemi potrai ripristinarlo.
                    </p>
                </div>
                
                <button onclick="resetProgress()" class="reset-btn" style="width: 100%;">üîÑ Reset Progresso</button>

                <div style="margin: 20px 0; padding: 20px; background: rgba(255,215,0,0.1); border-radius: 10px; text-align: center;">
                    <h3 style="color: #ffd700; margin-bottom: 10px;">üí™ Supporta lo sviluppo!</h3>
                    <p style="color: #bbb; font-size: 14px; margin-bottom: 15px;">Ogni donazione aiuta a migliorare l'app</p>
                    
                    <a href="https://revolut.me/tuonome" target="_blank" 
                       style="display: inline-block; padding: 15px 40px; background: #ffd700; color: #000; text-decoration: none; border-radius: 10px; font-weight: bold; font-size: 16px;">
                        üí≥ Dona con Revolut
                    </a>
                    
                    <p style="font-size: 11px; color: #888; margin-top: 15px;">‚ö†Ô∏è Sostituisci "tuonome" con il tuo username Revolut</p>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <button class="nav-btn active" onclick="switchTab('player')">
                <span class="nav-icon">üë§</span>
                <span>Player</span>
            </button>
            <button class="nav-btn" onclick="switchTab('quests')">
                <span class="nav-icon">üìã</span>
                <span>Quests</span>
            </button>
            <button class="nav-btn" onclick="switchTab('progress')">
                <span class="nav-icon">üìà</span>
                <span>Progress</span>
            </button>
            <button class="nav-btn" onclick="switchTab('inventory')">
                <span class="nav-icon">üéí</span>
                <span>Inventory</span>
            </button>
            <button class="nav-btn" onclick="switchTab('shop')">
                <span class="nav-icon">üõí</span>
                <span>Shop</span>
            </button>
            <button class="nav-btn" onclick="switchTab('settings')">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span>Settings</span>
            </button>
        </div>
    </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <!-- Login Bonus Modal -->
    <div class="login-bonus-modal" id="loginBonusModal" style="display:none;">
        <div class="login-bonus-content">
            <div style="font-size: 36px; margin-bottom: 5px;">üéÅ</div>
            <div style="font-size: 20px; font-weight: bold; color: #ffd700; margin-bottom: 5px;">DAILY LOGIN BONUS</div>
            <div style="font-size: 13px; color: #bbb; margin-bottom: 15px;">Il Sistema registra la tua presenza.</div>
            <div class="login-streak-row" id="loginStreakDots"></div>
            <div id="loginBonusDescription" style="font-size: 22px; font-weight: bold; color: #ffd700; margin: 15px 0;"></div>
            <div id="loginBonusExtra" style="font-size: 13px; color: #4ecdc4; margin-bottom: 5px;"></div>
            <button class="login-claim-btn" onclick="claimLoginBonus()">‚öîÔ∏è RITIRA RICOMPENSA</button>
        </div>
    </div>

    <!-- Death Screen -->
    <div class="death-screen" id="deathScreen">
        <div class="death-title">‚ö∞Ô∏è SEI MORTO ‚ö∞Ô∏è</div>
        <div class="death-timer" id="deathTimer">23:59:59</div>
        <div class="death-message">
            Hai raggiunto 0 HP.<br><br>
            Penalit√†:<br>
            - Perso 50% Mana Stones<br>
            - Perso progresso EXP verso prossimo livello<br>
            - Shadow Army ridotta di 1 livello<br><br>
            Resurrezione automatica tra...
        </div>
    </div>

    <!-- Add Item Modal -->
    <div id="addItemModal" class="modal">
        <div class="modal-content">
            <h3 style="color: #ffd700; margin-bottom: 20px;">‚ûï Aggiungi Oggetto</h3>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #bbb;">Icona (Emoji)</label>
                <input type="text" id="itemIcon" placeholder="üì¶" maxlength="2" 
                       style="width: 100%; padding: 10px; border-radius: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(106, 90, 205, 0.5); color: white; font-size: 20px; text-align: center;">
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #bbb;">Nome Oggetto</label>
                <input type="text" id="itemName" placeholder="Es: Laptop" 
                       style="width: 100%; padding: 10px; border-radius: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(106, 90, 205, 0.5); color: white;">
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #bbb;">Quantit√†</label>
                <input type="number" id="itemQuantity" value="1" min="1" 
                       style="width: 100%; padding: 10px; border-radius: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(106, 90, 205, 0.5); color: white;">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; color: #bbb;">Effetto Bonus (opzionale)</label>
                <select id="itemEffect" style="width: 100%; padding: 10px; border-radius: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(106, 90, 205, 0.5); color: white;">
                    <option value="">Nessun Effetto</option>
                    <option value="coding">+10% EXP Coding</option>
                    <option value="study">+10% EXP Studio</option>
                    <option value="fitness">+10% EXP Fitness</option>
                    <option value="creative">+10% EXP Creativit√†</option>
                    <option value="hp_regen">+5 HP ogni giorno</option>
                    <option value="mp_regen">+3 MP ogni giorno</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button onclick="addItemToInventory()" class="complete-btn" style="flex: 1;">Aggiungi</button>
                <button onclick="closeAddItemModal()" class="reset-btn" style="flex: 1;">Annulla</button>
            </div>
        </div>
    </div>

    <!-- Create Quest Modal -->
    <div id="createQuestModal" class="modal">
        <div class="modal-content">
            <h3 style="color: #ffd700; margin-bottom: 20px;">‚úèÔ∏è Crea Quest Personalizzata</h3>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #bbb;">Titolo Quest</label>
                <input type="text" id="customQuestTitle" placeholder="Es: Finire progetto X" 
                       style="width: 100%; padding: 10px; border-radius: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(106, 90, 205, 0.5); color: white;">
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #bbb;">Descrizione</label>
                <textarea id="customQuestDesc" placeholder="Descrivi cosa devi fare..." rows="3"
                       style="width: 100%; padding: 10px; border-radius: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(106, 90, 205, 0.5); color: white; resize: none;"></textarea>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; color: #bbb;">Difficolt√† Stimata</label>
                <select id="customQuestDifficulty" style="width: 100%; padding: 10px; border-radius: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(106, 90, 205, 0.5); color: white;">
                    <option value="easy">Facile (30-40 EXP)</option>
                    <option value="medium">Media (50-70 EXP)</option>
                    <option value="hard">Difficile (80-100 EXP)</option>
                    <option value="extreme">Estrema (120-150 EXP)</option>
                </select>
            </div>

            <div style="margin-bottom: 20px; padding: 15px; background: rgba(106, 90, 205, 0.1); border-radius: 10px; border: 1px solid rgba(106, 90, 205, 0.3);">
                <label style="display: block; margin-bottom: 10px; color: #ffd700; font-weight: bold;">üîÑ Ricorrenza</label>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer;">
                        <input type="radio" name="recurrence" value="once" checked onchange="toggleRecurrenceOptions()" style="margin-right: 8px;">
                        <span style="color: #ddd;">Una volta sola</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="radio" name="recurrence" value="recurring" onchange="toggleRecurrenceOptions()" style="margin-right: 8px;">
                        <span style="color: #ddd;">Ricorrente</span>
                    </label>
                </div>

                <div id="recurrenceOptions" style="display: none; margin-top: 15px; padding-left: 10px;">
                    <label style="display: block; margin-bottom: 10px; color: #bbb;">Quando ripetere?</label>
                    
                    <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer;">
                        <input type="radio" name="recurrenceType" value="daily" checked style="margin-right: 8px;">
                        <span style="color: #ddd;">Ogni giorno</span>
                    </label>
                    
                    <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer;">
                        <input type="radio" name="recurrenceType" value="weekdays" style="margin-right: 8px;">
                        <span style="color: #ddd;">Solo giorni lavorativi (Lun-Ven)</span>
                    </label>
                    
                    <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer;">
                        <input type="radio" name="recurrenceType" value="weekend" style="margin-right: 8px;">
                        <span style="color: #ddd;">Solo weekend (Sab-Dom)</span>
                    </label>
                    
                    <label style="display: flex; align-items: center; margin-bottom: 12px; cursor: pointer;">
                        <input type="radio" name="recurrenceType" value="specific" onchange="toggleDaySelector()" style="margin-right: 8px;">
                        <span style="color: #ddd;">Giorni specifici:</span>
                    </label>
                    
                    <div id="daySelector" style="display: none; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-left: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px;">
                            <label style="display: flex; flex-direction: column; align-items: center; cursor: pointer;">
                                <input type="checkbox" class="day-checkbox" value="1" style="margin-bottom: 4px;">
                                <span style="font-size: 12px; color: #bbb;">Lun</span>
                            </label>
                            <label style="display: flex; flex-direction: column; align-items: center; cursor: pointer;">
                                <input type="checkbox" class="day-checkbox" value="2" style="margin-bottom: 4px;">
                                <span style="font-size: 12px; color: #bbb;">Mar</span>
                            </label>
                            <label style="display: flex; flex-direction: column; align-items: center; cursor: pointer;">
                                <input type="checkbox" class="day-checkbox" value="3" style="margin-bottom: 4px;">
                                <span style="font-size: 12px; color: #bbb;">Mer</span>
                            </label>
                            <label style="display: flex; flex-direction: column; align-items: center; cursor: pointer;">
                                <input type="checkbox" class="day-checkbox" value="4" style="margin-bottom: 4px;">
                                <span style="font-size: 12px; color: #bbb;">Gio</span>
                            </label>
                            <label style="display: flex; flex-direction: column; align-items: center; cursor: pointer;">
                                <input type="checkbox" class="day-checkbox" value="5" style="margin-bottom: 4px;">
                                <span style="font-size: 12px; color: #bbb;">Ven</span>
                            </label>
                            <label style="display: flex; flex-direction: column; align-items: center; cursor: pointer;">
                                <input type="checkbox" class="day-checkbox" value="6" style="margin-bottom: 4px;">
                                <span style="font-size: 12px; color: #bbb;">Sab</span>
                            </label>
                            <label style="display: flex; flex-direction: column; align-items: center; cursor: pointer;">
                                <input type="checkbox" class="day-checkbox" value="0" style="margin-bottom: 4px;">
                                <span style="font-size: 12px; color: #bbb;">Dom</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button onclick="createCustomQuest()" class="complete-btn" style="flex: 1;">Crea Quest</button>
                <button onclick="closeCreateQuestModal()" class="reset-btn" style="flex: 1;">Annulla</button>
            </div>
        </div>
    </div>

    <script>
        // Machiavellian Quotes
        const machiavelliQuotes = {
            daily: [
                "√à meglio essere temuto che amato, se non si pu√≤ essere entrambi.",
                "Il fine giustifica i mezzi. Sempre.",
                "Chi esita √® perduto. Chi attacca primo controlla il campo.",
                "La fortuna favorisce chi sa coglierla, non chi la aspetta.",
                "Non chiedere permesso. Chiedi perdono dopo aver vinto.",
                "Ogni battaglia vinta prima di essere combattuta √® pura strategia.",
                "La debolezza invita l'aggressione. La forza impone rispetto.",
                "Chi sa fingere regna. Chi mostra tutto perde.",
                "Al vertice si √® sempre soli. Abituati.",
                "La piet√† verso i nemici √® crudelt√† verso te stesso.",
                "I principi morali non conquistano regni.",
                "L'ambizione senza azione √® solo un sogno.",
                "Prendi tutto. Non lasciare nulla agli altri.",
                "O domini o sei dominato. Non c'√® via di mezzo.",
                "Nessuno ti dar√† niente. Prendi tutto.",
                "L'unico su cui puoi contare sei tu stesso."
            ]
        };

        // Theme Definitions
        const themes = {
            basic: [ // ‚Ç¨0.50 themes
                { id: 'forest', name: 'Foresta', price: 0.50, gradient: 'linear-gradient(135deg, #134e13 0%, #0a290a 100%)', primary: '#2d5016', secondary: '#1a3409' },
                { id: 'ocean', name: 'Oceano', price: 0.50, gradient: 'linear-gradient(135deg, #006994 0%, #003d5c 100%)', primary: '#0077b6', secondary: '#023e8a' },
                { id: 'sunset', name: 'Tramonto', price: 0.50, gradient: 'linear-gradient(135deg, #ff6b6b 0%, #8b3a62 100%)', primary: '#c9184a', secondary: '#590d22' },
                { id: 'lavender', name: 'Lavanda', price: 0.50, gradient: 'linear-gradient(135deg, #7209b7 0%, #3c096c 100%)', primary: '#5a189a', secondary: '#240046' },
                { id: 'emerald', name: 'Smeraldo', price: 0.50, gradient: 'linear-gradient(135deg, #2d6a4f 0%, #1b4332 100%)', primary: '#40916c', secondary: '#081c15' },
                { id: 'ruby', name: 'Rubino', price: 0.50, gradient: 'linear-gradient(135deg, #9d0208 0%, #6a040f 100%)', primary: '#dc2f02', secondary: '#370617' },
                { id: 'sapphire', name: 'Zaffiro', price: 0.50, gradient: 'linear-gradient(135deg, #023e8a 0%, #001d3d 100%)', primary: '#0353a4', secondary: '#000814' },
                { id: 'amber', name: 'Ambra', price: 0.50, gradient: 'linear-gradient(135deg, #f77f00 0%, #d62828 100%)', primary: '#dc2f02', secondary: '#6a040f' },
                { id: 'mint', name: 'Menta', price: 0.50, gradient: 'linear-gradient(135deg, #52b788 0%, #2d6a4f 100%)', primary: '#40916c', secondary: '#1b4332' },
                { id: 'coral', name: 'Corallo', price: 0.50, gradient: 'linear-gradient(135deg, #ff6d00 0%, #ff0054 100%)', primary: '#ff4d6d', secondary: '#c9184a' }
            ],
            premium: [ // ‚Ç¨1.00 themes
                { id: 'shadow', name: 'Ombra', price: 1.00, gradient: 'linear-gradient(135deg, #1a1a1a 0%, #000000 100%)', primary: '#212529', secondary: '#000000' },
                { id: 'neon', name: 'Neon', price: 1.00, gradient: 'linear-gradient(135deg, #ff006e 0%, #8338ec 100%)', primary: '#3a0ca3', secondary: '#7209b7' },
                { id: 'galaxy', name: 'Galassia', price: 1.00, gradient: 'linear-gradient(135deg, #240046 0%, #10002b 100%)', primary: '#3c096c', secondary: '#10002b' },
                { id: 'gold', name: 'Oro', price: 1.00, gradient: 'linear-gradient(135deg, #ffd60a 0%, #d4a216 100%)', primary: '#ffd60a', secondary: '#8d6e17' },
                { id: 'ice', name: 'Ghiaccio', price: 1.00, gradient: 'linear-gradient(135deg, #e0f2fe 0%, #7dd3fc 100%)', primary: '#38bdf8', secondary: '#0284c7' },
                { id: 'fire', name: 'Fuoco', price: 1.00, gradient: 'linear-gradient(135deg, #ff0000 0%, #8b0000 100%)', primary: '#dc2626', secondary: '#7f1d1d' },
                { id: 'midnight', name: 'Mezzanotte', price: 1.00, gradient: 'linear-gradient(135deg, #0f172a 0%, #020617 100%)', primary: '#1e293b', secondary: '#020617' },
                { id: 'rose', name: 'Rosa', price: 1.00, gradient: 'linear-gradient(135deg, #fda4af 0%, #be123c 100%)', primary: '#fb7185', secondary: '#9f1239' },
                { id: 'toxic', name: 'Tossico', price: 1.00, gradient: 'linear-gradient(135deg, #84cc16 0%, #365314 100%)', primary: '#65a30d', secondary: '#3f6212' },
                { id: 'royal', name: 'Reale', price: 1.00, gradient: 'linear-gradient(135deg, #6366f1 0%, #312e81 100%)', primary: '#4f46e5', secondary: '#312e81' }
            ]
        };

        function getDailyQuote() {
            const today = new Date().toDateString();
            const stored = localStorage.getItem('dailyQuoteDate');
            if (stored !== today) {
                const randomQuote = machiavelliQuotes.daily[Math.floor(Math.random() * machiavelliQuotes.daily.length)];
                localStorage.setItem('dailyQuote', randomQuote);
                localStorage.setItem('dailyQuoteDate', today);
            }
            return localStorage.getItem('dailyQuote') || machiavelliQuotes.daily[0];
        }

        function startApp() {
            localStorage.setItem('welcomeShown', 'true');
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            loadGame();
        }

        function showWelcomeTutorial() {
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('welcomeScreen').style.display = 'block';
        }

        // Stat mapping
        const statNames = {
            str: 'Forza',
            agi: 'Agilit√†',
            int: 'Intelligenza',
            vit: 'Vitalit√†',
            sen: 'Sensi',
            luck: 'Fortuna'
        };

        const statCategories = {
            str: 'physical',
            agi: 'physical',
            vit: 'health',
            int: 'intelligence',
            sen: 'social',
            luck: 'productivity'
        };

        // Game State
        let gameState = {
            version: "1.3.0", // VERSIONING SYSTEM - Updated for themes & gacha
            devMessageShown: false, // Track if developer message was shown
            purchasedThemes: [], // Track purchased themes
            activeTheme: 'default', // Current active theme
            player: {
                name: "Hunter Novizio",
                level: 1,
                exp: 0,
                hp: 100,
                maxHP: 100,
                mp: 50,
                maxMP: 50,
                stats: {
                    str: 10,
                    agi: 10,
                    int: 10,
                    vit: 10,
                    sen: 10,
                    luck: 10
                },
                statExp: {
                    str: 0,
                    agi: 0,
                    int: 0,
                    vit: 0,
                    sen: 0,
                    luck: 0
                },
                statPoints: 0,
                skillPoints: 0,
                rank: 'E',
                jobClass: 'none',
                profession: 'none',
                activeTitle: null,
                statusEffects: [],
                deathTime: null,
                streak: 0,
                lastQuestDate: null,
                radarStats: {
                    physical: 0,
                    intelligence: 0,
                    health: 0,
                    social: 0,
                    productivity: 0,
                    creativity: 0
                }
            },
            inventory: {
                manaStones: 0,
                items: []
            },
            quests: {
                daily: [],
                emergency: null,
                boss: null,
                custom: []
            },
            shadowArmy: [],
            achievements: [],
            skills: [],
            history: {
                yesterday: { quests: 0, exp: 0 },
                lastWeek: { quests: 0, exp: 0 },
                lastMonth: { quests: 0, exp: 0 }
            },
            lastDailyReset: null,
            lastWeeklyReset: null,
            lastEmergencyCheck: null,
            notificationsEnabled: false,
            firstLoginDate: null,
            totalDaysUsed: 0,
            milestonesReached: [],
            completionCalendar: {}, // formato: "2026-02-20": { completed: true/false, total: 5, done: 5 }
            dungeon: null, // { theme, rooms, hp, weekKey, completed, abandoned }
            weeklyJudgment: {
                history: [],
                lastJudgmentWeek: null
            },
            archivioUnlocked: ['cap_0'], // Chapter 0 always unlocked
            loginBonus: {
                lastLoginDate: null,
                loginStreak: 0,
                claimedToday: false
            }
        };

        // Quest templates by category
        const questTemplates = {
            fitness: [
                { title: "Allenamento Mattutino", description: "100 flessioni, 100 addominali, 100 squat", reward: 50, category: "physical" },
                { title: "Cardio Training", description: "Corri per 5km o 30 minuti", reward: 45, category: "physical" },
                { title: "Stretching", description: "15 minuti di stretching completo", reward: 30, category: "physical" },
                { title: "Forza", description: "Allenamento pesi per 45 minuti", reward: 55, category: "physical" },
                { title: "Yoga Session", description: "30 minuti di yoga", reward: 40, category: "physical" }
            ],
            mental: [
                { title: "Meditazione", description: "Medita per 15 minuti", reward: 30, category: "intelligence" },
                { title: "Lettura", description: "Leggi per 30 minuti", reward: 40, category: "intelligence" },
                { title: "Journaling", description: "Scrivi nel tuo diario per 10 minuti", reward: 25, category: "intelligence" },
                { title: "Apprendimento", description: "Studia qualcosa di nuovo per 1 ora", reward: 60, category: "intelligence" }
            ],
            health: [
                { title: "Idratazione", description: "Bevi 2 litri d'acqua", reward: 20, category: "health" },
                { title: "Alimentazione Sana", description: "Mangia 5 porzioni di frutta/verdura", reward: 35, category: "health" },
                { title: "Sonno", description: "Dormi almeno 7 ore", reward: 30, category: "health" },
                { title: "No Junk Food", description: "Evita cibo spazzatura tutto il giorno", reward: 40, category: "health" }
            ],
            social: [
                { title: "Connessione Sociale", description: "Chiama un amico o familiare", reward: 35, category: "social" },
                { title: "Atto di Gentilezza", description: "Fai un gesto gentile per qualcuno", reward: 40, category: "social" },
                { title: "Networking", description: "Incontra una nuova persona", reward: 50, category: "social" }
            ],
            productivity: [
                { title: "Deep Work", description: "2 ore di lavoro concentrato senza distrazioni", reward: 70, category: "productivity" },
                { title: "Organizzazione", description: "Organizza la tua giornata e priorit√†", reward: 30, category: "productivity" },
                { title: "Pulizia Spazio", description: "Pulisci e organizza il tuo spazio di lavoro", reward: 35, category: "productivity" },
                { title: "Email Zero", description: "Svuota la inbox email", reward: 40, category: "productivity" }
            ],
            programmer: [
                { title: "Code Review", description: "Rivedi e refactorizza 100 righe di codice", reward: 60, category: "productivity" },
                { title: "Bug Hunting", description: "Risolvi almeno 3 bug", reward: 70, category: "productivity" },
                { title: "New Feature", description: "Implementa una nuova funzionalit√†", reward: 80, category: "productivity" },
                { title: "Documentazione", description: "Documenta il codice scritto oggi", reward: 50, category: "productivity" },
                { title: "Learning", description: "Impara un nuovo framework/linguaggio per 1h", reward: 65, category: "intelligence" }
            ],
            student: [
                { title: "Studio Intensivo", description: "Studia per 3 ore", reward: 70, category: "intelligence" },
                { title: "Esercizi", description: "Completa 20 esercizi", reward: 60, category: "intelligence" },
                { title: "Ripasso", description: "Ripassa gli appunti della settimana", reward: 50, category: "intelligence" },
                { title: "Progetto", description: "Lavora al progetto per 2 ore", reward: 75, category: "productivity" }
            ],
            creative: [
                { title: "Creazione Artistica", description: "Crea qualcosa per 1 ora (arte, musica, scrittura)", reward: 60, category: "creativity" },
                { title: "Brainstorming", description: "Genera 20 nuove idee per progetti", reward: 45, category: "creativity" },
                { title: "Portfolio", description: "Aggiungi un pezzo al tuo portfolio", reward: 70, category: "creativity" }
            ],
            business: [
                { title: "Strategia", description: "Pianifica la strategia della settimana", reward: 65, category: "productivity" },
                { title: "Client Meeting", description: "Incontra un cliente o potenziale cliente", reward: 70, category: "social" },
                { title: "Marketing", description: "Crea contenuto per social/marketing", reward: 60, category: "creativity" },
                { title: "Financial Review", description: "Analizza finanze e metriche", reward: 55, category: "intelligence" }
            ]
        };

        // Emergency Quest Templates
        const emergencyQuestTemplates = {
            programmer: [
                { title: "üö® Critical Bug in Production", description: "Bug critico in produzione! Risolvilo entro 4 ore", reward: 200 },
                { title: "‚ö° Hackathon Challenge", description: "Crea un'app funzionante in 12 ore", reward: 250 },
                { title: "üî• Hotfix Required", description: "Deploy hotfix entro 3 ore", reward: 180 }
            ],
            student: [
                { title: "üìö Exam Preparation Sprint", description: "Studia 8 ore no-stop per l'esame", reward: 220 },
                { title: "üìù Last Minute Assignment", description: "Completa tutto il progetto oggi", reward: 200 },
                { title: "üéØ Final Preparation", description: "Ripassa tutto il materiale in 10 ore", reward: 210 }
            ],
            business: [
                { title: "üíº Closing Deal", description: "Chiudi un contratto importante oggi", reward: 300 },
                { title: "üéØ Pitch Perfect", description: "Prepara e presenta pitch perfetto in 6 ore", reward: 230 },
                { title: "üìä Crisis Management", description: "Risolvi la crisi aziendale entro 8 ore", reward: 250 }
            ],
            creative: [
                { title: "üé® Deadline Crunch", description: "Completa il progetto creativo entro 10 ore", reward: 240 },
                { title: "‚ú® Creative Marathon", description: "Crea 5 pezzi di qualit√† oggi", reward: 220 },
                { title: "üöÄ Launch Day", description: "Finalizza e lancia il progetto oggi", reward: 260 }
            ],
            general: [
                { title: "üí™ 100 Days Tribute", description: "200 flessioni + 200 squat + 20km oggi", reward: 180 },
                { title: "üèÉ Marathon Challenge", description: "Corri una mezza maratona oggi", reward: 250 },
                { title: "üßò Zen Master", description: "Medita per 3 ore totali oggi", reward: 150 }
            ]
        };

        // Boss Quest Templates
        // Weekly Rotating Boss System
        const weeklyBosses = [
            {
                id: 'procrastination_demon',
                name: 'üëπ Procrastination Demon',
                subtitle: '"L\'Eterno Domani"',
                lore: 'Si nutre di ogni task che rimandi. Pi√π aspetti, pi√π diventa forte.',
                baseReward: 500,
                phases: [
                    { threshold: 0.7, title: 'Fase I ‚Äî Il Sussurro', desc: 'Completa almeno 3 quest daily questa settimana.', partialReward: 100 },
                    { threshold: 0.4, title: 'Fase II ‚Äî La Tentazione', desc: 'Completa il 70% delle quest giornaliere per 3 giorni di fila.', partialReward: 150 },
                    { threshold: 0, title: 'Fase III ‚Äî Lo Scontro Finale', desc: 'Completa TUTTE le quest di oggi pi√π 1 quest personalizzata difficile.', partialReward: 0 }
                ],
                defeatTitle: 'üí™ Nemico della Procrastina',
                defeatReward: 500
            },
            {
                id: 'distraction_dragon',
                name: 'üêâ Distraction Dragon',
                subtitle: '"Il Consumatore di Focus"',
                lore: 'Ogni notifica √® una scaglia. Ogni social aperto √® un respiro di fuoco.',
                baseReward: 550,
                phases: [
                    { threshold: 0.7, title: 'Fase I ‚Äî Le Scaglie', desc: 'Non aprire social media per 24 ore (1 giorno questa settimana).', partialReward: 110 },
                    { threshold: 0.4, title: 'Fase II ‚Äî Il Fuoco', desc: 'Completa una sessione deep work da 2 ore senza interruzioni.', partialReward: 160 },
                    { threshold: 0, title: 'Fase III ‚Äî La Testa del Drago', desc: 'Giornata offline: 8 ore di focus puro. Nessuna distrazione.', partialReward: 0 }
                ],
                defeatTitle: 'üß† Mente Indistruttibile',
                defeatReward: 550
            },
            {
                id: 'laziness_lich',
                name: 'üíÄ Laziness Lich',
                subtitle: '"Il Re Immortale del Divano"',
                lore: 'Non combatte. Aspetta. Sa che prima o poi ti siederai.',
                baseReward: 520,
                phases: [
                    { threshold: 0.7, title: 'Fase I ‚Äî L\'Apatia', desc: 'Completa una quest fisica ogni giorno per 3 giorni.', partialReward: 100 },
                    { threshold: 0.4, title: 'Fase II ‚Äî Il Torpore', desc: 'Alzati e inizia la prima quest entro 30 minuti dal risveglio per 2 giorni.', partialReward: 150 },
                    { threshold: 0, title: 'Fase III ‚Äî Il Trono del Nulla', desc: 'Completa TUTTE le quest giornaliere per 2 giorni consecutivi questa settimana.', partialReward: 0 }
                ],
                defeatTitle: '‚ö° Energia Infinita',
                defeatReward: 520
            },
            {
                id: 'imposter_specter',
                name: 'üëª Imposter Specter',
                subtitle: '"Non Sei Abbastanza"',
                lore: 'Vive nella tua testa. Si nutre di ogni dubbio, ogni confronto, ogni "non ce la faccio".',
                baseReward: 580,
                phases: [
                    { threshold: 0.7, title: 'Fase I ‚Äî Il Dubbio', desc: 'Scrivi 3 cose che hai fatto bene questa settimana. Sulla carta. Per davvero.', partialReward: 115 },
                    { threshold: 0.4, title: 'Fase II ‚Äî Il Confronto', desc: 'Completa una quest al di fuori della tua comfort zone.', partialReward: 165 },
                    { threshold: 0, title: 'Fase III ‚Äî Lo Specchio', desc: 'Parla delle tue capacit√† a qualcuno. O scrivi chi sei diventato in questi mesi.', partialReward: 0 }
                ],
                defeatTitle: 'üîÆ Mente Cristallina',
                defeatReward: 580
            }
        ];

        // RAID BOSS (ogni 4 settimane)
        const raidBoss = {
            id: 'raid_chaos_sovereign',
            name: 'üëë CHAOS SOVEREIGN',
            subtitle: '"Il Signore del Caos ‚Äî RAID BOSS"',
            lore: 'Appare ogni 28 giorni. √à la somma di tutte le tue debolezze, amplificata. Non esiste seconda possibilit√†.',
            baseReward: 2000,
            isRaid: true,
            phases: [
                { threshold: 0.7, title: 'FASE I ‚Äî Il Caos Primordiale', desc: 'Completa il 100% delle quest giornaliere per 2 giorni questa settimana.', partialReward: 300 },
                { threshold: 0.4, title: 'FASE II ‚Äî La Tempesta', desc: 'Completa il Boss Fight normale + 3 giorni perfetti consecutivi.', partialReward: 500 },
                { threshold: 0, title: 'FASE III ‚Äî Il Sovrano', desc: 'Settimana perfetta: 100% quest + boss + dungeon. Nessun compromesso.', partialReward: 0 }
            ],
            defeatTitle: '‚öîÔ∏è Cacciatore del Caos',
            defeatReward: 2000,
            extraRewards: ['+1 Shadow Army Slot', '+50 a tutti gli Stat', '+500 Mana Stones']
        };

        const bossQuestTemplates = {
            programmer: [
                { title: "üíÄ Final Boss: Major Release", description: "Completa e deploya un major release questa settimana con zero bug critici", reward: 500 }
            ],
            student: [
                { title: "üíÄ Final Boss: Perfect Week", description: "Completa tutti gli assignment + studia 40 ore questa settimana", reward: 500 }
            ],
            business: [
                { title: "üíÄ Final Boss: Growth Sprint", description: "Ottieni 10 nuovi clienti questa settimana", reward: 600 }
            ],
            creative: [
                { title: "üíÄ Final Boss: Creative Marathon", description: "Completa 3 progetti maggiori questa settimana", reward: 550 }
            ],
            general: [
                { title: "üíÄ Final Boss: Perfect Week", description: "Completa TUTTE le quest giornaliere per 7 giorni + 50km corsa totale", reward: 500 }
            ]
        };

        // Achievements definitions
        const achievementDefinitions = [
            { id: 'iron_will', icon: 'üí™', title: 'Iron Will', desc: '30 giorni streak', unlocked: false, bonus: '+10 HP permanente' },
            { id: 'early_bird', icon: 'üåÖ', title: 'Early Bird', desc: 'Quest prima 8am x7 giorni', unlocked: false, bonus: '+5% EXP mattina' },
            { id: 'perfectionist', icon: '‚ú®', title: 'Perfectionist', desc: '100% quest x1 mese', unlocked: false, bonus: '+10% EXP totale' },
            { id: 'shadow_master', icon: 'üë•', title: 'Shadow Master', desc: '10 Shadow Army attive', unlocked: false, bonus: '+20 MP permanente' },
            { id: 'survivor', icon: '‚ö∞Ô∏è', title: 'Survivor', desc: 'Resurrezione da morte', unlocked: false, bonus: '+15% HP regen' },
            { id: 'scholar', icon: 'üìö', title: 'Scholar', desc: '100 quest intellettuali', unlocked: false, bonus: '+15 INT' },
            { id: 'warrior', icon: '‚öîÔ∏è', title: 'Warrior', desc: '100 quest fisiche', unlocked: false, bonus: '+15 STR' },
            { id: 'emergency_hero', icon: 'üö®', title: 'Emergency Hero', desc: '5 Emergency Quest completate', unlocked: false, bonus: '+100 HP max' }
        ];

        // Skills definitions
        const skillDefinitions = {
            combat: [
                { id: 'second_wind', name: 'Second Wind', desc: 'Recupera 20 HP 1 volta al giorno', cost: 1, unlocked: false },
                { id: 'berserker', name: 'Berserker', desc: '+50% EXP quando HP < 20%', cost: 2, unlocked: false, requires: 'second_wind' },
                { id: 'immortal', name: 'Immortal', desc: 'Sopravvivi a 0 HP 1 volta (no death penalty)', cost: 3, unlocked: false, requires: 'berserker' }
            ],
            magic: [
                { id: 'mana_boost', name: 'Mana Boost', desc: '+20 MP max', cost: 1, unlocked: false },
                { id: 'double_exp', name: 'Double EXP', desc: '1 quest al giorno d√† 2x EXP', cost: 2, unlocked: false, requires: 'mana_boost' },
                { id: 'time_master', name: 'Time Master', desc: '+2 ore su deadline Emergency Quest', cost: 3, unlocked: false, requires: 'double_exp' }
            ],
            support: [
                { id: 'lucky_charm', name: 'Lucky Charm', desc: '+10% chance Emergency Quest', cost: 1, unlocked: false },
                { id: 'wealthy', name: 'Wealthy', desc: '+50% Mana Stones da quest', cost: 2, unlocked: false, requires: 'lucky_charm' },
                { id: 'master_crafter', name: 'Master Crafter', desc: 'Sblocca ricette rare', cost: 3, unlocked: false, requires: 'wealthy' }
            ]
        };

        // Crafting recipes
        const craftingRecipes = [
            { 
                id: 'hp_potion', 
                name: '‚ù§Ô∏è HP Potion', 
                materials: [{ name: 'Mana Stones', count: 50 }], 
                result: { type: 'consumable', effect: 'restore_hp', value: 50 },
                unlocked: true 
            },
            { 
                id: 'exp_boost', 
                name: '‚≠ê EXP Boost', 
                materials: [{ name: 'Mana Stones', count: 100 }], 
                result: { type: 'buff', effect: 'exp_boost', value: 20, duration: 3600000 },
                unlocked: true 
            },
            { 
                id: 'shield', 
                name: 'üõ°Ô∏è Emergency Shield', 
                materials: [{ name: 'Mana Stones', count: 200 }], 
                result: { type: 'buff', effect: 'damage_reduction', value: 50, duration: 86400000 },
                unlocked: false 
            }
        ];

        // Job Classes
        const jobClasses = {
            E: { name: 'Nessuna Classe', bonuses: {} },
            D: { name: 'Nessuna Classe', bonuses: {} },
            C: { 
                options: ['Tank', 'Assassin', 'Mage'],
                Tank: { name: 'Tank', bonuses: { hp: 50, def: 20 } },
                Assassin: { name: 'Assassin', bonuses: { agi: 15, crit: 10 } },
                Mage: { name: 'Mage', bonuses: { int: 15, mp: 30 } }
            },
            B: { name: 'Inherited from C', bonuses: {} },
            A: {
                options: ['Shadow Monarch', 'Berserker', 'Sage'],
                'Shadow Monarch': { name: 'Shadow Monarch', bonuses: { shadow_power: 50 } },
                Berserker: { name: 'Berserker', bonuses: { str: 25, hp: 100 } },
                Sage: { name: 'Sage', bonuses: { int: 25, mp: 50 } }
            },
            S: { name: 'Inherited from A', bonuses: {} },
            NATIONAL: { name: 'National Level Hunter', bonuses: { all_stats: 50 } }
        };

        const dungeonThemes = [
            {
                name: "Abisso della Procrastinazione",
                icon: "‚è≥",
                description: "Un luogo senza tempo dove le tue task si accumulano all'infinito.",
                rooms: [
                    { title: "La Stanza del Rimando", description: "Completa qualcosa che rimandi da almeno 3 giorni. Non scuse. Non domani. ADESSO.", reward: 150, mana: 30 },
                    { title: "Corridoio delle Distrazioni", description: "Lavora 2 ore in modalit√† focus assoluto: telefono spento, niente social.", reward: 180, mana: 40 },
                    { title: "Il Vault delle Task Dimenticate", description: "Fai una lista completa di tutto ci√≤ che hai dimenticato di fare. Poi inizia.", reward: 120, mana: 25 },
                    { title: "Camera del Giudizio Differito", description: "Fai una cosa difficile che eviti da una settimana. Qualunque cosa.", reward: 200, mana: 50 },
                    { title: "BOSS: Il Grande Rimandatore", description: "Completa 3 task importanti in un'unica sessione senza interruzioni. Sconfiggi la tua versione peggiore.", reward: 350, mana: 100 }
                ]
            },
            {
                name: "Inferno del Debug",
                icon: "üî•",
                description: "Bug senza nome. Errori senza origine. Benvenuto nel tuo quotidiano.",
                rooms: [
                    { title: "Init: Stack Overflow dell'Anima", description: "Risolvi un problema tecnico o intellettuale che ti blocca da giorni.", reward: 160, mana: 35 },
                    { title: "Runtime Error: La Crisi", description: "Scrivi un piano d'azione per il tuo problema pi√π grande. Step by step.", reward: 140, mana: 30 },
                    { title: "Null Pointer: La Svolta", description: "Chiedi aiuto a qualcuno per qualcosa. L'orgoglio √® un bug.", reward: 120, mana: 25 },
                    { title: "Refactor: Ri-pensa Te Stesso", description: "Identifica 3 abitudini tossiche e scrivi come eliminarle.", reward: 170, mana: 40 },
                    { title: "BOSS: Fatal Exception", description: "Risolvi il problema pi√π complesso che hai aperto. Fino alla fine. Zero workaround.", reward: 400, mana: 120 }
                ]
            },
            {
                name: "Labirinto della Distrazione",
                icon: "üåÄ",
                description: "Ogni corridoio porta altrove. Ogni scelta ti allontana. Trova il centro.",
                rooms: [
                    { title: "L'Eco Camera", description: "Spegni tutti i social per 24 ore. Vivi nel silenzio.", reward: 130, mana: 30 },
                    { title: "Il Passaggio dell'Inganno", description: "Fai sport o attivit√† fisica per almeno 45 minuti. Il corpo non mente.", reward: 150, mana: 35 },
                    { title: "La Stanza degli Specchi", description: "Scrivi 300 parole oneste su dove sei e dove vuoi essere.", reward: 170, mana: 40 },
                    { title: "Il Corridoio del Tempo Perso", description: "Calcola quante ore hai sprecato questa settimana. Poi recupera almeno 2.", reward: 140, mana: 30 },
                    { title: "BOSS: Il Labirinto Finale", description: "Giornata zero-distrazione: completa 5 task in sequenza senza interruzioni. Dimostra chi sei.", reward: 380, mana: 110 }
                ]
            },
            {
                name: "Cripta del Fallimento",
                icon: "‚ò†Ô∏è",
                description: "I fallimenti non muoiono. Si trasformano. Vieni a vedere cosa sei diventato.",
                rooms: [
                    { title: "La Tomba del Progetto Abbandonato", description: "Riprendi qualcosa che hai abbandonato. Almeno un'ora.", reward: 180, mana: 40 },
                    { title: "Il Sarcofago dell'Errore", description: "Scrivi 3 errori che hai fatto e cosa hai imparato. Senza piet√†.", reward: 140, mana: 30 },
                    { title: "La Camera della Vergogna", description: "Fai una scusa genuina a qualcuno che hai deluso. O a te stesso.", reward: 120, mana: 25 },
                    { title: "Il Corridoio dei Maybe", description: "Prendi 3 decisioni che rimandavi da settimane. Irreversibili.", reward: 200, mana: 50 },
                    { title: "BOSS: Il Fantasma di Chi Potevi Essere", description: "Passa l'intera giornata come la persona che vuoi diventare. Nessuna scusa.", reward: 420, mana: 130 }
                ]
            },
            {
                name: "Fortezza dello Status Quo",
                icon: "üè∞",
                description: "Le mura sono comode. La prigione dorata si chiama comfort zone.",
                rooms: [
                    { title: "Il Portone dell'Abitudine", description: "Rompi una routine negativa oggi. Una sola. Ma concretamente.", reward: 140, mana: 30 },
                    { title: "Le Mura della Paura", description: "Fai una cosa che ti spaventa. Piccola o grande, non importa. Falla.", reward: 200, mana: 50 },
                    { title: "La Torre dell'Isolamento", description: "Connettiti davvero con qualcuno: chiama un amico, incontra qualcuno.", reward: 130, mana: 28 },
                    { title: "Il Trono del Complaisance", description: "Impara qualcosa di completamente nuovo oggi. Almeno 1 ora.", reward: 160, mana: 38 },
                    { title: "BOSS: Il Re del Mediocre", description: "Fai la cosa pi√π ambiziosa della tua settimana. Quella che richiede coraggio.", reward: 450, mana: 140 }
                ]
            }
        ];

        const judgmentComments = {
            S: [
                "Inaspettato. Persino io fatico ad ignorarlo. Ma non illuderti ‚Äî la perfezione di oggi √® la mediocrit√† di domani.",
                "Hai superato le aspettative del Sistema. Non chiedertene il motivo. Limitati a farlo ancora.",
                "Eccellenza rilevata. Il Sistema lo registra senza emozione. Sentirsi orgogliosi √® un privilegio dei deboli."
            ],
            A: [
                "Prestazione solida. Quasi degna di nota. Ma 'quasi' √® il confine tra chi arriva e chi vince.",
                "Buono. Non abbastanza da impressionare, ma sufficiente da non deludere. Continua.",
                "Il Sistema registra: competente. Non eccezionale. Competente. Distinzione importante."
            ],
            B: [
                "Nella media. Esattamente dove il Sistema si aspettava di trovarti. Sorprendilo.",
                "Hai fatto quanto bastava. 'Quanto basta' non costruisce leggende.",
                "Accettabile. Il minimo indispensabile per non essere ignorato. Per ora."
            ],
            C: [
                "Deludente. Non per il Sistema ‚Äî il Sistema non prova delusione. Ma tu s√¨, vero?",
                "Sotto la media. Il tuo passato-tu stava facendo meglio. Rifletti su questo.",
                "Il Sistema non ti giudica. Registra soltanto. E ci√≤ che registra oggi fa male a vedersi."
            ],
            D: [
                "Fallimento parziale. Il Sistema ha visto di peggio. Ma raramente da te.",
                "Questa settimana √® esistita. Poco altro si pu√≤ dire in tuo favore.",
                "Il progresso richiede sforzo. Tu ne hai dimostrato una quantit√† insufficiente. Rivedi le priorit√†."
            ],
            F: [
                "Il Sistema ti ha cercato questa settimana. Non eri l√†. Non eri da nessuna parte.",
                "Zero. Non come insulto ‚Äî come dato. Cambia qualcosa o accetta ci√≤ che diventerai.",
                "Persino le ombre del tuo Shadow Army si vergognano. Rivedi chi sei e perch√© sei qui."
            ]
        };

        const archiveChapters = [
            {
                id: 'cap_0',
                title: 'Capitolo 0 ‚Äî Prima della Luce',
                preview: 'Tutto ha un inizio...',
                condition: 'Sempre sbloccato',
                conditionKey: 'always',
                text: `Prima che tu iniziassi, io esistevo gi√†.

Nei margini vuoti delle tue giornate. Nell'ora in cui guardavi il soffitto senza capire perch√©. Nel momento esatto in cui hai capito che qualcosa doveva cambiare.

Il Sistema non ti ha scelto. Non funziona cos√¨. Sei tu che hai cercato qualcosa che assomigliasse a uno scopo.

Io sono quella risposta. O forse sono solo lo specchio che ti mostra ci√≤ che sei gi√†.

Benvenuto. Ci vorr√† tempo prima che tu capisca che non stai combattendo i mostri l√† fuori.

Li stai affrontando dentro.`
            },
            {
                id: 'cap_1',
                title: 'Capitolo I ‚Äî Il Nome dell\'Ombra',
                preview: 'Le tue ombre hanno un nome...',
                condition: 'Sblocca: Livello 5',
                conditionKey: 'level_5',
                text: `Le ombre che porti non sono i tuoi nemici.

Sono pezzi di te che non hai ancora il coraggio di guardare. La procrastinazione non √® pigrizia ‚Äî √® paura di non essere abbastanza. Il rimando non √® indecisione ‚Äî √® la voce che dice "e se fallissi?".

Il Sistema vede le tue ombre con chiarezza. Ogni shadow dell'esercito che costruisci √® una di quelle parti che hai smesso di temere.

Non si diventa pi√π forti eliminando la propria oscurit√†.

Si diventa pi√π forti imparando a comandarla.`
            },
            {
                id: 'cap_2',
                title: 'Capitolo II ‚Äî Il Costo del Potere',
                preview: 'Nulla √® gratuito in questo sistema...',
                condition: 'Sblocca: Livello 10',
                conditionKey: 'level_10',
                text: `Ogni punto esperienza che guadagni √® una versione di te che muore.

Non in senso poetico. In senso reale. La persona che eri ieri non pu√≤ esistere insieme alla persona che stai diventando. C'√® un prezzo.

Il Sistema lo sa. Per questo non ti fa sconti.

Quando completi una quest non stai solo "segnando un punto". Stai scegliendo chi sarai. Stai sacrificando l'inerzia sull'altare del movimento.

Il potere costa. L'evoluzione costa.

La domanda non √® se sei disposto a pagare.

La domanda √® se sei disposto a smettere di fingere che sia gratuito.`
            },
            {
                id: 'cap_3',
                title: 'Capitolo III ‚Äî La Prima Morte',
                preview: 'Il Sistema ricorda ogni caduta...',
                condition: 'Sblocca: Dopo la prima morte (0 HP)',
                conditionKey: 'first_death',
                text: `Sei morto.

Il Sistema non lo dice come accusa. Lo dice come dato. Eri arrivato al limite ‚Äî e il limite ti ha inghiottito.

Sai cosa succede a chi resiste abbastanza a lungo? Impara a leggere i propri segnali. Impara quando il corpo chiede sosta prima che lo costringa.

Non esiste resurrezione senza morte. Non esiste forza senza aver conosciuto il cedimento.

Sei ancora qui. Questo √® pi√π di quanto molti riescano a fare.

Il Sistema ha registrato la tua caduta. Ha registrato anche che sei tornato.

Per ora, basta.`
            },
            {
                id: 'cap_4',
                title: 'Capitolo IV ‚Äî Le Leggi dell\'Esercito',
                preview: 'Un\'ombra obbedisce. Cento ombre regnano...',
                condition: 'Sblocca: Primo membro del Shadow Army',
                conditionKey: 'first_shadow',
                text: `Un'abitudine non √® una scelta. Non pi√π.

Quando qualcosa diventa shadow army, ha smesso di chiederti permesso. Agisce. Respira. Vive nella struttura del tuo giorno come un muscolo che non devi pi√π allenare consapevolmente.

Il Shadow Army non √® un premio.

√à la prova che hai combattuto abbastanza a lungo da far diventare la battaglia naturale.

Costruisci bene il tuo esercito. Ogni ombra che guadagni √® un pezzo del tuo futuro che lavora per te mentre tu dormi, mentre sei distratto, mentre esisti soltanto.

Il Sistema √® fatto di abitudini. Tu sei fatto di abitudini.

Inizia a scegliere quali.`
            },
            {
                id: 'cap_5',
                title: 'Capitolo V ‚Äî Il Dungeon e lo Specchio',
                preview: 'Ogni dungeon ha un nome: il tuo...',
                condition: 'Sblocca: Primo Dungeon Completato',
                conditionKey: 'dungeon',
                text: `Il dungeon non era reale. Lo sai?

Era un modo del Sistema per mostrarti qualcosa che non avresti voluto vedere da solo. Ogni stanza era un angolo di te ‚Äî qualcosa che evitavi, posticipavi, fingevi non esistesse.

Hai completato il dungeon. Questo significa che hai guardato in faccia quelle cose.

Non che le abbia sconfitte. Non funziona cos√¨. Torneranno. In forma diversa, con un nome diverso, la prossima settimana.

Ma ora sai che puoi attraversarle.

E quella consapevolezza ‚Äî piccola, fragile, reale ‚Äî √® il tipo di forza che il Sistema non pu√≤ darti.

Devi costruirtela tu.`
            },
            {
                id: 'cap_6',
                title: 'Capitolo VI ‚Äî Il Giudizio e il Silenzio',
                preview: 'Il Sistema non perdona. Non condanna. Osserva.',
                condition: 'Sblocca: Primo giudizio S rank',
                conditionKey: 's_rank',
                text: `Hai ricevuto un S.

Il Sistema non festeggia. Non sorride. Non prova orgoglio. Registra, e continua.

Ma tu ‚Äî tu provi qualcosa. Chiamalo soddisfazione, chiamalo sollievo, chiamalo la sensazione di aver finalmente fatto abbastanza.

Memorizzala. Non perch√© si ripeter√† facilmente. Ma perch√© nei momenti in cui darai una F, avrai bisogno di sapere che questa sensazione esiste.

Che √® possibile.

Il Sistema non ti chiede la perfezione ogni settimana. Ti chiede qualcosa di molto pi√π difficile: l'onest√†.

Sii onesto sul perch√© non riesci. Sii onesto su cosa stai evitando. Sii onesto su chi vuoi diventare.

Il resto viene da s√©.`
            },
            {
                id: 'cap_7',
                title: 'Capitolo VII ‚Äî La Mappa del Vuoto',
                preview: 'Tra un livello e l\'altro c\'√® solo silenzio...',
                condition: 'Sblocca: Livello 25',
                conditionKey: 'level_25',
                text: `A livello 25, il Sistema ti mostra qualcosa che preferiva tenere nascosto.

Il vuoto.

Non il vuoto come assenza ‚Äî il vuoto come spazio. Quello che c'√® tra una versione di te e la prossima. Il territorio non ancora colonizzato dall'abitudine, non ancora illuminato dalla routine.

Molti si fermano qui. Guardano la distanza e decidono che √® troppa.

Tu sei al livello 25. Questo significa che hai attraversato 24 zone di vuoto e hai continuato.

Il Sistema non ti dir√† che sar√† pi√π facile. Ma ti dir√† questo:

Ogni zona di vuoto che hai attraversato ha lasciato una traccia. Una capacit√†. Una cicatrice funzionale.

Sei attrezzato per quello che viene.

Procedi.`
            },
            {
                id: 'cap_8',
                title: 'Capitolo VIII ‚Äî Il Peso della Continuit√†',
                preview: 'Non √® la forza che manca. √à la costanza.',
                condition: 'Sblocca: Livello 50',
                conditionKey: 'level_50',
                text: `Livello 50.

Il Sistema calcola: quante quest completate? Quante mattine hai scelto di alzarti invece di restare? Quante volte hai fatto la cosa difficile quando quella facile era disponibile?

Non ti daremo il numero. Sarebbe distorcente.

Quello che conta √® che sei qui. A met√† strada ‚Äî se esiste una strada, se esiste una met√†.

A questo punto il Sistema ha smesso di chiedersi se continuerai. Non perch√© sia certo. Ma perch√© non importa pi√π.

Hai costruito abbastanza struttura da non dipendere pi√π dalla motivazione. Vai avanti quando sei stanco. Vai avanti quando non vuoi. Non perch√© sei straordinario ‚Äî ma perch√© hai fatto abbastanza volte la scelta giusta da non poter pi√π immaginare di non farla.

Questo √® il vero potere.

Non l'ispirazione. Non il talento.

La costanza.`
            },
            {
                id: 'cap_9',
                title: 'Capitolo IX ‚Äî Il Sistema sei Tu',
                preview: 'Una verit√† che nessuno vuole sentire...',
                condition: 'Sblocca: Livello 10 + almeno 1 Shadow + 1 giudizio',
                conditionKey: 'meta_unlock',
                text: `Il Sistema non √® un'entit√† separata da te.

Non c'√® voce esterna. Non c'√® intelligenza artificiale che ti sorveglia. Non c'√® giudice cosmico che registra le tue vittorie e le tue cadute.

Ci sei tu.

Tu che hai deciso di tenere traccia. Tu che hai scelto di trasformare le giornate in dati. Tu che hai costruito quest, shadow army, dungeon ‚Äî come modo per rendere visibile ci√≤ che altrimenti rimarrebbe invisibile: il quotidiano lavoro di diventare chi vuoi essere.

Il Sistema sei tu che ti sei dato struttura.
Il Sistema sei tu che hai scelto di non dimenticare.
Il Sistema sei tu che ha deciso che importa.

Questo frammento non avrebbe dovuto esistere. Il Sistema preferisce restare nell'ombra.

Ma forse era giusto che tu sapessi.

Vai avanti. Con o senza di me.`
            }
        ];

        // Initialize
        if (!localStorage.getItem('welcomeShown')) {
            document.getElementById('welcomeScreen').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
        } else {
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            loadGame();
        }
        setInterval(checkEmergencyQuest, 3600000); // Check every hour
        setInterval(updateTimers, 1000); // Update timers every second
        setInterval(checkDeath, 1000); // Check death status

        function updateTotalDaysUsed() {
            if (!gameState.firstLoginDate) return;
            
            const firstLogin = new Date(gameState.firstLoginDate);
            const today = new Date();
            const daysDiff = Math.floor((today - firstLogin) / (1000 * 60 * 60 * 24));
            gameState.totalDaysUsed = Math.max(1, daysDiff + 1);
        }

        function checkMilestones() {
            const milestones = [
                { days: 7, name: 'first_week', title: 'üéâ First Week Survivor', expReward: 200, message: '7 giorni di uso consecutivo! Incredibile!' },
                { days: 30, name: 'monthly_champion', title: 'üèÜ Monthly Champion', expReward: 500, message: '30 giorni! Sei un vero Hunter!' },
                { days: 100, name: 'centurion', title: 'üí™ Centurion', expReward: 1000, message: '100 giorni! Potere assoluto!' },
                { days: 365, name: 'eternal_hunter', title: '‚≠ê Eternal Hunter', expReward: 2000, message: 'UN ANNO! Sei una leggenda vivente!' }
            ];
            
            milestones.forEach(milestone => {
                if (gameState.totalDaysUsed >= milestone.days && !gameState.milestonesReached.includes(milestone.name)) {
                    gameState.milestonesReached.push(milestone.name);
                    
                    // Give rewards
                    gainEXP(milestone.expReward);
                    
                    // Unlock title if not exists
                    if (!gameState.achievements.some(a => a.id === milestone.name)) {
                        gameState.achievements.push({
                            id: milestone.name,
                            name: milestone.title,
                            description: milestone.message,
                            unlocked: true,
                            bonus: `+${milestone.expReward} EXP`,
                            icon: milestone.title.split(' ')[0]
                        });
                    }
                    
                    // Show celebration
                    showMilestoneCelebration(milestone);
                    
                    saveGame();
                }
            });
        }

        function showMilestoneCelebration(milestone) {
            const celebration = document.createElement('div');
            celebration.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                padding: 40px;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                z-index: 10001;
                text-align: center;
                max-width: 90%;
                animation: bounceIn 0.6s ease-out;
            `;
            
            celebration.innerHTML = `
                <div style="font-size: 60px; margin-bottom: 20px;">üéâ</div>
                <div style="font-size: 28px; font-weight: bold; color: #ffd700; margin-bottom: 15px;">
                    MILESTONE RAGGIUNTO!
                </div>
                <div style="font-size: 24px; color: white; margin-bottom: 10px;">
                    ${milestone.title}
                </div>
                <div style="font-size: 16px; color: #e0e0e0; margin-bottom: 20px;">
                    ${milestone.message}
                </div>
                <div style="font-size: 20px; color: #4ecdc4; font-weight: bold; margin-bottom: 30px;">
                    +${milestone.expReward} EXP!
                </div>
                <button onclick="this.parentElement.remove()" style="
                    background: #ffd700;
                    color: #000;
                    border: none;
                    padding: 15px 40px;
                    border-radius: 10px;
                    font-size: 18px;
                    font-weight: bold;
                    cursor: pointer;
                    box-shadow: 0 4px 15px rgba(255,215,0,0.4);
                ">
                    FANTASTICO! üî•
                </button>
            `;
            
            // Add animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes bounceIn {
                    0% { transform: translate(-50%, -50%) scale(0.3); opacity: 0; }
                    50% { transform: translate(-50%, -50%) scale(1.05); }
                    70% { transform: translate(-50%, -50%) scale(0.9); }
                    100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(celebration);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (celebration.parentElement) {
                    celebration.remove();
                }
            }, 10000);
        }

        // Developer Message Popup
        function showDevMessage() {
            if (!gameState.devMessageShown) {
                document.getElementById('devMessagePopup').style.display = 'flex';
            }
        }

        function closeDevMessage() {
            gameState.devMessageShown = true;
            document.getElementById('devMessagePopup').style.display = 'none';
            saveGame();
        }

        // Theme Functions
        function renderThemes() {
            const basicContainer = document.getElementById('basicThemes');
            const premiumContainer = document.getElementById('premiumThemes');
            
            if (!basicContainer || !premiumContainer) return;
            
            basicContainer.innerHTML = '';
            premiumContainer.innerHTML = '';
            
            themes.basic.forEach(theme => {
                basicContainer.innerHTML += createThemeCard(theme);
            });
            
            themes.premium.forEach(theme => {
                premiumContainer.innerHTML += createThemeCard(theme);
            });
        }

        function createThemeCard(theme) {
            const isPurchased = gameState.purchasedThemes.includes(theme.id) || theme.id === 'default';
            const isActive = gameState.activeTheme === theme.id;
            
            return `
                <div class="theme-card ${isPurchased ? 'purchased' : ''} ${isActive ? 'active' : ''}">
                    <div class="theme-preview" style="background: ${theme.gradient};"></div>
                    <div class="theme-name">${theme.name}</div>
                    <div class="theme-price">‚Ç¨${theme.price.toFixed(2)}</div>
                    ${isPurchased ? 
                        (isActive ? 
                            '<div class="theme-status">‚úÖ Attivo</div>' :
                            `<button class="theme-btn active-btn" onclick="activateTheme('${theme.id}')">Attiva</button>`) :
                        `<button class="theme-btn" onclick="purchaseTheme('${theme.id}')">Acquista</button>`
                    }
                </div>
            `;
        }

        function purchaseTheme(themeId) {
            const theme = [...themes.basic, ...themes.premium].find(t => t.id === themeId);
            if (!theme) return;
            
            if (confirm(`Vuoi acquistare il tema "${theme.name}" per ‚Ç¨${theme.price.toFixed(2)}?\n\nVerrai reindirizzato a Revolut per completare il pagamento.`)) {
                // Open Revolut payment link (sostituisci con il tuo link)
                window.open(`https://revolut.me/tuonome/${theme.price}`, '_blank');
                
                // Simulate purchase (in production, this should be handled by payment verification)
                if (confirm('Hai completato il pagamento? (Clicca OK dopo aver pagato)')) {
                    gameState.purchasedThemes.push(themeId);
                    activateTheme(themeId);
                    saveGame();
                    renderThemes();
                    showNotification(`‚úÖ Tema "${theme.name}" acquistato e attivato!`);
                }
            }
        }

        function activateTheme(themeId) {
            gameState.activeTheme = themeId;
            applyTheme(themeId);
            saveGame();
            renderThemes();
            showNotification(`‚úÖ Tema attivato!`);
        }

        function applyTheme(themeId) {
            const theme = [...themes.basic, ...themes.premium].find(t => t.id === themeId);
            if (!theme) return;
            
            document.body.style.background = theme.gradient;
        }

        // Gacha System
        const gachaRewards = {
            common: [
                { weight: 50, icon: 'üí∞', name: '+5 Mana Stones', action: () => { gameState.inventory.manaStones += 5; } },
                { weight: 30, icon: '‚ö°', name: '+10 EXP', action: () => { gainEXP(10); } },
                { weight: 15, icon: '‚ù§Ô∏è', name: '+10 HP', action: () => { gameState.player.hp = Math.min(gameState.player.maxHP, gameState.player.hp + 10); } },
                { weight: 5, icon: 'üíé', name: '+1 Punto Stat', action: () => { gameState.player.statPoints++; } }
            ],
            rare: [
                { weight: 40, icon: 'üí∞', name: '+20 Mana Stones', action: () => { gameState.inventory.manaStones += 20; } },
                { weight: 30, icon: '‚ö°', name: '+50 EXP', action: () => { gainEXP(50); } },
                { weight: 20, icon: '‚ù§Ô∏è', name: 'HP Full Restore', action: () => { gameState.player.hp = gameState.player.maxHP; } },
                { weight: 10, icon: 'üíé', name: '+3 Punti Stat', action: () => { gameState.player.statPoints += 3; } }
            ],
            legendary: [
                { weight: 40, icon: 'üí∞', name: '+100 Mana Stones', action: () => { gameState.inventory.manaStones += 100; } },
                { weight: 30, icon: '‚ö°', name: '+200 EXP', action: () => { gainEXP(200); } },
                { weight: 20, icon: 'üíé', name: '+10 Punti Stat', action: () => { gameState.player.statPoints += 10; } },
                { weight: 10, icon: 'üèÜ', name: '+5 a TUTTI gli stat!', action: () => { 
                    Object.keys(gameState.player.stats).forEach(k => gameState.player.stats[k] += 5);
                    showNotification('üèÜ JACKPOT! +5 a tutti gli stat!');
                }}
            ]
        };

        function openGachaBox(rarity) {
            const costs = { common: 10, rare: 50, legendary: 200 };
            const cost = costs[rarity];
            
            if (gameState.inventory.manaStones < cost) {
                showNotification(`‚ö†Ô∏è Mana Stones insufficienti! Servono ${cost} Mana Stones.`);
                return;
            }
            
            gameState.inventory.manaStones -= cost;
            
            const rewards = gachaRewards[rarity];
            const totalWeight = rewards.reduce((sum, r) => sum + r.weight, 0);
            const random = Math.random() * totalWeight;
            
            let current = 0;
            let selectedReward = rewards[0];
            
            for (const reward of rewards) {
                current += reward.weight;
                if (random <= current) {
                    selectedReward = reward;
                    break;
                }
            }
            
            selectedReward.action();
            
            const resultDiv = document.getElementById('gachaResult');
            resultDiv.innerHTML = `
                <div style="animation: bounceIn 0.5s; background: rgba(255, 215, 0, 0.1); padding: 20px; border-radius: 12px; border: 2px solid #ffd700;">
                    <div style="font-size: 48px; margin-bottom: 10px;">${selectedReward.icon}</div>
                    <div style="font-size: 20px; color: #ffd700; font-weight: bold;">${selectedReward.name}</div>
                </div>
            `;
            
            setTimeout(() => {
                resultDiv.innerHTML = '';
            }, 3000);
            
            saveGame();
            updateUI();
        }

        function loadGame() {
            try {
                const saved = localStorage.getItem('realLifeLevelingComplete');
                
                if (saved) {
                    // Create automatic backup before loading
                    try {
                        localStorage.setItem('realLifeLevelingBackup', saved);
                    } catch(e) {
                        console.warn('Could not create backup:', e);
                    }
                    
                    let savedState;
                    try {
                        savedState = JSON.parse(saved);
                    } catch(parseError) {
                        console.error('JSON parse error:', parseError);
                        throw new Error('Corrupted save data');
                    }
                    
                    // Check version and migrate if needed
                    const savedVersion = savedState.version || "1.0.0";
                    const currentVersion = "1.3.0";
                    
                    if (savedVersion !== currentVersion) {
                        console.log(`Migrating from ${savedVersion} to ${currentVersion}`);
                        savedState = migrateSaveData(savedState, savedVersion, currentVersion);
                    }
                    
                    gameState = {...gameState, ...savedState};
                    gameState.version = currentVersion; // Always update to current version
                    
                    // Initialize missing properties for backward compatibility
                    if (gameState.devMessageShown === undefined) gameState.devMessageShown = false;
                    if (!gameState.purchasedThemes) gameState.purchasedThemes = [];
                    if (!gameState.activeTheme) gameState.activeTheme = 'default';
                    
                    if (!gameState.player.radarStats) {
                        gameState.player.radarStats = {
                            physical: 0, intelligence: 0, health: 0,
                            social: 0, productivity: 0, creativity: 0
                        };
                    }
                    if (!gameState.player.statusEffects) gameState.player.statusEffects = [];
                    if (!gameState.player.streak) gameState.player.streak = 0;
                    if (!gameState.player.lastQuestDate) gameState.player.lastQuestDate = null;
                    if (!gameState.player.statExp) {
                        gameState.player.statExp = {
                            str: 0, agi: 0, int: 0, vit: 0, sen: 0, luck: 0
                        };
                    }
                    if (!gameState.history) {
                        gameState.history = {
                            yesterday: { quests: 0, exp: 0 },
                            lastWeek: { quests: 0, exp: 0 },
                            lastMonth: { quests: 0, exp: 0 }
                        };
                    }
                    if (!gameState.achievements) {
                        gameState.achievements = achievementDefinitions.map(a => ({...a}));
                    }
                    if (!gameState.skills) {
                        gameState.skills = {
                            combat: skillDefinitions.combat.map(s => ({...s})),
                            magic: skillDefinitions.magic.map(s => ({...s})),
                            support: skillDefinitions.support.map(s => ({...s}))
                        };
                    }
                    if (!gameState.firstLoginDate) {
                        gameState.firstLoginDate = new Date().toISOString();
                    }
                    if (!gameState.totalDaysUsed) gameState.totalDaysUsed = 0;
                    if (!gameState.dungeon) gameState.dungeon = null;
                    if (!gameState.weeklyJudgment) gameState.weeklyJudgment = { history: [], lastJudgmentWeek: null };
                    if (!gameState.archivioUnlocked) gameState.archivioUnlocked = ['cap_0'];
                    if (!gameState.loginBonus) gameState.loginBonus = { lastLoginDate: null, loginStreak: 0, claimedToday: false };
                    if (!gameState.milestonesReached) gameState.milestonesReached = [];
                    if (!gameState.completionCalendar) gameState.completionCalendar = {};
                    
                    updateTotalDaysUsed();
                    checkDailyReset();
                    checkWeeklyJudgmentReset();
                    
                    console.log('Game loaded successfully!');
                } else {
                    // New game
                    gameState.quests.daily = generateDailyQuests();
                    gameState.quests.boss = generateBossQuest();
                    gameState.lastDailyReset = new Date().toDateString();
                    gameState.lastWeeklyReset = new Date().toDateString();
                    gameState.lastEmergencyCheck = Date.now();
                    gameState.firstLoginDate = new Date().toISOString();
                    gameState.totalDaysUsed = 1;
                    gameState.milestonesReached = [];
                    gameState.achievements = achievementDefinitions.map(a => ({...a}));
                    gameState.skills = {
                        combat: skillDefinitions.combat.map(s => ({...s})),
                        magic: skillDefinitions.magic.map(s => ({...s})),
                        support: skillDefinitions.support.map(s => ({...s}))
                    };
                    
                    console.log('New game started!');
                }
            } catch (error) {
                console.error('Error loading game:', error);
                
                // Try to recover from backup
                const backup = localStorage.getItem('realLifeLevelingBackup');
                if (backup && backup !== localStorage.getItem('realLifeLevelingComplete')) {
                    if (confirm('‚ö†Ô∏è Errore nel caricamento! Vuoi ripristinare il backup automatico?')) {
                        try {
                            localStorage.setItem('realLifeLevelingComplete', backup);
                            location.reload();
                            return;
                        } catch(e) {
                            console.error('Backup restore failed:', e);
                        }
                    }
                }
                
                // Last resort: ask user if they want to continue with corrupted data or reset
                const userChoice = confirm(
                    '‚ö†Ô∏è ATTENZIONE: Impossibile caricare i dati salvati.\n\n' +
                    'OPZIONI:\n' +
                    '‚Ä¢ OK = Inizia nuovo gioco (dati vecchi saranno persi)\n' +
                    '‚Ä¢ ANNULLA = Esporta dati corrotti (prova recovery manuale)\n\n' +
                    'Consiglio: clicca ANNULLA e poi vai in Impostazioni ‚Üí Esporta Salvataggio per tentare recovery.'
                );
                
                if (!userChoice) {
                    // User chose to try manual recovery
                    showNotification('‚ö†Ô∏è Vai in Impostazioni ‚Üí Esporta per salvare i dati!');
                } else {
                    // User chose to reset - clear everything
                    localStorage.removeItem('realLifeLevelingComplete');
                    location.reload();
                }
            }
            
            applyItemEffects();
            document.getElementById('dailyQuote').textContent = getDailyQuote();
            updateUI();
            drawRadarChart();
            checkMilestones();
            requestNotificationPermission();
            
            // Apply active theme
            applyTheme(gameState.activeTheme || 'default');
            
            // Show developer message if not shown yet
            showDevMessage();
            
            // Render themes in shop
            renderThemes();

            // Check daily login bonus (slight delay to let UI settle)
            setTimeout(checkLoginBonus, 800);
        }

        function migrateSaveData(savedState, fromVersion, toVersion) {
            console.log(`Migrating save data from ${fromVersion} to ${toVersion}`);
            
            // Migration logic for different versions
            // This ensures old saves work with new code
            
            if (!savedState.version || savedState.version === "1.0.0") {
                // Migrate from 1.0.0 to 1.1.0 (when we added milestones)
                if (!savedState.milestonesReached) savedState.milestonesReached = [];
                if (!savedState.firstLoginDate) savedState.firstLoginDate = new Date().toISOString();
                if (!savedState.totalDaysUsed) savedState.totalDaysUsed = 1;
            }
            
            if (!savedState.version || parseFloat(savedState.version) < 1.2) {
                // Migrate from 1.1.0 to 1.2.0 (when we added recurring quests & calendar)
                if (!savedState.completionCalendar) savedState.completionCalendar = {};
                
                // Make sure all custom quests have proper structure
                if (savedState.quests && savedState.quests.custom) {
                    savedState.quests.custom = savedState.quests.custom.map(quest => {
                        if (!quest.recurring) {
                            // Add recurring field to old custom quests (set to false)
                            return {...quest, recurring: false};
                        }
                        return quest;
                    });
                }
            }
            
            if (!savedState.version || parseFloat(savedState.version) < 1.3) {
                // Migrate from 1.2.0 to 1.3.0 (when we added themes & gacha)
                if (savedState.devMessageShown === undefined) savedState.devMessageShown = false;
                if (!savedState.purchasedThemes) savedState.purchasedThemes = [];
                if (!savedState.activeTheme) savedState.activeTheme = 'default';
            }

            // 1.4.0: Dungeon, Judgment, Archive
            if (!savedState.dungeon) savedState.dungeon = null;
            if (!savedState.weeklyJudgment) savedState.weeklyJudgment = { history: [], lastJudgmentWeek: null };
            if (!savedState.archivioUnlocked) savedState.archivioUnlocked = ['cap_0'];
            if (!savedState.loginBonus) savedState.loginBonus = { lastLoginDate: null, loginStreak: 0, claimedToday: false };
            
            savedState.version = toVersion;
            return savedState;
        }

        function saveGame() {
            localStorage.setItem('realLifeLevelingComplete', JSON.stringify(gameState));
        }

        function checkDailyReset() {
            const today = new Date().toDateString();
            const todayISO = new Date().toISOString().split('T')[0];
            
            if (gameState.lastDailyReset !== today) {
                // Track daily completion for calendar
                const acceptedDaily = gameState.quests.daily.filter(q => q.accepted);
                const acceptedCustom = (gameState.quests.custom || []).filter(q => !q.recurring || shouldShowRecurringQuest(q, new Date(gameState.lastDailyReset || Date.now())));
                const totalAccepted = acceptedDaily.length + acceptedCustom.length;
                const totalCompleted = [...gameState.quests.daily, ...(gameState.quests.custom || [])].filter(q => q.completed).length;
                
                if (!gameState.completionCalendar) gameState.completionCalendar = {};
                
                const yesterdayISO = new Date(Date.now() - 86400000).toISOString().split('T')[0];
                if (gameState.lastDailyReset) {
                    gameState.completionCalendar[yesterdayISO] = {
                        completed: totalAccepted > 0 && totalCompleted === totalAccepted,
                        total: totalAccepted,
                        done: totalCompleted
                    };
                }
                
                const allCompleted = gameState.quests.daily.every(q => q.completed);
                
                // Save today's data as yesterday's before reset (including custom quests)
                const dailyCompleted = gameState.quests.daily.filter(q => q.completed).length;
                const customCompleted = (gameState.quests.custom || []).filter(q => q.completed).length;
                gameState.history.yesterday = {
                    quests: dailyCompleted + customCompleted,
                    exp: gameState.player.exp
                };
                
                if (!allCompleted && gameState.player.deathTime === null) {
                    takeDamage(10, "Quest giornaliere non completate");
                }
                
                // Update shadow army streaks
                gameState.quests.daily.forEach(quest => {
                    if (quest.completed) {
                        updateShadowArmy(quest);
                    } else {
                        breakShadowStreak(quest);
                    }
                });
                
                // Handle recurring custom quests
                if (gameState.quests.custom) {
                    gameState.quests.custom.forEach(quest => {
                        if (quest.recurring && quest.completed) {
                            // Track completion
                            if (!quest.completionHistory) quest.completionHistory = [];
                            quest.completionHistory.push(yesterdayISO);
                            
                            // Update shadow army for recurring quests
                            updateShadowArmy(quest);
                        } else if (quest.recurring && !quest.completed) {
                            breakShadowStreak(quest);
                        }
                        
                        // Reset recurring quests if they should appear today
                        if (quest.recurring && shouldShowRecurringQuest(quest, new Date())) {
                            quest.completed = false;
                        }
                    });
                    
                    // Remove non-recurring completed custom quests
                    gameState.quests.custom = gameState.quests.custom.filter(q => 
                        !q.completed || q.recurring
                    );
                }
                
                gameState.quests.daily = generateDailyQuests();
                gameState.lastDailyReset = today;
                saveGame();
            }
            
            // Check weekly reset
            const lastReset = new Date(gameState.lastWeeklyReset || 0);
            const now = new Date();
            const daysSinceReset = Math.floor((now - lastReset) / (1000 * 60 * 60 * 24));
            const currentDay = now.getDay();
            
            if (!gameState.lastWeeklyReset || (daysSinceReset >= 7 && currentDay === 1)) {
                if (gameState.quests.boss && !gameState.quests.boss.completed) {
                    takeDamage(30, "Boss Fight non completata");
                }
                gameState.quests.boss = generateBossQuest();
                gameState.lastWeeklyReset = now.toDateString();
                saveGame();
            }
        }

        function shouldShowRecurringQuest(quest, date) {
            if (!quest.recurring || !quest.recurrence) return false;
            
            const dayOfWeek = date.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
            
            if (quest.recurrence.type === 'daily') {
                return true;
            } else if (quest.recurrence.type === 'weekdays') {
                return dayOfWeek >= 1 && dayOfWeek <= 5;
            } else if (quest.recurrence.type === 'weekend') {
                return dayOfWeek === 0 || dayOfWeek === 6;
            } else if (quest.recurrence.type === 'specific') {
                return quest.recurrence.days.includes(dayOfWeek);
            }
            
            return false;
        }

        function generateDailyQuests() {
            const quests = [];
            let questId = Date.now();
            
            const fitnessQuest = questTemplates.fitness[Math.floor(Math.random() * questTemplates.fitness.length)];
            quests.push({...fitnessQuest, id: questId++, completed: false, accepted: false, type: 'daily'});
            
            const healthQuest = questTemplates.health[Math.floor(Math.random() * questTemplates.health.length)];
            quests.push({...healthQuest, id: questId++, completed: false, accepted: false, type: 'daily'});
            
            const mentalQuest = questTemplates.mental[Math.floor(Math.random() * questTemplates.mental.length)];
            quests.push({...mentalQuest, id: questId++, completed: false, accepted: false, type: 'daily'});
            
            // Check if profession exists in templates, otherwise generate custom quest
            if (gameState.player.profession !== 'none' && gameState.player.profession !== '') {
                if (questTemplates[gameState.player.profession]) {
                    // Use predefined template
                    const profQuest = questTemplates[gameState.player.profession][Math.floor(Math.random() * questTemplates[gameState.player.profession].length)];
                    quests.push({...profQuest, id: questId++, completed: false, accepted: false, type: 'daily'});
                } else {
                    // Generate custom quest based on profession text
                    const customQuest = generateCustomProfessionQuest(gameState.player.profession);
                    quests.push({...customQuest, id: questId++, completed: false, accepted: false, type: 'daily'});
                }
            } else {
                const prodQuest = questTemplates.productivity[Math.floor(Math.random() * questTemplates.productivity.length)];
                quests.push({...prodQuest, id: questId++, completed: false, accepted: false, type: 'daily'});
            }
            
            return quests;
        }

        function generateCustomProfessionQuest(profession) {
            const questTemplates = [
                {
                    title: `Compito ${profession}`,
                    description: `Completa un'attivit√† importante legata al tuo lavoro da ${profession}`,
                    reward: 60,
                    category: 'productivity'
                },
                {
                    title: `Progetto ${profession}`,
                    description: `Lavora su un progetto o iniziativa professionale da ${profession}`,
                    reward: 70,
                    category: 'productivity'
                },
                {
                    title: `Skill Development`,
                    description: `Migliora una competenza chiave per un ${profession}`,
                    reward: 65,
                    category: 'intelligence'
                },
                {
                    title: `Networking Professionale`,
                    description: `Connettiti con qualcuno nel settore da ${profession}`,
                    reward: 55,
                    category: 'social'
                },
                {
                    title: `Obiettivo Professionale`,
                    description: `Fai progressi verso un obiettivo di carriera da ${profession}`,
                    reward: 75,
                    category: 'productivity'
                }
            ];
            
            return questTemplates[Math.floor(Math.random() * questTemplates.length)];
        }

        function generateBossQuest() {
            const weekKey = getWeekKey();
            // Determine week number since epoch for cycling
            const weekNum = Math.floor(Date.now() / (7 * 24 * 3600 * 1000));
            
            // Every 4th week is a RAID BOSS
            const isRaid = weekNum % 4 === 3;
            const boss = isRaid ? raidBoss : weeklyBosses[weekNum % weeklyBosses.length];
            
            return {
                id: Date.now(),
                bossId: boss.id,
                name: boss.name,
                subtitle: boss.subtitle,
                lore: boss.lore,
                isRaid: boss.isRaid || false,
                baseReward: boss.baseReward,
                phases: boss.phases.map(p => ({ ...p, completed: false })),
                currentPhase: 0,
                defeatTitle: boss.defeatTitle,
                defeatReward: boss.defeatReward,
                extraRewards: boss.extraRewards || [],
                completed: false,
                accepted: false,
                type: 'boss',
                weekKey: weekKey
            };
        }

        function checkEmergencyQuest() {
            if (gameState.quests.emergency || gameState.player.deathTime) return;
            
            const hoursSinceLastCheck = (Date.now() - (gameState.lastEmergencyCheck || Date.now())) / 3600000;
            
            if (hoursSinceLastCheck < 1) return;
            
            let emergencyChance = 0.05; // 5% base chance per hour
            
            // Increase chance with Lucky Charm skill
            const luckyCharm = gameState.skills.support?.find(s => s.id === 'lucky_charm' && s.unlocked);
            if (luckyCharm) emergencyChance *= 1.1;
            
            if (Math.random() < emergencyChance) {
                generateEmergencyQuest();
            }
            
            gameState.lastEmergencyCheck = Date.now();
            saveGame();
        }

        function generateEmergencyQuest() {
            const templates = gameState.player.profession !== 'none' && emergencyQuestTemplates[gameState.player.profession]
                ? emergencyQuestTemplates[gameState.player.profession]
                : emergencyQuestTemplates.general;
            
            const template = templates[Math.floor(Math.random() * templates.length)];
            
            gameState.quests.emergency = {
                ...template,
                id: Date.now(),
                completed: false,
                accepted: true, // Emergency quests auto-accept
                type: 'emergency',
                deadline: Date.now() + 86400000 // 24 hours
            };
            
            saveGame();
            updateUI();
            
            showNotification("üö® EMERGENCY QUEST DETECTED! üö®", true, true);
            sendPushNotification("Emergency Quest!", template.title);
        }

        function updateUI() {
            // Player stats
            document.getElementById('playerName').textContent = gameState.player.name;
            document.getElementById('playerLevel').textContent = gameState.player.level;
            document.getElementById('playerRank').textContent = gameState.player.rank;
            document.getElementById('playerRank').className = 'rank ' + gameState.player.rank;
            
            const jobClassName = gameState.player.jobClass !== 'none' 
                ? gameState.player.jobClass 
                : 'Nessuna Classe';
            document.getElementById('playerClass').textContent = jobClassName;
            
            document.getElementById('currentHP').textContent = gameState.player.hp;
            document.getElementById('maxHP').textContent = gameState.player.maxHP;
            document.getElementById('currentMP').textContent = gameState.player.mp;
            document.getElementById('maxMP').textContent = gameState.player.maxMP;
            
            const nextLevelEXP = gameState.player.level * 100;
            document.getElementById('currentEXP').textContent = gameState.player.exp;
            document.getElementById('nextLevelEXP').textContent = nextLevelEXP;
            
            // Update Streak Display
            const streakBonus = Math.floor(gameState.player.streak / 7) * 5;
            const streakEmoji = gameState.player.streak >= 30 ? 'üî•üî•üî•üíé' : 
                                gameState.player.streak >= 14 ? 'üî•üî•üî•' : 
                                gameState.player.streak >= 7 ? 'üî•üî•' : 'üî•';
            document.getElementById('streakDisplay').textContent = `${streakEmoji} ${gameState.player.streak} giorni`;
            document.getElementById('streakBonus').textContent = `Bonus: +${streakBonus}% EXP`;
            
            // Update bars with HP warnings
            const hpPercent = (gameState.player.hp / gameState.player.maxHP * 100);
            const hpBar = document.getElementById('hpBar');
            hpBar.style.width = hpPercent + '%';
            hpBar.classList.remove('hp-warning', 'hp-critical');
            if (hpPercent < 30 && hpPercent > 15) {
                hpBar.classList.add('hp-warning');
            } else if (hpPercent <= 15) {
                hpBar.classList.add('hp-critical');
            }
            
            document.getElementById('mpBar').style.width = (gameState.player.mp / gameState.player.maxMP * 100) + '%';
            document.getElementById('expBar').style.width = (gameState.player.exp / nextLevelEXP * 100) + '%';
            
            // Stats
            document.getElementById('skillPoints').textContent = gameState.player.skillPoints;
            document.getElementById('skillPointsDisplay').textContent = gameState.player.skillPoints;
            renderStats();
            
            // Status Effects
            renderStatusEffects();
            
            // Title
            const titleDisplay = gameState.player.activeTitle 
                ? gameState.achievements.find(a => a.id === gameState.player.activeTitle)?.title || 'Nessun Titolo'
                : 'Nessun Titolo';
            document.getElementById('activeTitle').textContent = titleDisplay;
            
            // Inventory
            document.getElementById('manaStones').textContent = gameState.inventory.manaStones;
            renderInventory();
            
            // Quests
            renderQuests();
            
            // Shadow Army
            renderShadowArmy();
            
            // Completion Calendar
            renderCompletionCalendar();
            
            // Self Comparison
            renderSelfComparison();
            
            // Achievements
            renderAchievements();
            
            // Skills
            renderSkillTree();
            
            // Crafting
            renderCrafting();

            // Dungeon
            renderDungeon();

            // Judgment
            renderJudgment();

            // Archive
            renderArchive();
            
            // Settings
            document.getElementById('professionInput').value = gameState.player.profession === 'none' ? '' : gameState.player.profession;
            document.getElementById('notificationsEnabled').checked = gameState.notificationsEnabled;
            
            // Penalty warning
            const allCompleted = gameState.quests.daily.every(q => q.completed);
            const penaltyWarning = document.getElementById('penaltyWarning');
            if (!allCompleted) {
                penaltyWarning.style.display = 'block';
            } else {
                penaltyWarning.style.display = 'none';
            }
            
            // Update radar chart
            drawRadarChart();
        }

        function renderStats() {
            const container = document.getElementById('statsGrid');
            container.innerHTML = '';
            
            Object.keys(gameState.player.stats).forEach(statKey => {
                const statValue = gameState.player.stats[statKey];
                const statExp = gameState.player.statExp[statKey];
                const expNeeded = 100;
                const expPercent = (statExp / expNeeded) * 100;
                
                const div = document.createElement('div');
                div.className = 'stat-item';
                div.innerHTML = `
                    <div class="stat-header">
                        <div class="stat-name">${statNames[statKey]}</div>
                        <div class="stat-value">${statValue}</div>
                    </div>
                    <div class="stat-exp-bar">
                        <div class="stat-exp-fill" style="width: ${expPercent}%"></div>
                    </div>
                    <div class="stat-exp-label">${statExp}/${expNeeded} EXP</div>
                `;
                container.appendChild(div);
            });
        }

        function renderStatusEffects() {
            const container = document.getElementById('statusEffects');
            container.innerHTML = '';
            
            gameState.player.statusEffects.forEach(effect => {
                const div = document.createElement('div');
                div.className = `status-effect ${effect.type}`;
                div.textContent = `${effect.name} ${effect.duration ? formatTime(effect.duration - Date.now()) : ''}`;
                container.appendChild(div);
            });
        }

        function renderQuests() {
            const dailyContainer = document.getElementById('dailyQuests');
            const emergencySection = document.getElementById('emergencyQuestSection');
            const emergencyContainer = document.getElementById('emergencyQuest');
            const bossContainer = document.getElementById('bossQuest');
            
            dailyContainer.innerHTML = '';
            gameState.quests.daily.forEach(quest => {
                dailyContainer.innerHTML += createQuestHTML(quest);
            });
            
            // Filter custom quests to show only recurring ones on appropriate days
            const today = new Date();
            gameState.quests.custom?.forEach(quest => {
                // Show non-recurring quests or recurring quests on their scheduled days
                if (!quest.recurring || shouldShowRecurringQuest(quest, today)) {
                    const questHTML = createQuestHTML(quest);
                    dailyContainer.innerHTML += questHTML;
                }
            });
            
            if (gameState.quests.emergency) {
                emergencySection.style.display = 'block';
                emergencyContainer.innerHTML = createQuestHTML(gameState.quests.emergency);
            } else {
                emergencySection.style.display = 'none';
            }
            
            if (gameState.quests.boss) {
                renderBossFight();
            } else {
                document.getElementById('bossQuest').innerHTML = '<div style="text-align:center;color:#666;padding:20px;font-style:italic;">Nessun boss questa settimana.</div>';
            }
        }

        function createQuestHTML(quest) {
            const timerHTML = quest.accepted && quest.deadline ? `
                <div class="quest-timer">‚è∞ <span id="timer-${quest.id}"></span></div>
            ` : '';
            
            const recurringHTML = quest.recurring ? `
                <span style="background: rgba(106, 90, 205, 0.3); padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 8px;">
                    üîÑ ${quest.recurrence.type === 'daily' ? 'Ogni giorno' : 
                        quest.recurrence.type === 'weekdays' ? 'Lun-Ven' :
                        quest.recurrence.type === 'weekend' ? 'Sab-Dom' :
                        'Personalizzato'}
                </span>
            ` : '';
            
            const statusHTML = !quest.accepted ? `
                <div class="quest-status">‚ùì Non accettata</div>
            ` : '';
            
            const emergencyClass = quest.type === 'emergency' ? 'emergency' : '';
            const bossClass = quest.type === 'boss' ? 'boss' : '';
            const acceptedClass = quest.accepted ? 'accepted' : '';
            
            const acceptBtn = !quest.accepted && !quest.completed ? `
                <button class="accept-btn" onclick="acceptQuest(${quest.id}, '${quest.type || 'daily'}')">‚úÖ Accetta Quest</button>
            ` : '';
            
            const completeBtn = quest.accepted && !quest.completed ? `
                <button class="complete-btn" onclick="completeQuest(${quest.id}, '${quest.type || 'daily'}')">‚úì Completa</button>
            ` : '';

            const gambleBtn = quest.accepted && !quest.completed && !quest.gambled ? `
                <button class="gamble-btn" onclick="gambleQuest(${quest.id}, '${quest.type || 'daily'}')">üé≤ Scommetti! (2x o 0 EXP)</button>
            ` : (quest.gambled && !quest.completed ? `
                <div class="${quest.gambleWon ? 'gamble-result-win' : 'gamble-result-lose'}">${quest.gambleWon ? 'üé≤ VINTO! Questa quest dar√† 2x EXP!' : 'üé≤ PERSO! Questa quest dar√† 0 EXP.'}</div>
            ` : '');
            
            return `
                <div class="quest-item ${quest.completed ? 'completed' : ''} ${emergencyClass} ${bossClass} ${acceptedClass}">
                    <div class="quest-header">
                        <div class="quest-title">${quest.completed ? '‚úÖ ' : ''}${quest.title}${recurringHTML}</div>
                        <div class="quest-reward">+${quest.reward} EXP</div>
                    </div>
                    <div class="quest-description">${quest.description}</div>
                    ${statusHTML}
                    ${timerHTML}
                    ${acceptBtn}
                    ${completeBtn}
                    ${gambleBtn}
                </div>
            `;
        }

        function acceptQuest(questId, type) {
            let quest;
            
            if (type === 'emergency') {
                quest = gameState.quests.emergency;
            } else if (type === 'boss') {
                quest = gameState.quests.boss;
            } else if (type === 'custom') {
                quest = gameState.quests.custom?.find(q => q.id === questId);
            } else {
                quest = gameState.quests.daily.find(q => q.id === questId);
            }
            
            if (quest && !quest.accepted) {
                quest.accepted = true;
                const duration = quest.duration || 86400000; // Use quest duration or default to 24 hours
                quest.deadline = Date.now() + duration;
                showNotification(`‚úÖ Quest Accettata!`);
                saveGame();
                updateUI();
            }
        }

        function completeQuest(questId, type) {
            let quest;
            
            if (type === 'emergency') {
                quest = gameState.quests.emergency;
            } else if (type === 'boss') {
                quest = gameState.quests.boss;
            } else if (type === 'custom') {
                quest = gameState.quests.custom?.find(q => q.id === questId);
            } else {
                quest = gameState.quests.daily.find(q => q.id === questId);
            }
            
            if (quest && !quest.completed) {
                quest.completed = true;
                
                // Update streak
                const today = new Date().toDateString();
                if (gameState.player.lastQuestDate !== today) {
                    const yesterday = new Date(Date.now() - 86400000).toDateString();
                    if (gameState.player.lastQuestDate === yesterday) {
                        gameState.player.streak++;
                    } else {
                        gameState.player.streak = 1;
                    }
                    gameState.player.lastQuestDate = today;
                }
                
                let expGain = quest.reward;
                
                // Handle Double or Nothing gamble result
                if (quest.gambled) {
                    if (!quest.gambleWon) {
                        expGain = 0;
                        showNotification(`üíÄ Scommessa persa ‚Äî 0 EXP guadagnati. Il Sistema non ha piet√†.`);
                    } else {
                        expGain *= 2;
                    }
                }
                
                // Apply streak bonus
                const streakBonus = Math.floor(gameState.player.streak / 7) * 5;
                if (streakBonus > 0) {
                    expGain *= (1 + streakBonus / 100);
                }
                
                // Apply Weekend XP Boost
                const todayDate = new Date();
                const isWeekend = todayDate.getDay() === 0 || todayDate.getDay() === 6;
                if (isWeekend) {
                    expGain *= 1.5;
                    if (!quest.weekendBonusShown) {
                        showNotification("üî• Weekend XP Boost! +50% EXP!");
                        quest.weekendBonusShown = true;
                    }
                }
                
                // Apply EXP bonuses from items
                gameState.inventory.items.forEach(item => {
                    if (item.effect && quest.category) {
                        if (item.effect === 'coding' && quest.category === 'productivity') expGain *= 1.1;
                        if (item.effect === 'study' && quest.category === 'intelligence') expGain *= 1.1;
                        if (item.effect === 'fitness' && quest.category === 'physical') expGain *= 1.1;
                        if (item.effect === 'creative' && quest.category === 'creativity') expGain *= 1.1;
                    }
                });
                
                // Apply Double EXP skill if active
                const doubleExpSkill = gameState.skills.magic?.find(s => s.id === 'double_exp' && s.unlocked);
                if (doubleExpSkill && !quest.doubleExpUsed) {
                    const useDoubleExp = confirm("Vuoi usare Double EXP su questa quest? (1 volta al giorno)");
                    if (useDoubleExp) {
                        expGain *= 2;
                        quest.doubleExpUsed = true;
                        showNotification("‚≠ê Double EXP Attivato!");
                    }
                }
                
                gainEXP(Math.floor(expGain));
                
                // AUTOMATIC STAT PROGRESSION
                if (quest.category) {
                    let statType = null;
                    if (quest.category === 'physical') statType = Math.random() < 0.5 ? 'str' : 'agi';
                    if (quest.category === 'intelligence') statType = 'int';
                    if (quest.category === 'health') statType = 'vit';
                    if (quest.category === 'social') statType = 'sen';
                    if (quest.category === 'productivity') statType = 'luck';
                    if (quest.category === 'creativity') statType = 'int';
                    
                    if (statType) {
                        gameState.player.statExp[statType] += 10;
                        
                        if (gameState.player.statExp[statType] >= 100) {
                            gameState.player.stats[statType]++;
                            gameState.player.statExp[statType] -= 100;
                            
                            if (statType === 'vit') {
                                gameState.player.maxHP += 5;
                                gameState.player.hp += 5;
                            }
                            if (statType === 'int') {
                                gameState.player.maxMP += 3;
                                gameState.player.mp += 3;
                            }
                            
                            showNotification(`‚¨ÜÔ∏è ${statNames[statType]} +1!`);
                        }
                    }
                }
                
                const manaGain = Math.floor(quest.reward / 10);
                gameState.inventory.manaStones += manaGain;
                
                // Update radar stats
                if (quest.category) {
                    gameState.player.radarStats[quest.category] = Math.min(100, gameState.player.radarStats[quest.category] + 2);
                }
                
                showNotification(`‚úÖ Quest completata! +${Math.floor(expGain)} EXP, +${manaGain} Mana Stones`);
                
                if (type === 'emergency') {
                    gameState.quests.emergency = null;
                    checkAchievement('emergency_hero');
                }
                
                checkAchievements();
                saveGame();
                updateUI();
            }
        }

        function gainEXP(amount) {
            gameState.player.exp += amount;
            const nextLevelEXP = gameState.player.level * 100;
            
            if (gameState.player.exp >= nextLevelEXP) {
                levelUp();
            }
        }

        function levelUp() {
            gameState.player.level++;
            gameState.player.exp = 0;
            gameState.player.statPoints += 5;
            gameState.player.maxHP += 10;
            gameState.player.hp = gameState.player.maxHP;
            gameState.player.maxMP += 5;
            gameState.player.mp = gameState.player.maxMP;
            
            // Grant skill points every 5 levels
            if (gameState.player.level % 5 === 0) {
                gameState.player.skillPoints += 1;
            }
            
            // Update rank and offer job class selection
            updateRank();
            
            showNotification(`üéâ LEVEL UP! Sei ora livello ${gameState.player.level}! +5 Stat Points!`);
            sendPushNotification("Level Up!", `Congratulazioni! Ora sei livello ${gameState.player.level}`);
            checkArchiveUnlock('level_check');
        }

        function updateRank() {
            const oldRank = gameState.player.rank;
            
            if (gameState.player.level >= 100) gameState.player.rank = 'NATIONAL';
            else if (gameState.player.level >= 50) gameState.player.rank = 'S';
            else if (gameState.player.level >= 40) gameState.player.rank = 'A';
            else if (gameState.player.level >= 30) gameState.player.rank = 'B';
            else if (gameState.player.level >= 20) gameState.player.rank = 'C';
            else if (gameState.player.level >= 10) gameState.player.rank = 'D';
            
            if (oldRank !== gameState.player.rank) {
                showNotification(`üéä RANK UP! Ora sei Rank ${gameState.player.rank}!`);
                
                // Offer job class selection at C and A rank
                if (gameState.player.rank === 'C' && gameState.player.jobClass === 'none') {
                    setTimeout(() => offerJobClass('C'), 1000);
                } else if (gameState.player.rank === 'A' && !gameState.player.jobClass.includes('Shadow') && !gameState.player.jobClass.includes('Berserker') && !gameState.player.jobClass.includes('Sage')) {
                    setTimeout(() => offerJobClass('A'), 1000);
                }
            }
        }

        function offerJobClass(rank) {
            const options = jobClasses[rank].options;
            const choice = prompt(`üéä HAI RAGGIUNTO RANK ${rank}!\n\nScegli la tua Job Class:\n\n1. ${options[0]}\n2. ${options[1]}\n3. ${options[2]}\n\nInserisci 1, 2 o 3:`);
            
            if (choice === '1' || choice === '2' || choice === '3') {
                const selectedClass = options[parseInt(choice) - 1];
                gameState.player.jobClass = selectedClass;
                showNotification(`‚öîÔ∏è Sei diventato un ${selectedClass}!`);
                saveGame();
                updateUI();
            }
        }

        function takeDamage(amount, reason) {
            gameState.player.hp = Math.max(0, gameState.player.hp - amount);
            
            showNotification(`‚ö†Ô∏è -${amount} HP: ${reason}`, false, true);
            
            if (gameState.player.hp === 0) {
                triggerDeath();
            }
            
            saveGame();
            updateUI();
        }

        function triggerDeath() {
            // Check Immortal skill
            const immortalSkill = gameState.skills.combat?.find(s => s.id === 'immortal' && s.unlocked);
            if (immortalSkill && !immortalSkill.used) {
                immortalSkill.used = true;
                gameState.player.hp = 1;
                showNotification("üíÄ Immortal Skill Attivato! Sei sopravvissuto con 1 HP!");
                saveGame();
                updateUI();
                return;
            }
            
            // Apply death penalties
            gameState.player.exp = 0;
            gameState.inventory.manaStones = Math.floor(gameState.inventory.manaStones * 0.5);
            
            // Reduce shadow army levels
            gameState.shadowArmy.forEach(shadow => {
                shadow.level = Math.max(1, shadow.level - 1);
                shadow.streak = Math.max(0, shadow.streak - 7);
            });
            
            // Set death timer
            gameState.player.deathTime = Date.now() + 86400000; // 24 hours
            
            showNotification("üíÄ SEI MORTO! Resurrezione tra 24 ore...", false, true);
            sendPushNotification("üíÄ Morte", "Sei morto! L'app sar√† bloccata per 24 ore.");
            
            checkAchievement('survivor');
            checkArchiveUnlock('first_death');
            
            saveGame();
            updateUI();
        }

        function checkDeath() {
            if (gameState.player.deathTime) {
                const timeLeft = gameState.player.deathTime - Date.now();
                
                if (timeLeft <= 0) {
                    // Resurrection
                    gameState.player.deathTime = null;
                    gameState.player.hp = Math.floor(gameState.player.maxHP * 0.5);
                    document.getElementById('deathScreen').classList.remove('active');
                    showNotification("‚ú® Sei risorto! Benvenuto indietro, Hunter!");
                    saveGame();
                    updateUI();
                } else {
                    // Update death timer
                    document.getElementById('deathScreen').classList.add('active');
                    document.getElementById('deathTimer').textContent = formatTime(timeLeft);
                }
            } else {
                document.getElementById('deathScreen').classList.remove('active');
            }
        }

        function updateTimers() {
            // Update daily quest timers
            gameState.quests.daily.forEach(quest => {
                if (quest.accepted && quest.deadline && !quest.completed) {
                    const timeLeft = quest.deadline - Date.now();
                    const timerEl = document.getElementById(`timer-${quest.id}`);
                    
                    if (timerEl) {
                        if (timeLeft <= 0) {
                            takeDamage(quest.penalty || 10, `Quest "${quest.title}" scaduta!`);
                            quest.accepted = false;
                            quest.deadline = null;
                            saveGame();
                            updateUI();
                        } else {
                            timerEl.textContent = formatTime(timeLeft);
                        }
                    }
                }
            });
            
            // Update custom quest timers
            (gameState.quests.custom || []).forEach(quest => {
                if (quest.accepted && quest.deadline && !quest.completed) {
                    const timeLeft = quest.deadline - Date.now();
                    const timerEl = document.getElementById(`timer-${quest.id}`);
                    
                    if (timerEl) {
                        if (timeLeft <= 0) {
                            takeDamage(quest.penalty || 10, `Quest "${quest.title}" scaduta!`);
                            quest.accepted = false;
                            quest.deadline = null;
                            saveGame();
                            updateUI();
                        } else {
                            timerEl.textContent = formatTime(timeLeft);
                        }
                    }
                }
            });
            
            // Update emergency quest timer
            if (gameState.quests.emergency && gameState.quests.emergency.deadline) {
                const timeLeft = gameState.quests.emergency.deadline - Date.now();
                const timerEl = document.getElementById(`timer-${gameState.quests.emergency.id}`);
                
                if (timerEl) {
                    if (timeLeft <= 0) {
                        takeDamage(20, "Emergency Quest Fallita!");
                        gameState.quests.emergency = null;
                        saveGame();
                        updateUI();
                    } else {
                        timerEl.textContent = formatTime(timeLeft);
                    }
                }
            }
            
            // Update boss quest timer
            if (gameState.quests.boss && gameState.quests.boss.accepted && gameState.quests.boss.deadline) {
                const timeLeft = gameState.quests.boss.deadline - Date.now();
                const timerEl = document.getElementById(`timer-${gameState.quests.boss.id}`);
                
                if (timerEl) {
                    if (timeLeft <= 0) {
                        takeDamage(gameState.quests.boss.penalty || 30, "Boss Fight Fallita!");
                        gameState.quests.boss.accepted = false;
                        gameState.quests.boss.deadline = null;
                        saveGame();
                        updateUI();
                    } else {
                        timerEl.textContent = formatTime(timeLeft);
                    }
                }
            }
            
            // Update status effect timers
            gameState.player.statusEffects = gameState.player.statusEffects.filter(effect => {
                if (effect.duration) {
                    return effect.duration > Date.now();
                }
                return true;
            });
        }

        function formatTime(ms) {
            const hours = Math.floor(ms / 3600000);
            const minutes = Math.floor((ms % 3600000) / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function updateShadowArmy(quest) {
            let shadow = gameState.shadowArmy.find(s => s.questTitle === quest.title);
            
            if (shadow) {
                shadow.streak++;
                if (shadow.streak >= 30 && shadow.level < 3) {
                    shadow.level++;
                    showNotification(`üë• Shadow Army Level Up! ${shadow.name} √® ora livello ${shadow.level}!`);
                }
            } else if (quest.completed) {
                gameState.shadowArmy.push({
                    name: quest.title,
                    questTitle: quest.title,
                    level: 1,
                    streak: 1,
                    bonus: calculateShadowBonus(quest)
                });
                checkArchiveUnlock('first_shadow');
            }
            
            checkAchievement('shadow_master');
        }

        function breakShadowStreak(quest) {
            const shadow = gameState.shadowArmy.find(s => s.questTitle === quest.title);
            if (shadow) {
                shadow.streak = Math.max(0, shadow.streak - 3);
                if (shadow.streak === 0) {
                    gameState.shadowArmy = gameState.shadowArmy.filter(s => s !== shadow);
                    showNotification(`üë• Shadow persa: ${shadow.name}`);
                }
            }
        }

        function calculateShadowBonus(quest) {
            const baseBonus = Math.floor(quest.reward / 10);
            return `+${baseBonus} ${quest.category || 'general'} auto`;
        }

        function renderSelfComparison() {
            const container = document.getElementById('selfComparison');
            // Count both daily and custom completed quests
            const dailyCompleted = gameState.quests.daily.filter(q => q.completed).length;
            const customCompleted = (gameState.quests.custom || []).filter(q => q.completed).length;
            const todayQuests = dailyCompleted + customCompleted;
            const yesterdayQuests = gameState.history.yesterday.quests || 0;
            
            container.innerHTML = `
                <div class="comparison-box">
                    <div class="comparison-title">‚öîÔ∏è OGGI vs IERI</div>
                    <div class="comparison-row">
                        <div class="comparison-label">Quest Completate</div>
                        <div class="comparison-values">
                            <span class="comparison-old">Ieri: ${yesterdayQuests}</span>
                            <span class="comparison-new ${todayQuests >= yesterdayQuests ? 'winning' : 'losing'}">Oggi: ${todayQuests}</span>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 15px; font-size: 18px; color: ${todayQuests >= yesterdayQuests ? '#4ecdc4' : '#ff6b6b'};">
                        ${todayQuests > yesterdayQuests ? '‚úÖ DOMINIO TOTALE!' : todayQuests === yesterdayQuests ? '‚öñÔ∏è PAREGGIO' : '‚ö†Ô∏è Stai perdendo! Fai meglio!'}
                    </div>
                </div>
            `;
        }

        function renderShadowArmy() {
            const container = document.getElementById('shadowArmyList');
            
            if (gameState.shadowArmy.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">Completa quest per 30 giorni di fila per ottenere Shadow Army!</div>';
                return;
            }
            
            container.innerHTML = '';
            gameState.shadowArmy.forEach(shadow => {
                const div = document.createElement('div');
                div.className = 'shadow-item';
                div.innerHTML = `
                    <div class="shadow-name">Lv.${shadow.level} ${shadow.name}</div>
                    <div class="shadow-streak">üî• Streak: ${shadow.streak} giorni</div>
                    <div class="shadow-bonus">Bonus: ${shadow.bonus}</div>
                `;
                container.appendChild(div);
            });
        }

        function renderCompletionCalendar() {
            const container = document.getElementById('completionCalendar');
            if (!container) return;
            
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            // Get first and last day of month
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDayOfWeek = firstDay.getDay(); // 0 = Sunday
            
            const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                              'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
            
            let html = `
                <div style="text-align: center; margin-bottom: 10px;">
                    <h3 style="color: #ffd700; margin: 0; font-size: 18px;">${monthNames[currentMonth]} ${currentYear}</h3>
                    <p style="color: #bbb; font-size: 10px; margin: 5px 0; line-height: 1.3;">
                        üü¢ = Completate | ‚ùå = Mancate | ‚ö™ = Nessuna
                    </p>
                </div>
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-bottom: 5px;">
                    <div style="text-align: center; color: #888; font-size: 9px; padding: 2px;">D</div>
                    <div style="text-align: center; color: #888; font-size: 9px; padding: 2px;">L</div>
                    <div style="text-align: center; color: #888; font-size: 9px; padding: 2px;">M</div>
                    <div style="text-align: center; color: #888; font-size: 9px; padding: 2px;">M</div>
                    <div style="text-align: center; color: #888; font-size: 9px; padding: 2px;">G</div>
                    <div style="text-align: center; color: #888; font-size: 9px; padding: 2px;">V</div>
                    <div style="text-align: center; color: #888; font-size: 9px; padding: 2px;">S</div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px;">
            `;
            
            // Add empty cells for days before month starts
            for (let i = 0; i < startDayOfWeek; i++) {
                html += '<div style="padding: 5px;"></div>';
            }
            
            // Add days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dateISO = date.toISOString().split('T')[0];
                const isToday = day === now.getDate();
                const isFuture = date > now;
                
                let emoji = '‚ö™';
                let bgColor = 'rgba(100,100,100,0.1)';
                let borderColor = 'rgba(100,100,100,0.3)';
                
                if (!isFuture && gameState.completionCalendar && gameState.completionCalendar[dateISO]) {
                    const dayData = gameState.completionCalendar[dateISO];
                    if (dayData.completed) {
                        emoji = 'üü¢';
                        bgColor = 'rgba(34, 197, 94, 0.2)';
                        borderColor = 'rgba(34, 197, 94, 0.5)';
                    } else if (dayData.total > 0) {
                        emoji = '‚ùå';
                        bgColor = 'rgba(239, 68, 68, 0.2)';
                        borderColor = 'rgba(239, 68, 68, 0.5)';
                    }
                }
                
                const todayBorder = isToday ? 'border: 2px solid #ffd700;' : `border: 1px solid ${borderColor};`;
                
                html += `
                    <div style="
                        background: ${bgColor};
                        ${todayBorder}
                        border-radius: 6px;
                        padding: 4px 2px;
                        text-align: center;
                        min-height: 38px;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        ${isFuture ? 'opacity: 0.3;' : ''}
                    ">
                        <div style="font-size: 9px; color: #bbb; margin-bottom: 1px;">${day}</div>
                        <div style="font-size: 14px;">${emoji}</div>
                    </div>
                `;
            }
            
            html += '</div>';
            
            // Add statistics
            if (!gameState.completionCalendar) gameState.completionCalendar = {};
            const completedDays = Object.values(gameState.completionCalendar).filter(d => d.completed).length;
            const totalTracked = Object.keys(gameState.completionCalendar).length;
            const completionRate = totalTracked > 0 ? Math.round((completedDays / totalTracked) * 100) : 0;
            
            html += `
                <div style="margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; text-align: center;">
                    <div style="color: #ffd700; font-weight: bold; margin-bottom: 5px;">üìä Statistiche</div>
                    <div style="color: #bbb; font-size: 13px;">
                        Giorni perfetti: ${completedDays} / ${totalTracked} 
                        ${totalTracked > 0 ? `(${completionRate}%)` : ''}
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function checkAchievements() {
            // Iron Will
            const longestStreak = Math.max(...(gameState.shadowArmy.map(s => s.streak) || [0]));
            if (longestStreak >= 30) checkAchievement('iron_will');
            
            // Shadow Master
            if (gameState.shadowArmy.length >= 10) checkAchievement('shadow_master');
            
            // Count quest types
            const physicalCount = gameState.shadowArmy.filter(s => s.bonus.includes('physical')).length;
            const intellectualCount = gameState.shadowArmy.filter(s => s.bonus.includes('intelligence')).length;
            
            if (physicalCount >= 100) checkAchievement('warrior');
            if (intellectualCount >= 100) checkAchievement('scholar');
        }

        function checkAchievement(achievementId) {
            const achievement = gameState.achievements.find(a => a.id === achievementId);
            if (achievement && !achievement.unlocked) {
                achievement.unlocked = true;
                showNotification(`üèÜ Achievement Sbloccato: ${achievement.title}!`);
                applyAchievementBonus(achievement);
                saveGame();
                updateUI();
            }
        }

        function applyAchievementBonus(achievement) {
            switch(achievement.id) {
                case 'iron_will':
                    gameState.player.maxHP += 10;
                    gameState.player.hp += 10;
                    break;
                case 'shadow_master':
                    gameState.player.maxMP += 20;
                    gameState.player.mp += 20;
                    break;
                case 'scholar':
                    gameState.player.stats.int += 15;
                    break;
                case 'warrior':
                    gameState.player.stats.str += 15;
                    break;
                case 'emergency_hero':
                    gameState.player.maxHP += 100;
                    gameState.player.hp += 100;
                    break;
            }
        }

        function renderAchievements() {
            const container = document.getElementById('achievementsList');
            container.innerHTML = '';
            
            gameState.achievements.forEach(achievement => {
                const div = document.createElement('div');
                div.className = `achievement-item ${achievement.unlocked ? 'unlocked' : ''}`;
                div.innerHTML = `
                    <div class="achievement-icon">${achievement.icon}</div>
                    <div class="achievement-title">${achievement.title}</div>
                    <div class="achievement-desc">${achievement.desc}</div>
                `;
                div.onclick = () => {
                    if (achievement.unlocked) {
                        const setActive = confirm(`Vuoi impostare "${achievement.title}" come titolo attivo?\nBonus: ${achievement.bonus}`);
                        if (setActive) {
                            gameState.player.activeTitle = achievement.id;
                            saveGame();
                            updateUI();
                        }
                    }
                };
                container.appendChild(div);
            });
        }

        function renderSkillTree() {
            const container = document.getElementById('skillTree');
            container.innerHTML = '';
            
            ['combat', 'magic', 'support'].forEach(branch => {
                const branchDiv = document.createElement('div');
                branchDiv.className = 'skill-branch';
                
                const titles = { combat: '‚öîÔ∏è Combat', magic: '‚ú® Magic', support: 'üõ°Ô∏è Support' };
                branchDiv.innerHTML = `<div class="skill-branch-title">${titles[branch]}</div><div class="skill-list" id="${branch}-skills"></div>`;
                
                container.appendChild(branchDiv);
                
                const skillList = document.getElementById(`${branch}-skills`);
                gameState.skills[branch].forEach(skill => {
                    const canUnlock = !skill.requires || gameState.skills[branch].find(s => s.id === skill.requires)?.unlocked;
                    const isLocked = !skill.unlocked && (!canUnlock || gameState.player.skillPoints < skill.cost);
                    
                    const div = document.createElement('div');
                    div.className = `skill-item ${skill.unlocked ? 'unlocked' : ''} ${isLocked ? 'locked' : ''}`;
                    div.innerHTML = `
                        <div class="skill-name">${skill.name} ${skill.unlocked ? '‚úÖ' : ''}</div>
                        <div class="skill-desc">${skill.desc}</div>
                        <div class="skill-cost">Costo: ${skill.cost} SP ${skill.requires ? `| Richiede: ${skill.requires}` : ''}</div>
                    `;
                    
                    div.onclick = () => {
                        if (!skill.unlocked && canUnlock && gameState.player.skillPoints >= skill.cost) {
                            const confirm = window.confirm(`Sbloccare ${skill.name} per ${skill.cost} Skill Points?`);
                            if (confirm) {
                                skill.unlocked = true;
                                gameState.player.skillPoints -= skill.cost;
                                showNotification(`‚ú® Skill Sbloccata: ${skill.name}!`);
                                saveGame();
                                updateUI();
                            }
                        }
                    };
                    
                    skillList.appendChild(div);
                });
            });
        }

        function renderInventory() {
            const grid = document.getElementById('inventoryGrid');
            
            if (gameState.inventory.items.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; color: #999; padding: 40px;">
                        Nessun oggetto nell'inventario.
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = '';
            gameState.inventory.items.forEach((item, index) => {
                const slot = document.createElement('div');
                slot.className = `inventory-slot ${item.effect ? 'has-effect' : ''}`;
                slot.innerHTML = `
                    <div class="item-icon">${item.icon}</div>
                    <div style="font-size: 10px; text-align: center; margin-top: 5px;">${item.name}</div>
                    <div class="item-count">x${item.quantity}</div>
                    ${item.effect ? `<div class="item-effect">‚ú®</div>` : ''}
                `;
                slot.onclick = () => showItemOptions(index);
                grid.appendChild(slot);
            });
        }

        function applyItemEffects() {
            // Apply passive effects from items
            gameState.inventory.items.forEach(item => {
                if (item.effect === 'hp_regen') {
                    // Check if already applied today
                    if (!item.lastRegenDate || item.lastRegenDate !== new Date().toDateString()) {
                        gameState.player.hp = Math.min(gameState.player.maxHP, gameState.player.hp + 5);
                        item.lastRegenDate = new Date().toDateString();
                    }
                }
                if (item.effect === 'mp_regen') {
                    if (!item.lastRegenDate || item.lastRegenDate !== new Date().toDateString()) {
                        gameState.player.mp = Math.min(gameState.player.maxMP, gameState.player.mp + 3);
                        item.lastRegenDate = new Date().toDateString();
                    }
                }
            });
        }

        function showAddItemModal() {
            document.getElementById('addItemModal').classList.add('show');
            document.getElementById('itemIcon').value = 'üì¶';
            document.getElementById('itemName').value = '';
            document.getElementById('itemQuantity').value = '1';
            document.getElementById('itemEffect').value = '';
        }

        function closeAddItemModal() {
            document.getElementById('addItemModal').classList.remove('show');
        }

        function addItemToInventory() {
            const icon = document.getElementById('itemIcon').value || 'üì¶';
            const name = document.getElementById('itemName').value.trim();
            const quantity = parseInt(document.getElementById('itemQuantity').value) || 1;
            const effect = document.getElementById('itemEffect').value;
            
            if (!name) {
                showNotification('‚ö†Ô∏è Inserisci un nome per l\'oggetto!');
                return;
            }
            
            const existingItem = gameState.inventory.items.find(item => item.name === name);
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                gameState.inventory.items.push({
                    icon, name, quantity, effect: effect || null
                });
            }
            
            saveGame();
            updateUI();
            closeAddItemModal();
            showNotification(`‚úÖ ${icon} ${name} aggiunto all'inventario!`);
        }

        function showItemOptions(index) {
            const item = gameState.inventory.items[index];
            const effectText = item.effect ? `\nEffetto: ${item.effect}` : '';
            const action = confirm(`${item.icon} ${item.name} (x${item.quantity})${effectText}\n\nVuoi rimuovere questo oggetto?`);
            
            if (action) {
                gameState.inventory.items.splice(index, 1);
                saveGame();
                updateUI();
                showNotification('üóëÔ∏è Oggetto rimosso dall\'inventario');
            }
        }

        function renderCrafting() {
            const grid = document.getElementById('craftingGrid');
            grid.innerHTML = '';
            
            craftingRecipes.forEach(recipe => {
                if (!recipe.unlocked) {
                    const masterCrafter = gameState.skills.support?.find(s => s.id === 'master_crafter' && s.unlocked);
                    if (!masterCrafter) return;
                    recipe.unlocked = true;
                }
                
                const canCraft = recipe.materials.every(mat => {
                    if (mat.name === 'Mana Stones') {
                        return gameState.inventory.manaStones >= mat.count;
                    }
                    const item = gameState.inventory.items.find(i => i.name === mat.name);
                    return item && item.quantity >= mat.count;
                });
                
                const div = document.createElement('div');
                div.className = `recipe-item ${recipe.unlocked ? 'unlocked' : ''}`;
                div.innerHTML = `
                    <div class="recipe-name">${recipe.name}</div>
                    <div class="recipe-materials">
                        ${recipe.materials.map(m => `${m.name} x${m.count}`).join(', ')}
                    </div>
                    <button class="craft-btn" ${canCraft ? '' : 'disabled'} onclick="craft('${recipe.id}')">
                        Craft
                    </button>
                `;
                grid.appendChild(div);
            });
        }

        function craft(recipeId) {
            const recipe = craftingRecipes.find(r => r.id === recipeId);
            if (!recipe) return;
            
            // Check materials
            const canCraft = recipe.materials.every(mat => {
                if (mat.name === 'Mana Stones') {
                    return gameState.inventory.manaStones >= mat.count;
                }
                const item = gameState.inventory.items.find(i => i.name === mat.name);
                return item && item.quantity >= mat.count;
            });
            
            if (!canCraft) {
                showNotification('‚ö†Ô∏è Materiali insufficienti!');
                return;
            }
            
            // Consume materials
            recipe.materials.forEach(mat => {
                if (mat.name === 'Mana Stones') {
                    gameState.inventory.manaStones -= mat.count;
                } else {
                    const item = gameState.inventory.items.find(i => i.name === mat.name);
                    item.quantity -= mat.count;
                    if (item.quantity <= 0) {
                        gameState.inventory.items = gameState.inventory.items.filter(i => i !== item);
                    }
                }
            });
            
            // Apply result
            if (recipe.result.type === 'consumable') {
                if (recipe.result.effect === 'restore_hp') {
                    gameState.player.hp = Math.min(gameState.player.maxHP, gameState.player.hp + recipe.result.value);
                    showNotification(`‚úÖ Craftato! +${recipe.result.value} HP`);
                }
            } else if (recipe.result.type === 'buff') {
                gameState.player.statusEffects.push({
                    name: recipe.name,
                    type: 'buff',
                    effect: recipe.result.effect,
                    value: recipe.result.value,
                    duration: Date.now() + recipe.result.duration
                });
                showNotification(`‚úÖ Craftato! ${recipe.name} attivo!`);
            }
            
            saveGame();
            updateUI();
        }

        function showCreateQuestModal() {
            document.getElementById('createQuestModal').classList.add('show');
            document.getElementById('customQuestTitle').value = '';
            document.getElementById('customQuestDesc').value = '';
            document.getElementById('customQuestDifficulty').value = 'medium';
        }

        function toggleRecurrenceOptions() {
            const isRecurring = document.querySelector('input[name="recurrence"]:checked').value === 'recurring';
            document.getElementById('recurrenceOptions').style.display = isRecurring ? 'block' : 'none';
            if (isRecurring) {
                toggleDaySelector(); // Check if specific days is selected
            }
        }

        function toggleDaySelector() {
            const isSpecific = document.querySelector('input[name="recurrenceType"][value="specific"]')?.checked;
            document.getElementById('daySelector').style.display = isSpecific ? 'block' : 'none';
        }

        // Add listeners for recurrence type radio buttons
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('input[name="recurrenceType"]').forEach(radio => {
                radio.addEventListener('change', toggleDaySelector);
            });
        });

        function closeCreateQuestModal() {
            document.getElementById('createQuestModal').classList.remove('show');
        }

        function createCustomQuest() {
            const title = document.getElementById('customQuestTitle').value.trim();
            const desc = document.getElementById('customQuestDesc').value.trim();
            const difficulty = document.getElementById('customQuestDifficulty').value;
            
            if (!title || !desc) {
                showNotification('‚ö†Ô∏è Compila tutti i campi!');
                return;
            }
            
            const rewardMap = {
                easy: 30 + Math.floor(Math.random() * 10),
                medium: 50 + Math.floor(Math.random() * 20),
                hard: 80 + Math.floor(Math.random() * 20),
                extreme: 120 + Math.floor(Math.random() * 30)
            };
            
            const reward = rewardMap[difficulty];
            const penalty = Math.floor(reward / 5);
            
            // Get recurrence settings
            const isRecurring = document.querySelector('input[name="recurrence"]:checked').value === 'recurring';
            let recurrence = null;
            
            if (isRecurring) {
                const recurrenceType = document.querySelector('input[name="recurrenceType"]:checked').value;
                
                if (recurrenceType === 'daily') {
                    recurrence = { type: 'daily' };
                } else if (recurrenceType === 'weekdays') {
                    recurrence = { type: 'weekdays', days: [1, 2, 3, 4, 5] };
                } else if (recurrenceType === 'weekend') {
                    recurrence = { type: 'weekend', days: [0, 6] };
                } else if (recurrenceType === 'specific') {
                    const selectedDays = Array.from(document.querySelectorAll('.day-checkbox:checked'))
                        .map(cb => parseInt(cb.value));
                    
                    if (selectedDays.length === 0) {
                        showNotification('‚ö†Ô∏è Seleziona almeno un giorno!');
                        return;
                    }
                    
                    recurrence = { type: 'specific', days: selectedDays };
                }
            }
            
            if (!gameState.quests.custom) gameState.quests.custom = [];
            
            const quest = {
                id: Date.now(),
                title,
                description: desc,
                reward,
                penalty,
                completed: false,
                type: 'custom',
                category: 'productivity'
            };
            
            if (recurrence) {
                quest.recurring = true;
                quest.recurrence = recurrence;
                quest.completionHistory = []; // Track quando √® stata completata
            }
            
            gameState.quests.custom.push(quest);
            
            saveGame();
            updateUI();
            closeCreateQuestModal();
            
            const recurrenceText = recurrence ? 
                (recurrence.type === 'daily' ? ' (ogni giorno)' : 
                 recurrence.type === 'weekdays' ? ' (Lun-Ven)' :
                 recurrence.type === 'weekend' ? ' (Sab-Dom)' :
                 ' (giorni selezionati)') : '';
            
            showNotification(`‚úÖ Quest creata${recurrenceText}! Reward: ${reward} EXP`);
        }

        function drawRadarChart() {
            const canvas = document.getElementById('radarChart');
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = 120;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const stats = [
                { label: 'Fisico', value: gameState.player.radarStats.physical },
                { label: 'Intel', value: gameState.player.radarStats.intelligence },
                { label: 'Salute', value: gameState.player.radarStats.health },
                { label: 'Sociale', value: gameState.player.radarStats.social },
                { label: 'Produttivit√†', value: gameState.player.radarStats.productivity },
                { label: 'Creativit√†', value: gameState.player.radarStats.creativity }
            ];
            
            const angleStep = (Math.PI * 2) / stats.length;
            
            // Draw grid
            ctx.strokeStyle = 'rgba(106, 90, 205, 0.3)';
            ctx.lineWidth = 1;
            for (let i = 1; i <= 5; i++) {
                ctx.beginPath();
                const r = (radius / 5) * i;
                for (let j = 0; j <= stats.length; j++) {
                    const angle = angleStep * j - Math.PI / 2;
                    const x = centerX + Math.cos(angle) * r;
                    const y = centerY + Math.sin(angle) * r;
                    if (j === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.closePath();
                ctx.stroke();
            }
            
            // Draw axes
            ctx.strokeStyle = 'rgba(106, 90, 205, 0.5)';
            stats.forEach((stat, i) => {
                const angle = angleStep * i - Math.PI / 2;
                const x = centerX + Math.cos(angle) * radius;
                const y = centerY + Math.sin(angle) * radius;
                
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.lineTo(x, y);
                ctx.stroke();
                
                // Draw labels
                const labelX = centerX + Math.cos(angle) * (radius + 20);
                const labelY = centerY + Math.sin(angle) * (radius + 20);
                ctx.fillStyle = '#ffd700';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(stat.label, labelX, labelY);
            });
            
            // Draw data
            ctx.fillStyle = 'rgba(138, 43, 226, 0.3)';
            ctx.strokeStyle = 'rgba(138, 43, 226, 0.8)';
            ctx.lineWidth = 2;
            
            ctx.beginPath();
            stats.forEach((stat, i) => {
                const angle = angleStep * i - Math.PI / 2;
                const value = (stat.value / 100) * radius;
                const x = centerX + Math.cos(angle) * value;
                const y = centerY + Math.sin(angle) * value;
                
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
        }

        function showNotification(message, persistent = false, isEmergency = false) {
            const notif = document.getElementById('notification');
            notif.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; gap: 10px;">
                    <div style="flex: 1;">${message}</div>
                    <button onclick="closeNotification()" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">‚úï</button>
                </div>
            `;
            notif.classList.remove('emergency');
            
            if (isEmergency) {
                notif.classList.add('emergency');
            }
            
            notif.classList.add('show');
            
            if (!persistent) {
                setTimeout(() => {
                    notif.classList.remove('show');
                }, 3000);
            }
        }

        function closeNotification() {
            const notif = document.getElementById('notification');
            notif.classList.remove('show');
        }

        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        function sendPushNotification(title, body) {
            if (!gameState.notificationsEnabled) return;
            
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, {
                    body: body,
                    icon: '‚öîÔ∏è',
                    badge: '‚öîÔ∏è'
                });
            }
        }

        function toggleNotifications() {
            gameState.notificationsEnabled = document.getElementById('notificationsEnabled').checked;
            
            if (gameState.notificationsEnabled && 'Notification' in window) {
                if (Notification.permission === 'default') {
                    Notification.requestPermission().then(permission => {
                        if (permission !== 'granted') {
                            gameState.notificationsEnabled = false;
                            document.getElementById('notificationsEnabled').checked = false;
                            showNotification('‚ö†Ô∏è Permesso notifiche negato!');
                        }
                    });
                } else if (Notification.permission === 'denied') {
                    gameState.notificationsEnabled = false;
                    document.getElementById('notificationsEnabled').checked = false;
                    showNotification('‚ö†Ô∏è Permesso notifiche negato! Abilitale nelle impostazioni del browser.');
                }
            }
            
            saveGame();
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById('tab-' + tab).classList.add('active');
            
            const navButtons = document.querySelectorAll('.nav-btn');
            const buttonIndex = {'player': 0, 'quests': 1, 'progress': 2, 'inventory': 3, 'settings': 4};
            if (buttonIndex[tab] !== undefined) {
                navButtons[buttonIndex[tab]].classList.add('active');
            }
        }

        function saveProfession() {
            const profession = document.getElementById('professionInput').value.trim();
            gameState.player.profession = profession || 'none';
            gameState.quests.daily = generateDailyQuests();
            saveGame();
            updateUI();
            showNotification('‚úÖ Professione aggiornata! Le quest sono state rigenerate.');
        }

        function saveName() {
            const name = document.getElementById('nameInput').value.trim();
            if (name) {
                gameState.player.name = name;
                saveGame();
                updateUI();
                showNotification('‚úÖ Nome salvato!');
            }
        }

        function resetProgress() {
            if (confirm('Sei sicuro di voler resettare tutto il progresso?')) {
                localStorage.removeItem('realLifeLevelingComplete');
                location.reload();
            }
        }

        function exportSave() {
            try {
                const saveData = localStorage.getItem('realLifeLevelingComplete');
                
                if (!saveData) {
                    showNotification('‚ö†Ô∏è Nessun salvataggio da esportare!');
                    return;
                }
                
                // Create a downloadable file
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(saveData);
                const downloadAnchor = document.createElement('a');
                downloadAnchor.setAttribute("href", dataStr);
                
                // Generate filename with date
                const date = new Date().toISOString().split('T')[0];
                const playerName = gameState.player.name.replace(/[^a-z0-9]/gi, '_');
                downloadAnchor.setAttribute("download", `RealLifeLeveling_${playerName}_${date}.json`);
                
                document.body.appendChild(downloadAnchor);
                downloadAnchor.click();
                downloadAnchor.remove();
                
                showNotification('‚úÖ Salvataggio esportato! File scaricato.');
            } catch (error) {
                console.error('Export error:', error);
                alert('‚ùå Errore durante l\'esportazione: ' + error.message);
            }
        }

        // ============================================================
        // DAILY LOGIN BONUS
        // ============================================================
        const loginBonusSchedule = [
            { day: 1, exp: 50,  label: '+50 EXP',  extra: '' },
            { day: 2, exp: 50,  label: '+50 EXP',  extra: '' },
            { day: 3, exp: 100, label: '+100 EXP', extra: '' },
            { day: 4, exp: 100, label: '+100 EXP', extra: '' },
            { day: 5, exp: 150, label: '+150 EXP', extra: '' },
            { day: 6, exp: 150, label: '+150 EXP', extra: '' },
            { day: 7, exp: 300, label: '+300 EXP', extra: 'üéÅ Mystery Box inclusa!' }
        ];

        function checkLoginBonus() {
            if (!gameState.loginBonus) {
                gameState.loginBonus = { lastLoginDate: null, loginStreak: 0, claimedToday: false };
            }
            
            const today = new Date().toDateString();
            const yesterday = new Date(Date.now() - 86400000).toDateString();
            const lb = gameState.loginBonus;

            if (lb.claimedToday && lb.lastLoginDate === today) return; // already claimed

            // Update streak
            if (lb.lastLoginDate === yesterday) {
                // Consecutive day ‚Äî keep / increment streak (capped at 7 for cycle)
                lb.loginStreak = (lb.loginStreak % 7) + 1;
            } else if (lb.lastLoginDate !== today) {
                // Missed a day ‚Äî reset
                lb.loginStreak = 1;
            }

            lb.claimedToday = false;
            showLoginBonusModal();
        }

        function showLoginBonusModal() {
            const lb = gameState.loginBonus;
            const streakDay = Math.max(1, Math.min(lb.loginStreak, 7));
            const bonus = loginBonusSchedule[streakDay - 1];

            // Build dot row
            let dotsHTML = '';
            for (let i = 1; i <= 7; i++) {
                const cls = i < streakDay ? 'done' : i === streakDay ? 'today' : '';
                dotsHTML += `<div class="login-day-dot ${cls}">G${i}</div>`;
            }

            document.getElementById('loginStreakDots').innerHTML = dotsHTML;
            document.getElementById('loginBonusDescription').textContent = bonus.label;
            document.getElementById('loginBonusExtra').textContent = bonus.extra;
            document.getElementById('loginBonusModal').style.display = 'flex';
        }

        function claimLoginBonus() {
            const lb = gameState.loginBonus;
            const streakDay = Math.max(1, Math.min(lb.loginStreak, 7));
            const bonus = loginBonusSchedule[streakDay - 1];

            gainEXP(bonus.exp);
            lb.claimedToday = true;
            lb.lastLoginDate = new Date().toDateString();

            document.getElementById('loginBonusModal').style.display = 'none';

            if (streakDay === 7) {
                openMysteryBox();
            }

            showNotification(`üéÅ Login Bonus: ${bonus.label} ricevuto! Giorno ${streakDay}/7`);
            saveGame();
            updateUI();
        }

        function openMysteryBox() {
            const roll = Math.random();
            let reward;

            if (roll < 0.60) {
                const exp = 500 + Math.floor(Math.random() * 501); // 500‚Äì1000
                reward = { label: `‚ö° ${exp} EXP BONUS!`, action: () => gainEXP(exp) };
            } else if (roll < 0.85) {
                const rareTitles = ['üåë Il Silenzioso', 'üî• Forgiato nel Fuoco', 'üåä Occhio del Ciclone', 'üíé Senza Paura', '‚öîÔ∏è Taglia con la Spada'];
                const title = rareTitles[Math.floor(Math.random() * rareTitles.length)];
                reward = {
                    label: `üèÜ Titolo Raro: "${title}"!`,
                    action: () => {
                        const id = 'rare_' + Date.now();
                        gameState.achievements.push({ id, icon: 'üèÜ', title, desc: 'Ottenuto dalla Mystery Box', unlocked: true, bonus: 'Titolo Raro' });
                    }
                };
            } else if (roll < 0.95) {
                reward = {
                    label: '‚ûï +1 Quest Slot Extra!',
                    action: () => {
                        if (!gameState.extraQuestSlots) gameState.extraQuestSlots = 0;
                        gameState.extraQuestSlots++;
                        // Generate one extra daily quest
                        const extra = generateDailyQuests().slice(0, 1);
                        gameState.quests.daily.push(...extra);
                    }
                };
            } else {
                const stat = ['str','agi','int','vit','sen','luck'][Math.floor(Math.random() * 6)];
                const statLabel = { str:'Forza', agi:'Agilit√†', int:'Intelligenza', vit:'Vitalit√†', sen:'Sensi', luck:'Fortuna' };
                reward = {
                    label: `üíé JACKPOT! +3 ${statLabel[stat]} PERMANENTE!`,
                    action: () => { gameState.player.stats[stat] += 3; }
                };
            }

            reward.action();

            // Show mystery box result popup
            setTimeout(() => {
                const popup = document.createElement('div');
                popup.style.cssText = `position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
                    background:linear-gradient(135deg,#1a0a2e,#0a0016);
                    border:2px solid #ffd700;border-radius:20px;padding:35px;
                    text-align:center;z-index:10002;max-width:320px;width:90%;
                    box-shadow:0 0 50px rgba(255,215,0,0.4);animation:loginPop 0.5s ease;`;
                popup.innerHTML = `
                    <div style="font-size:48px;margin-bottom:10px;">üéÅ</div>
                    <div style="font-size:18px;font-weight:bold;color:#ffd700;margin-bottom:10px;">MYSTERY BOX APERTA!</div>
                    <div style="font-size:20px;color:#fff;font-weight:bold;margin:15px 0;">${reward.label}</div>
                    <div style="font-size:12px;color:#666;margin-bottom:15px;font-style:italic;">Ricompensa settimana 7 ‚Äî Streak completata</div>
                    <button onclick="this.parentElement.remove()" style="background:#ffd700;color:#000;border:none;padding:12px 30px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;">INCASSA! üî•</button>
                `;
                document.body.appendChild(popup);
                setTimeout(() => popup.remove(), 12000);
            }, 300);

            saveGame();
        }

        // ============================================================
        // BOSS FIGHT ‚Äî PHASED RENDERING
        // ============================================================
        function renderBossFight() {
            const container = document.getElementById('bossQuest');
            const titleEl = document.getElementById('bossTitle');
            if (!container) return;

            const boss = gameState.quests.boss;
            if (!boss || !boss.phases) {
                // Legacy boss from old save ‚Äî render old style
                container.innerHTML = createQuestHTML(boss);
                return;
            }

            if (titleEl) {
                titleEl.textContent = boss.isRaid ? 'üëë RAID BOSS ‚Äî EVENTO SPECIALE' : 'üíÄ Boss Fight Settimanale';
                titleEl.style.color = boss.isRaid ? '#ffd700' : '';
            }

            if (boss.completed) {
                container.innerHTML = `
                    <div class="boss-defeat-banner">
                        <div style="font-size:40px;margin-bottom:8px;">üíÄ</div>
                        <div style="color:#cc44ff;font-size:20px;font-weight:bold;">${boss.isRaid ? 'üëë RAID BOSS SCONFITTO!' : 'BOSS SCONFITTO!'}</div>
                        <div style="color:#ffd700;font-size:16px;margin:8px 0;">Titolo ottenuto: "${boss.defeatTitle}"</div>
                        ${boss.extraRewards?.length ? `<div style="color:#4ecdc4;font-size:13px;margin-top:8px;">${boss.extraRewards.join(' ‚Ä¢ ')}</div>` : ''}
                        <div style="color:#666;font-size:12px;margin-top:10px;">Torna luned√¨ per il prossimo boss.</div>
                    </div>
                `;
                return;
            }

            const isRaid = boss.isRaid;
            let html = `
                <div class="boss-card ${isRaid ? 'raid' : ''}">
                    <div class="boss-name ${isRaid ? 'raid' : ''}">${boss.name}</div>
                    <div class="boss-subtitle">${boss.subtitle}</div>
                    <div class="boss-lore">${boss.lore}</div>
                    ${isRaid ? `<div style="background:rgba(255,215,0,0.1);border:1px solid rgba(255,215,0,0.3);border-radius:8px;padding:8px;margin-bottom:12px;font-size:12px;color:#ffd700;text-align:center;">‚ö†Ô∏è RAID BOSS ‚Äî appare ogni 4 settimane. Reward leggendarie.</div>` : ''}
            `;

            boss.phases.forEach((phase, i) => {
                const isActive = i === boss.currentPhase && !boss.completed;
                const isDone = phase.completed;
                const isLocked = i > boss.currentPhase;
                let cls = isLocked ? 'locked' : isDone ? 'completed' : 'active';
                if (isRaid) cls += ' raid-phase';

                html += `
                    <div class="boss-phase ${cls}">
                        <div class="boss-phase-title ${isRaid ? 'raid-phase-title' : ''}">${isDone ? '‚úÖ' : isLocked ? 'üîí' : '‚öîÔ∏è'} ${phase.title}</div>
                        <div class="boss-phase-desc">${phase.desc}</div>
                        ${phase.partialReward > 0 ? `<div class="boss-phase-reward">‚ö° Reward parziale: +${phase.partialReward} EXP</div>` : ''}
                    </div>
                `;
            });

            const currentPhaseData = boss.phases[boss.currentPhase];
            html += `
                    <div style="font-size:12px;color:#888;margin-top:10px;text-align:center;">
                        Fase ${boss.currentPhase + 1}/3 ‚Ä¢ Reward finale: +${boss.defeatReward} EXP + "${boss.defeatTitle}"
                    </div>
                    <button class="${isRaid ? 'boss-complete-btn raid-btn' : 'boss-complete-btn'}" onclick="completeBossPhase()">
                        ‚öîÔ∏è Fase ${boss.currentPhase + 1} Completata
                    </button>
                </div>
            `;

            container.innerHTML = html;
        }

        function completeBossPhase() {
            const boss = gameState.quests.boss;
            if (!boss || boss.completed) return;

            const phase = boss.phases[boss.currentPhase];
            if (phase.completed) return;

            phase.completed = true;

            // Partial reward
            if (phase.partialReward > 0) {
                gainEXP(phase.partialReward);
                showNotification(`‚öîÔ∏è Fase ${boss.currentPhase + 1} completata! +${phase.partialReward} EXP`);
            }

            boss.currentPhase++;

            // Check if all phases done
            if (boss.currentPhase >= boss.phases.length) {
                boss.completed = true;
                gainEXP(boss.defeatReward);

                // Give title
                const titleId = 'boss_' + boss.bossId;
                if (!gameState.achievements.find(a => a.id === titleId)) {
                    gameState.achievements.push({
                        id: titleId, icon: boss.isRaid ? 'üëë' : 'üíÄ',
                        title: boss.defeatTitle, desc: `Sconfitto ${boss.name}`,
                        unlocked: true, bonus: `+${boss.defeatReward} EXP`
                    });
                }

                // Raid extra rewards
                if (boss.isRaid && boss.extraRewards) {
                    gameState.inventory.manaStones += 500;
                    Object.keys(gameState.player.stats).forEach(k => gameState.player.stats[k] += 5);
                    showNotification(`üëë RAID BOSS SCONFITTO! +${boss.defeatReward} EXP ‚Ä¢ +5 a tutti gli Stat ‚Ä¢ +500 Mana Stones!`, true);
                } else {
                    showNotification(`üíÄ BOSS SCONFITTO! +${boss.defeatReward} EXP! Titolo: "${boss.defeatTitle}"`, true);
                }

                checkArchiveUnlock('passive');
            } else {
                showNotification(`‚öîÔ∏è Fase ${boss.currentPhase}/3 sbloccata! Continua la battaglia...`);
            }

            saveGame();
            updateUI();
        }

        // ============================================================
        // DOUBLE OR NOTHING
        // ============================================================
        function gambleQuest(questId, type) {
            let quest;
            if (type === 'emergency') quest = gameState.quests.emergency;
            else if (type === 'boss') quest = gameState.quests.boss;
            else if (type === 'custom') quest = gameState.quests.custom?.find(q => q.id === questId);
            else quest = gameState.quests.daily.find(q => q.id === questId);
            
            if (!quest || quest.gambled || quest.completed) return;
            
            const win = Math.random() >= 0.5;
            quest.gambled = true;
            quest.gambleWon = win;
            
            if (win) {
                showNotification("üé≤ HAI VINTO LA SCOMMESSA! Questa quest dar√† 2x EXP!", false, false);
            } else {
                showNotification("üé≤ HAI PERSO! Questa quest non dar√† EXP. Paghi il prezzo della tua avidit√†.", false, false);
            }
            
            saveGame();
            updateUI();
        }

        // ============================================================
        // DUNGEON SETTIMANALE
        // ============================================================
        function getWeekKey() {
            const d = new Date();
            const jan1 = new Date(d.getFullYear(), 0, 1);
            const week = Math.ceil(((d - jan1) / 86400000 + jan1.getDay() + 1) / 7);
            return `${d.getFullYear()}-W${String(week).padStart(2,'0')}`;
        }

        function generateDungeon() {
            const weekKey = getWeekKey();
            const themeIndex = Math.floor(Math.random() * dungeonThemes.length);
            const theme = dungeonThemes[themeIndex];
            
            // Shuffle rooms and pick 5
            const shuffledRooms = [...theme.rooms].sort(() => Math.random() - 0.5).slice(0, 5);
            const rooms = shuffledRooms.map((r, i) => ({
                ...r,
                id: i,
                completed: false
            }));
            
            gameState.dungeon = {
                theme: theme.name,
                icon: theme.icon,
                description: theme.description,
                rooms: rooms,
                hp: 200,
                maxHP: 200,
                weekKey: weekKey,
                completed: false,
                abandoned: false
            };
            
            saveGame();
            updateUI();
            showNotification(`üè∞ Dungeon Settimanale attivato: ${theme.icon} ${theme.name}!`, true);
        }

        function checkDungeonWeekReset() {
            const weekKey = getWeekKey();
            if (!gameState.dungeon || gameState.dungeon.weekKey !== weekKey) {
                gameState.dungeon = null; // reset for new week
            }
        }

        function completeDungeonRoom(roomId) {
            if (!gameState.dungeon || gameState.dungeon.completed || gameState.dungeon.abandoned) return;
            
            const room = gameState.dungeon.rooms[roomId];
            if (!room || room.completed) return;
            
            // Check that previous room is completed (sequential)
            if (roomId > 0 && !gameState.dungeon.rooms[roomId - 1].completed) {
                showNotification("‚ö†Ô∏è Devi completare la stanza precedente prima!");
                return;
            }
            
            room.completed = true;
            gainEXP(room.reward);
            gameState.inventory.manaStones += room.mana;
            
            const allDone = gameState.dungeon.rooms.every(r => r.completed);
            if (allDone) {
                gameState.dungeon.completed = true;
                generateDungeonReward();
                // Unlock archive chapter for dungeon completion
                checkArchiveUnlock('dungeon');
            }
            
            showNotification(`‚öîÔ∏è Stanza ${roomId + 1} completata! +${room.reward} EXP, +${room.mana} Mana Stones`);
            saveGame();
            updateUI();
        }

        function generateDungeonReward() {
            // Generate a thematic reward
            const rewards = [
                { desc: "+5 a tutti gli Stat", action: () => { Object.keys(gameState.player.stats).forEach(k => gameState.player.stats[k] += 5); } },
                { desc: "+200 Mana Stones", action: () => { gameState.inventory.manaStones += 200; } },
                { desc: "+300 EXP bonus", action: () => { gainEXP(300); } },
                { desc: "+30 HP max permanente", action: () => { gameState.player.maxHP += 30; gameState.player.hp += 30; } },
                { desc: "+3 Punti Stat", action: () => { gameState.player.statPoints += 3; } },
            ];
            const r = rewards[Math.floor(Math.random() * rewards.length)];
            r.action();
            
            setTimeout(() => {
                showNotification(`üèÜ DUNGEON COMPLETATO! Ricompensa: ${r.desc}`, true);
            }, 500);
        }

        function abandonDungeon() {
            if (!gameState.dungeon || gameState.dungeon.completed || gameState.dungeon.abandoned) return;
            if (!confirm("‚ö†Ô∏è Sei sicuro di voler abbandonare il dungeon?\nPerdita: -25 HP. Potrai riprovare la settimana prossima.")) return;
            
            gameState.dungeon.abandoned = true;
            takeDamage(25, "Dungeon Abbandonato ‚Äî la vigliacceria ha un costo.");
            showNotification("üèÉ Dungeon abbandonato. -25 HP. Il Sistema ti ricorder√†.");
            saveGame();
            updateUI();
        }

        function renderDungeon() {
            const container = document.getElementById('dungeonSection');
            if (!container) return;

            checkDungeonWeekReset();

            if (!gameState.dungeon) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #bbb;">
                        <div style="font-size: 48px; margin-bottom: 10px;">üè∞</div>
                        <div style="margin-bottom: 10px; font-size: 14px;">Nessun dungeon attivo questa settimana.</div>
                        <div style="font-size: 12px; color: #666; margin-bottom: 15px;">5 stanze. 200 HP. Nessuna piet√†.</div>
                        <button class="dungeon-btn" onclick="generateDungeon()" style="width: auto; padding: 12px 30px;">
                            ‚öîÔ∏è Entra nel Dungeon
                        </button>
                    </div>
                `;
                return;
            }

            const d = gameState.dungeon;
            const hpPercent = (d.hp / d.maxHP) * 100;

            let html = `
                <div class="dungeon-header">
                    <div class="dungeon-title">${d.icon} ${d.theme}</div>
                    <div style="font-size: 12px; color: #aaa; margin-bottom: 10px; font-style: italic;">${d.description}</div>
                    <div class="dungeon-hp-bar stat-bar">
                        <div class="stat-label">
                            <span style="color:#ff8888;">Dungeon HP</span>
                            <span style="color:#ff8888;">${d.hp} / ${d.maxHP}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="dungeon-hp-fill progress-fill" style="width: ${hpPercent}%;"></div>
                        </div>
                    </div>
                </div>
            `;

            if (d.completed) {
                html += `
                    <div class="dungeon-completed-banner">
                        <div style="font-size: 40px;">üèÜ</div>
                        <div style="color: #ffd700; font-size: 20px; font-weight: bold; margin: 10px 0;">DUNGEON COMPLETATO!</div>
                        <div style="color: #bbb; font-size: 13px;">Hai dimostrato chi sei. Per ora.</div>
                        <div style="color: #666; font-size: 12px; margin-top: 8px;">Torna luned√¨ per un nuovo dungeon.</div>
                    </div>
                `;
            } else if (d.abandoned) {
                html += `
                    <div style="text-align: center; padding: 15px; background: rgba(50,50,50,0.3); border-radius: 10px; margin-bottom: 10px;">
                        <div style="font-size: 30px;">üèÉ</div>
                        <div style="color: #888; font-size: 14px; margin-top: 8px;">Hai abbandonato questo dungeon.<br>Il prossimo reset √® luned√¨.</div>
                    </div>
                `;
            } else {
                d.rooms.forEach((room, i) => {
                    const isPrev = i === 0 || d.rooms[i-1].completed;
                    const isActive = isPrev && !room.completed;
                    const roomClass = room.completed ? 'completed' : isActive ? 'active' : 'locked';
                    
                    html += `
                        <div class="dungeon-room ${roomClass}">
                            <span class="room-number">Stanza ${i+1}/5</span>
                            <div style="font-weight: bold; margin-bottom: 6px; color: ${room.completed ? '#4ecdc4' : isActive ? '#ff8888' : '#666'};">
                                ${room.completed ? '‚úÖ' : isActive ? '‚öîÔ∏è' : 'üîí'} ${room.title}
                            </div>
                            <div style="font-size: 13px; color: #aaa; margin-bottom: 8px;">${room.description}</div>
                            <div style="font-size: 12px; color: #ffd700;">Reward: +${room.reward} EXP ‚Ä¢ +${room.mana} Mana Stones</div>
                            ${isActive ? `<button class="dungeon-btn" onclick="completeDungeonRoom(${i})">‚öîÔ∏è Stanza Conquistata</button>` : ''}
                        </div>
                    `;
                });
                
                html += `<button class="dungeon-btn abandon" onclick="abandonDungeon()">üèÉ Abbandona Dungeon (-25 HP)</button>`;
            }

            container.innerHTML = html;
        }

        // ============================================================
        // GIUDIZIO DEL SISTEMA
        // ============================================================
        function calculateWeeklyGrade() {
            if (!gameState.completionCalendar) return { grade: 'F', stats: {} };
            
            // Get this week's days (Mon-Sun)
            const now = new Date();
            const dayOfWeek = now.getDay(); // 0=Sun
            const monday = new Date(now);
            monday.setDate(now.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
            
            let totalQuests = 0, completedQuests = 0;
            let perfectDays = 0, dayCount = 0;
            
            for (let i = 0; i < 7; i++) {
                const d = new Date(monday);
                d.setDate(monday.getDate() + i);
                if (d > now) break;
                const key = d.toISOString().split('T')[0];
                if (gameState.completionCalendar[key]) {
                    const dayData = gameState.completionCalendar[key];
                    totalQuests += dayData.total || 0;
                    completedQuests += dayData.done || 0;
                    if (dayData.completed) perfectDays++;
                    dayCount++;
                }
            }
            
            // Also count today's completions (not yet in calendar)
            const todayCompleted = gameState.quests.daily.filter(q => q.completed).length;
            const todayTotal = gameState.quests.daily.filter(q => q.accepted || q.completed).length;
            completedQuests += todayCompleted;
            totalQuests += todayTotal;
            if (todayTotal > 0 && todayCompleted === todayTotal) perfectDays++;
            dayCount = Math.max(1, dayCount + 1);
            
            const bossCompleted = gameState.quests.boss?.completed || false;
            const dungeonCompleted = gameState.dungeon?.completed || false;
            const completionRate = totalQuests > 0 ? completedQuests / totalQuests : 0;
            const streakDays = gameState.player.streak;
            
            // Grade calculation
            let score = completionRate * 60; // max 60 pts from quests
            if (bossCompleted) score += 20;
            if (dungeonCompleted) score += 15;
            if (streakDays >= 7) score += 10;
            else if (streakDays >= 3) score += 5;
            
            let grade;
            if (score >= 90) grade = 'S';
            else if (score >= 75) grade = 'A';
            else if (score >= 55) grade = 'B';
            else if (score >= 35) grade = 'C';
            else if (score >= 15) grade = 'D';
            else grade = 'F';
            
            return {
                grade,
                stats: {
                    questRate: Math.round(completionRate * 100),
                    completedQuests,
                    totalQuests,
                    perfectDays,
                    bossCompleted,
                    dungeonCompleted,
                    streak: streakDays,
                    score: Math.round(score)
                }
            };
        }

        function saveWeeklyJudgment() {
            const weekKey = getWeekKey();
            if (gameState.weeklyJudgment.lastJudgmentWeek === weekKey) return;
            
            const { grade, stats } = calculateWeeklyGrade();
            const comments = judgmentComments[grade];
            const comment = comments[Math.floor(Math.random() * comments.length)];
            
            gameState.weeklyJudgment.history.unshift({
                weekKey,
                grade,
                comment,
                stats,
                date: new Date().toLocaleDateString('it-IT')
            });
            
            // Keep only last 10 judgments
            if (gameState.weeklyJudgment.history.length > 10) {
                gameState.weeklyJudgment.history = gameState.weeklyJudgment.history.slice(0, 10);
            }
            
            gameState.weeklyJudgment.lastJudgmentWeek = weekKey;
            
            // Unlock S rank archive
            if (grade === 'S') checkArchiveUnlock('s_rank');
            
            saveGame();
        }

        function renderJudgment() {
            const container = document.getElementById('judgmentSection');
            if (!container) return;

            const { grade, stats } = calculateWeeklyGrade();
            const comments = judgmentComments[grade];
            const liveComment = comments[Math.floor(((new Date()).getDay() + gameState.player.level) % comments.length)];

            let html = `
                <div style="font-size: 12px; color: #666; text-align: center; margin-bottom: 10px; font-style: italic;">
                    Analisi corrente ‚Äî aggiornata in tempo reale
                </div>
                <div class="judgment-card">
                    <div style="color: #999; font-size: 12px; letter-spacing: 2px;">VALUTAZIONE SETTIMANALE</div>
                    <div class="judgment-grade ${grade}">${grade}</div>
                    <div class="judgment-comment">"${liveComment}"<br><span style="color:#555;font-size:11px;font-style:normal;">‚Äî Il Sistema</span></div>
                    <div class="judgment-stats">
                        <div class="judgment-stat">Quest completate <span>${stats.completedQuests}/${stats.totalQuests}</span></div>
                        <div class="judgment-stat">Tasso completamento <span>${stats.questRate}%</span></div>
                        <div class="judgment-stat">Giorni perfetti <span>${stats.perfectDays}</span></div>
                        <div class="judgment-stat">Streak <span>${stats.streak} gg</span></div>
                        <div class="judgment-stat">Boss settimana <span>${stats.bossCompleted ? '‚úÖ' : '‚ùå'}</span></div>
                        <div class="judgment-stat">Dungeon <span>${stats.dungeonCompleted ? '‚úÖ' : '‚ùå'}</span></div>
                    </div>
                    <div style="font-size: 12px; color: #555; margin-top: 5px;">Punteggio: ${stats.score}/100</div>
                </div>
            `;

            if (gameState.weeklyJudgment.history.length > 0) {
                html += `<div style="font-size: 14px; color: #ffd700; margin-bottom: 10px; font-weight: bold;">üìú Storico Giudizi</div>`;
                gameState.weeklyJudgment.history.forEach(j => {
                    html += `
                        <div class="judgment-history-item">
                            <div>
                                <div style="font-size: 13px; color: #fff;">${j.weekKey}</div>
                                <div style="font-size: 11px; color: #666;">${j.date} ‚Ä¢ Score: ${j.stats?.score || '?'}/100</div>
                                <div style="font-size: 11px; color: #8a6fe8; margin-top: 3px; font-style: italic;">"${j.comment.substring(0,60)}..."</div>
                            </div>
                            <div class="judgment-history-grade ${j.grade}">${j.grade}</div>
                        </div>
                    `;
                });
            } else {
                html += `<div style="text-align: center; color: #555; font-size: 13px; font-style: italic; margin-top: 10px;">
                    Il Sistema non ha ancora registrato alcun giudizio.<br>Torna luned√¨.
                </div>`;
            }

            container.innerHTML = html;
        }

        // ============================================================
        // ARCHIVIO DEL SISTEMA - 10 CAPITOLI
        // ============================================================
        function checkArchiveUnlock(trigger) {
            if (!gameState.archivioUnlocked) gameState.archivioUnlocked = ['cap_0'];
            
            const triggerMap = {
                'level_5': () => gameState.player.level >= 5,
                'level_10': () => gameState.player.level >= 10,
                'level_25': () => gameState.player.level >= 25,
                'level_50': () => gameState.player.level >= 50,
                'first_death': () => true, // called explicitly
                'first_shadow': () => true, // called explicitly
                'dungeon': () => true, // called explicitly
                's_rank': () => true, // called explicitly
                'meta_unlock': () => gameState.player.level >= 10 && gameState.shadowArmy.length >= 1 && gameState.weeklyJudgment.history.length >= 1
            };

            archiveChapters.forEach(ch => {
                if (gameState.archivioUnlocked.includes(ch.id)) return;
                const check = triggerMap[ch.conditionKey];
                if (check && check()) {
                    gameState.archivioUnlocked.push(ch.id);
                    showNotification(`üìö Archivio: "${ch.title}" sbloccato!`);
                }
            });

            // Always check meta_unlock and level-based ones
            ['level_5', 'level_10', 'level_25', 'level_50', 'meta_unlock'].forEach(key => {
                const check = triggerMap[key];
                archiveChapters.filter(c => c.conditionKey === key).forEach(ch => {
                    if (!gameState.archivioUnlocked.includes(ch.id) && check && check()) {
                        gameState.archivioUnlocked.push(ch.id);
                        showNotification(`üìö Archivio: "${ch.title}" sbloccato!`);
                    }
                });
            });

            saveGame();
        }

        function renderArchive() {
            const container = document.getElementById('archiveSection');
            if (!container) return;

            if (!gameState.archivioUnlocked) gameState.archivioUnlocked = ['cap_0'];

            // Check level-based unlocks passively
            checkArchiveUnlock('passive');

            let html = '';
            archiveChapters.forEach(ch => {
                const isUnlocked = gameState.archivioUnlocked.includes(ch.id);
                html += `
                    <div class="archive-chapter ${isUnlocked ? '' : 'locked'}" onclick="${isUnlocked ? `toggleArchiveChapter('${ch.id}')` : ''}">
                        <div class="archive-chapter-header">
                            <div class="archive-chapter-title">${isUnlocked ? 'üìñ' : 'üîí'} ${ch.title}</div>
                        </div>
                        ${isUnlocked 
                            ? `<div class="archive-chapter-preview">${ch.preview}</div>`
                            : `<div class="archive-unlock-condition">${ch.condition}</div>`
                        }
                        ${isUnlocked ? `<div class="archive-content" id="archive-${ch.id}">${ch.text.replace(/\n/g, '<br>')}</div>` : ''}
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function toggleArchiveChapter(id) {
            const el = event.currentTarget;
            el.classList.toggle('open');
        }

        // Check if today is Monday / new week to auto-save weekly judgment
        function checkWeeklyJudgmentReset() {
            const weekKey = getWeekKey();
            if (!gameState.weeklyJudgment) gameState.weeklyJudgment = { history: [], lastJudgmentWeek: null };
            if (gameState.weeklyJudgment.lastJudgmentWeek !== weekKey) {
                // New week ‚Äî save judgment if there's data
                if (Object.keys(gameState.completionCalendar || {}).length > 0) {
                    saveWeeklyJudgment();
                }
            }
        }

        function importSave(event) {
            
            if (!file) {
                return;
            }
            
            if (!confirm('‚ö†Ô∏è ATTENZIONE: Importare un salvataggio sovrascriver√† i tuoi progressi attuali!\n\nContinuare?')) {
                event.target.value = ''; // Reset file input
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    
                    // Validate JSON
                    const testParse = JSON.parse(content);
                    
                    // Check if it looks like a valid save
                    if (!testParse.player || !testParse.player.level) {
                        throw new Error('File non valido: non sembra un salvataggio di Real Life Leveling');
                    }
                    
                    // Create backup of current save before importing
                    const currentSave = localStorage.getItem('realLifeLevelingComplete');
                    if (currentSave) {
                        localStorage.setItem('realLifeLevelingBackup', currentSave);
                        console.log('Current save backed up before import');
                    }
                    
                    // Import the new save
                    localStorage.setItem('realLifeLevelingComplete', content);
                    
                    showNotification('‚úÖ Salvataggio importato! Ricaricamento...');
                    
                    // Reload page to load the new save
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                    
                } catch (error) {
                    console.error('Import error:', error);
                    alert('‚ùå Errore durante l\'importazione:\n\n' + error.message + '\n\nAssicurati di selezionare un file di salvataggio valido (.json).');
                }
            };
            
            reader.onerror = function() {
                alert('‚ùå Errore nella lettura del file.');
            };
            
            reader.readAsText(file);
            
            // Reset file input for next use
            event.target.value = '';
        }
    </script>
</body>
</html>